From davidkamphausen at mail.berlios.de  Wed Jul  2 19:22:37 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Wed, 2 Jul 2008 19:22:37 +0200
Subject: [Antargis-svn] r1270 - in antargis/trunk: data data/gui
	data/gui/images/basic data/gui/layout/editor/campaign ext/gui
	ext/video ruby/editor/campaign
Message-ID: <200807021722.m62HMbRq003207@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-02 19:22:33 +0200 (Wed, 02 Jul 2008)
New Revision: 1270

Added:
   antargis/trunk/data/gui/folder.png
   antargis/trunk/data/gui/images/basic/checkmark.png
   antargis/trunk/data/gui/images/basic/cross.png
   antargis/trunk/data/gui/layout/editor/campaign/load_dialog.xml
   antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml
   antargis/trunk/ruby/editor/campaign/dialogs.rb
   antargis/trunk/ruby/editor/campaign/toolbar.rb
Modified:
   antargis/trunk/data/gui/layout/editor/campaign/main.xml
   antargis/trunk/data/gui/layout/editor/campaign/story_editor.xml
   antargis/trunk/data/theme.xml
   antargis/trunk/ext/gui/ag_background.cc
   antargis/trunk/ext/gui/ag_button.cc
   antargis/trunk/ext/gui/ag_combo.cc
   antargis/trunk/ext/gui/ag_combo.h
   antargis/trunk/ext/gui/ag_edit.cc
   antargis/trunk/ext/gui/ag_image.cc
   antargis/trunk/ext/gui/ag_layout.cc
   antargis/trunk/ext/gui/ag_layoutcreators.cc
   antargis/trunk/ext/gui/ag_layoutfactory.cc
   antargis/trunk/ext/gui/ag_layoutfactory.h
   antargis/trunk/ext/gui/ag_table.cc
   antargis/trunk/ext/gui/ag_table.h
   antargis/trunk/ext/gui/ag_theme.cc
   antargis/trunk/ext/gui/ag_theme.h
   antargis/trunk/ext/gui/ag_widget.cc
   antargis/trunk/ext/video/ag_painter.cc
   antargis/trunk/ruby/editor/campaign/campaign_data.rb
   antargis/trunk/ruby/editor/campaign/drag_grid.rb
   antargis/trunk/ruby/editor/campaign/story_editor.rb
Log:
Incomplete - task 11: Campaign editor 
http://localhost:3000/issues/show/11

Added: antargis/trunk/data/gui/folder.png
===================================================================
(Binary files differ)


Property changes on: antargis/trunk/data/gui/folder.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: antargis/trunk/data/gui/images/basic/checkmark.png
===================================================================
(Binary files differ)


Property changes on: antargis/trunk/data/gui/images/basic/checkmark.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: antargis/trunk/data/gui/images/basic/cross.png
===================================================================
(Binary files differ)


Property changes on: antargis/trunk/data/gui/images/basic/cross.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: antargis/trunk/data/gui/layout/editor/campaign/load_dialog.xml
===================================================================

Modified: antargis/trunk/data/gui/layout/editor/campaign/main.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/main.xml	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/data/gui/layout/editor/campaign/main.xml	2008-07-02 17:22:33 UTC (rev 1270)
@@ -7,15 +7,20 @@
   
       <cell col="0" row="0">
         <toolBar name="toolbar">
-          <toolButton text="Save" name="save" caption="muh" caption-image="gui/save.png"/>
-          <toolButton text="Load" name="load" caption="muh" caption-image="gui/load.png"/>
+          <toolButton text="New" name="new" caption="muh" caption-image="gui/folder.png"/>
+          <toolButton text="Save" name="save" caption="muh" caption-image="gui/save.png" visible="true"/>
+          <toolButton text="Load" name="load" caption="muh" caption-image="gui/load.png" visible="true"/>
+          <!--<toolButton text="LoadOk" name="loadok" caption="muh" caption-image="gui/images/basic/haken.png" visible="true"/>-->
+          <toolEdit name="campaignName" text="noname" width="3" maxwidth="5"/>
+          <toolEdit name="campaignDescription" text="none" width="3" maxwidth="6" height="7"/>
+          <!--<toolCombo name="campaignFile"/>-->
         </toolBar>
       </cell>
   
       <cell col="0" row="1">
         <table cols="2" rows="2" name="bigTable">
           <colsize col="0" fixed="100"/>
-          <rowsize row="1" fixed="50"/>
+          <rowsize row="1" fixed="0"/>
     
           <cell col="0" row="0">
             <table cols="1" rows="4">
@@ -23,7 +28,7 @@
               <rowsize row="1" fixed="100"/>
               <rowsize row="2" fixed="100"/>
               <cell col="0" row="0">
-                <dragSource name="levelSource" class="DragBox" text="Level"/>
+                <dragSource name="levelSource" class="DragBoxLevel" text="Level"/>
               </cell>
         
               <cell col="0" row="1">
@@ -52,7 +57,7 @@
                 <edit name="textEdit"/>
               </cell>
               <cell col="1" row="0">
-                <button name="weiter" caption-image="data/gui/options.png"/>
+                <button name="edit" caption-image="data/gui/options.png"/>
               </cell>
             </table>
           </cell>
@@ -63,6 +68,6 @@
     <appearEffect name="showEdit" table="bigTable" row="1" size="40" duration="0.2"/>
     <hideEffect name="hideEdit" table="bigTable" row="1" size="40" duration="0.2"/>
   </dragEnvironment>
-  <storyEditor name="storyEditor"/>
+<!--  <storyEditor name="storyEditor" visible="false"/>-->
 
 </layout>
\ No newline at end of file

Added: antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml	2008-07-02 17:22:33 UTC (rev 1270)
@@ -0,0 +1,33 @@
+<?xml version="1.0"?>
+<layout>
+  <frame width="200">
+    <window theme="blue" title="Save">
+      <table cols="2" rows="3">
+        <rowsize row="0" fixed="40"/>
+        <rowsize row="2" fixed="60"/>
+        <colsize col="1" relative="2"/>
+        
+        <cell col="0" row="0" padding="10">
+          <text caption="Filename"/>
+        </cell>
+        <cell col="1" row="0" padding="10">
+          <edit name="filename"/>
+        </cell>
+        <cell col="0" row="1" padding="10">
+          <text caption="Existing"/>
+        </cell>
+        <cell col="1" row="1" padding="10">
+          <listBox name="listBox"/>
+        </cell>
+        <cell col="0" row="2" padding="10">
+          <button name="cancel" caption-image="data/gui/images/basic/cross.png"/>
+        </cell>
+        <cell col="1" row="2" padding="10">
+          <button name="ok" caption-image="data/gui/images/basic/checkmark.png"/>
+        </cell>
+        
+      </table>
+          
+    </window>
+  </frame>
+</layout>
\ No newline at end of file

Modified: antargis/trunk/data/gui/layout/editor/campaign/story_editor.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/story_editor.xml	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/data/gui/layout/editor/campaign/story_editor.xml	2008-07-02 17:22:33 UTC (rev 1270)
@@ -23,14 +23,24 @@
               </frame>
             </cell>
             <cell col="0" row="0">
-              <frame width="10" height="40">
-                <button name="prev" caption-image="data/gui/arrow_left.png"/>
-              </frame>
+              <table cols="1" rows="2">
+                <frame col="0" row="0" width="5">
+                  <button name="prev" caption-image="data/gui/arrow_left.png"/>
+                </frame>
+                <frame col="0" row="1" width="5">
+                  <button name="cancel" caption-image="data/gui/images/basic/cross.png"/>
+                </frame>
+              </table>
             </cell>
             <cell col="2" row="0">
-              <frame width="10" height="40">
-                <button name="next" caption-image="data/gui/arrow_right.png"/>
-              </frame>
+              <table cols="1" rows="2">
+                <frame col="0" row="0" width="5">
+                  <button name="next" caption-image="data/gui/arrow_right.png"/>
+                </frame>
+                <frame col="0" row="1" width="5">
+                  <button name="ok" caption-image="data/gui/images/basic/checkmark.png"/>
+                </frame>
+              </table>
             </cell>
             <cell col="1" row="1">
               <text name="info"/>

Modified: antargis/trunk/data/theme.xml
===================================================================
--- antargis/trunk/data/theme.xml	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/data/theme.xml	2008-07-02 17:22:33 UTC (rev 1270)
@@ -246,6 +246,30 @@
       </background>
     </window>
   </black>
+  <blue>
+    <window>
+      <border>
+        <image name="image" file="data/gui/buttontest3.png"/>
+      </border>
+      <title>
+        <font name="font" file="FreeSans.ttf" size="16" color='#FFFFFF'/>
+        <background>
+          <value name="border" value="0"/>
+          <color name='gradientColor1' color='#54555b'/>
+          <color name='gradientColor2' color='#3c3d41'/>
+          <color name='gradientColor3' color='#3c3d41'/>
+          <color name='gradientColor4' color='#12141c'/>
+        </background>
+      </title>
+      <buttons>
+        <image name="close" file="data/gui/close_button.png"/>
+      </buttons>
+      <background>
+        <value name="border" value="0"/>
+        <color name="color" color='#000088'/>
+      </background>
+    </window>
+  </bluek>
 	
 	
 	<yellowButton>

Modified: antargis/trunk/ext/gui/ag_background.cc
===================================================================
--- antargis/trunk/ext/gui/ag_background.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_background.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -60,10 +60,10 @@
 AGBackground::AGBackground(const AGString &pThemeName):mTexture(0)
   {
     AGTheme *theme=getTheme();
-loadFromTheme(theme->getTheme(""),pThemeName);
+    loadFromTheme(theme->getTheme(""),pThemeName);
   }
 
-AGBackground::AGBackground(const AGLocalTheme &pTheme,const AGString &pThemeName)
+AGBackground::AGBackground(const AGLocalTheme &pTheme,const AGString &pThemeName):mTexture(0)
   {
     loadFromTheme(pTheme,pThemeName);
   }
@@ -100,9 +100,15 @@
 /// draws the background on painter in the given rectangle
 void AGBackground::draw(const AGRect2 &r,AGPainter &p)
   {
+    assert(&p);
+    assert(&r);
     if(mTexture)
       {
-        p.tile(*mTexture,r.shrink(mBorder));
+        cdebug("painter:"<<&p);
+        cdebug(mTexture);
+        AGRect2 s=r.shrink(mBorder);
+        const AGTexture &t=*mTexture;
+        p.tile(t,s);//*mTexture,r.shrink(mBorder));
       }
     else if(mColor)
       p.drawGradient(r.shrink(mBorder),mColors[0],mColors[1],mColors[2],mColors[3]);

Modified: antargis/trunk/ext/gui/ag_button.cc
===================================================================
--- antargis/trunk/ext/gui/ag_button.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_button.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -63,6 +63,7 @@
 
     if(opengl())
       setCaching(true);
+      
   }
 
 void AGButton::setSurface(AGSurface pSurface,bool pChangeSize)
@@ -141,6 +142,7 @@
       p.drawBorder(mr,borderWidth,bc1,bc2);
     else 
       p.drawBorder(mr,borderWidth,bc2,bc1);
+      
   }
 
 
@@ -222,6 +224,7 @@
     return AGWidget::eventMouseButtonUp(e);
   }
 
+
 void AGButton::setRect(const AGRect2 &r)
   {
     AGWidget::setRect(r);
@@ -245,7 +248,7 @@
   {
     std::list<AGWidget*>::iterator i=mChildren.begin();
     for(;i!=mChildren.end();i++)
-      (*i)->setRect(getRect().shrink(borderWidth));
+      (*i)->setRect(getRect().origin().shrink(borderWidth));
   }
 
 

Modified: antargis/trunk/ext/gui/ag_combo.cc
===================================================================
--- antargis/trunk/ext/gui/ag_combo.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_combo.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -127,3 +127,31 @@
     mID="";
     update();
   }
+
+
+
+void AGComboBox::setRect(const AGRect2 &r)
+  {
+    AGWidget::setRect(r);
+    updateClientRects();
+  }
+
+void AGComboBox::setWidth(float w)
+  {
+    assert(w>=0);
+    AGWidget::setWidth(w);
+    updateClientRects();
+  }
+
+void AGComboBox::setHeight(float h)
+  {
+    assert(h>=0);
+    AGWidget::setHeight(h);
+    updateClientRects();
+  }
+
+void AGComboBox::updateClientRects()
+  {
+    mEdit->setRect(AGRect2(0,0,width()-height(),height()));
+    mButton->setRect(AGRect2(width()-height(),0,height(),height()));
+  }

Modified: antargis/trunk/ext/gui/ag_combo.h
===================================================================
--- antargis/trunk/ext/gui/ag_combo.h	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_combo.h	2008-07-02 17:22:33 UTC (rev 1270)
@@ -45,9 +45,14 @@
   void setSelected(const AGString &pID);
 
   void clear();
+  
+  virtual void setWidth(float w);
+  virtual void setHeight(float w);
+  void setRect(const AGRect2 &r);
 
  private:
   void update();
+  void updateClientRects();
 
   AGEdit *mEdit;
   AGButton *mButton;

Modified: antargis/trunk/ext/gui/ag_edit.cc
===================================================================
--- antargis/trunk/ext/gui/ag_edit.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_edit.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -538,6 +538,10 @@
       }
     else if(k==SDLK_ESCAPE)
       {}
+    else if(k==SDLK_DOWN)
+      {}
+    else if(k==SDLK_UP)
+      {}
     else if((unicode&0xFFF8)!=0 || (k>=SDLK_0 && k<=SDLK_9) || (k>=SDLK_a && k<=SDLK_z))
       {
         ins=AGStringUtf8(unicode2Utf8(unicode));

Modified: antargis/trunk/ext/gui/ag_image.cc
===================================================================
--- antargis/trunk/ext/gui/ag_image.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_image.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -24,34 +24,19 @@
 AGImage::AGImage(AGWidget *pParent,const AGRect2 &r,AGSurface pSurface,bool pTile):
   AGWidget(pParent,r),
   mTexture(pSurface),mTile(pTile),mScale(false)
-      {
-        mCenter=true;
-        //  CTRACE;
-        /*  if(pRect!=pSurface.getRect() && pRect.w()!=0 && pRect.h()!=0)
     {
-      //      mSrcRect=pRect;
+      mCenter=true;
+    }
 
-      setHeight(pRect.h());
-      setWidth(pRect.w());
-      }*/
-      }
 AGImage::AGImage(AGWidget *pParent,const AGRect2 &r,AGTexture pTexture,bool pTile):
   AGWidget(pParent,r),
   mTexture(pTexture),mTile(pTile)
-      {
-        mCenter=true;
-        //  CTRACE;
-        /*  if(pRect!=pTexture.getRect() && pRect.w()!=0 && pRect.h()!=0)
-    {
-      mSrcRect=pRect;
+  {
+    mCenter=true;
+  }
 
-      setHeight(pRect.h());
-      setWidth(pRect.w());
-      }*/
-      }
 
 
-
 AGImage::~AGImage()
   {
   }
@@ -64,7 +49,7 @@
 
     if(mTile)
       {
-        p.tile(mTexture,getRect().origin());//,mSrcRect);
+        p.tile(mTexture,getRect().origin());
       }
     else if(center)
       {
@@ -72,12 +57,6 @@
         AGRect2 mr=getRect().origin();
         AGRect2 fr=mTexture.getRect();
 
-        /*     if(mScale) // disables centering
-          {
-            fr=
-          }
-        else 
-         */         
         if(mCenter && !mScale)
           mr+=AGVector2((width()-mTexture.width())/2,(height()-mTexture.height())/2);
 

Modified: antargis/trunk/ext/gui/ag_layout.cc
===================================================================
--- antargis/trunk/ext/gui/ag_layout.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_layout.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -146,41 +146,43 @@
 
     AGRect2 geom=getLayoutGeometry(pParent,pNode);
 
-    AGWidget *w=0;
+    std::pair<AGWidget*,AGWidget*> result;
 
     //  cdebug("n:"<<n);
 
-    w=getLayoutFactory()->create(pParent,geom,pNode);
+    result=getLayoutFactory()->create(pParent,geom,pNode);
+    AGWidget *outer=result.first;
+    AGWidget *inner=result.second;
 
-    if(w!=0 && pNode.get("name").length())
-      w->setName(pNode.get("name"));
+    if(outer!=0 && pNode.get("name").length())
+      outer->setName(pNode.get("name"));
 
-    if(w!=0 && pNode.get("visible")=="false")
-      w->hide();
+    if(outer!=0 && pNode.get("visible")=="false")
+      outer->hide();
 
-    if(w!=0 && pNode.get("tooltip").length())
-      w->setTooltip(_(pNode.get("tooltip")));
+    if(outer!=0 && pNode.get("tooltip").length())
+      outer->setTooltip(_(pNode.get("tooltip")));
 
-    if(w!=0 && pNode.get("tabindex").length())
+    if(outer!=0 && pNode.get("tabindex").length())
       {
         AGLayout *l=getLayout(pParent);
         if(l)
           {
-            l->addTabIndex(pNode.get("tabindex").toInt(),w);
+            l->addTabIndex(pNode.get("tabindex").toInt(),outer);
           }
         else
           cdebug("ERROR in parseNode(.):tabindex given but not embedded in layout???");
       }
 
-    if(w!=0 && pNode.get("cache")=="true")
-      w->setCaching(true);
+    if(outer!=0 && pNode.get("cache")=="true")
+      outer->setCaching(true);
 
-    parseChildren(w,pNode);
+    parseChildren(inner,pNode);
 
-    if(w)
-      w->initHandlers();
+    if(outer)
+      outer->initHandlers();
 
-    return w;
+    return outer;
   }
 
 AGRect2 getLayoutGeometry(AGWidget *pParent,const Node &pNode)

Modified: antargis/trunk/ext/gui/ag_layoutcreators.cc
===================================================================
--- antargis/trunk/ext/gui/ag_layoutcreators.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_layoutcreators.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -112,19 +112,19 @@
 
       for(int k=0;k<w;k++)
         {
-          if(cols[k].first==0.0f) // not inited
+          if(cols[k].second)
+            t->addFixedColumn(cols[k].first);
+          else if(cols[k].first==0.0f) // not inited
             t->addColumn(1.0f);
-          else if(cols[k].second)
-            t->addFixedColumn(cols[k].first);
           else
             t->addColumn(cols[k].first);
         }
       for(int k=0;k<h;k++)
         {
-          if(rows[k].first==0.0f) // not inited
+          if(rows[k].second)
+            t->addFixedRow(rows[k].first);
+          else if(rows[k].first==0.0f) // not inited
             t->addRow(1.0f);
-          else if(rows[k].second)
-            t->addFixedRow(rows[k].first);
           else
             t->addRow(rows[k].first);
         }
@@ -397,7 +397,17 @@
 
   virtual void create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode)
     {
-      setResult(new AGCell(pParent,pRect));
+      AGCell *cell=new AGCell(pParent,pRect);
+      if(pNode.get("padding")!="")
+        {
+          int padx=pNode.get("padding").toInt();
+          int pady=pNode.get("padding").toInt();
+          AGFrame *frame=new AGFrame(cell,cell->getRect().origin(),padx,pady);
+          cell->addChild(frame);
+          setClient(frame);
+        }
+      
+      setResult(cell);
     }
 };
 IMPLEMENT_COMPONENT_FACTORY(Cell);

Modified: antargis/trunk/ext/gui/ag_layoutfactory.cc
===================================================================
--- antargis/trunk/ext/gui/ag_layoutfactory.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_layoutfactory.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -22,7 +22,7 @@
 #include "ag_debug.h"
 #include "ag_kill.h"
 
-AGLayoutCreator::AGLayoutCreator():mWidget(0)
+AGLayoutCreator::AGLayoutCreator():mWidget(0),mClient(0)
 {
 }
 
@@ -36,14 +36,27 @@
     if(mWidget)
       getLayoutFactory()->getCurrentLayout()->addChildRef(mWidget);
   }
+
+void AGLayoutCreator::setClient(AGWidget *pWidget)
+  {
+    mClient=pWidget;
+    if(pWidget)
+      getLayoutFactory()->getCurrentLayout()->addChildRef(pWidget);
+  }
+
 AGWidget *AGLayoutCreator::getResult()
   {
     return mWidget;
   }
+AGWidget *AGLayoutCreator::getClient()
+  {
+    return mClient;
+  }
 
 void AGLayoutCreator::clearResult()
   {
     mWidget=0;
+    mClient=0;
   }
 
 void AGLayoutCreator::mark()
@@ -76,25 +89,32 @@
   }
 
 
-AGWidget *AGLayoutFactory::create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode)
+/**
+ *  \returns a pair of 2 widgets. The first one is the outer widget, which shoudl be inserted. The second one is the widget,
+ * in which all children should be inserted.
+*/
+std::pair<AGWidget *,AGWidget*> AGLayoutFactory::create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode)
   {
     AGLayoutCreator *creator=mCreators[pNode.getName()];
 
     if(creator)
       {
-        AGWidget *w;
+        AGWidget *outer,*inner;
         creator->create(pParent,pRect,pNode);
-        w=creator->getResult();
+        outer=creator->getResult();
+        inner=creator->getClient();
         creator->clearResult();
+        if(inner==0)
+          inner=outer;
 
-        return w;
+        return std::make_pair(outer,inner);
       }
     std::string name;
     if(name!="" && name!="colsize" && name!="rowsize")
       {
         cdebug("no creation at:"<<name);
       }
-    return 0;
+    return std::make_pair((AGWidget*)0,(AGWidget*)0);
   }
 
 void AGLayoutFactory::pushLayout(AGLayout *pLayout)

Modified: antargis/trunk/ext/gui/ag_layoutfactory.h
===================================================================
--- antargis/trunk/ext/gui/ag_layoutfactory.h	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_layoutfactory.h	2008-07-02 17:22:33 UTC (rev 1270)
@@ -36,14 +36,16 @@
   //  virtual ~AGLayoutCreator();
   virtual void create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode);
   void setResult(AGWidget *pWidget);
+  void setClient(AGWidget *pWidget);
   AGWidget *getResult();
+  AGWidget *getClient();
 
   void clearResult();
 
   void mark();
  private:
    
-  AGWidget *mWidget;
+  AGWidget *mWidget,*mClient;
   
 
 };
@@ -59,7 +61,7 @@
   void addCreator(const AGString &pName,AGLayoutCreator *creator);
   void removeCreator(const AGString &pName,AGLayoutCreator *creator);
 
-  AGWidget *create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode);
+  std::pair<AGWidget*,AGWidget*> create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode);
   
   friend AGLayoutFactory *getLayoutFactory();
   

Modified: antargis/trunk/ext/gui/ag_table.cc
===================================================================
--- antargis/trunk/ext/gui/ag_table.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_table.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -332,7 +332,18 @@
   return cols.size();
 }
 
+float AGTable::getColumn(size_t c) const
+{
+  assert(c<cols.size());
+  return cols[c].first;
+}
+float AGTable::getRow(size_t c) const
+{
+  assert(c<rows.size());
+  return rows[c].first;
+}
 
+
 void AGTable::modifyColumn(size_t index,float w)
   {
     if(cols.size()>index)

Modified: antargis/trunk/ext/gui/ag_table.h
===================================================================
--- antargis/trunk/ext/gui/ag_table.h	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_table.h	2008-07-02 17:22:33 UTC (rev 1270)
@@ -49,6 +49,9 @@
   
   void modifyColumn(size_t index,float w);
   void modifyRow(size_t index,float w);
+  
+  float getColumn(size_t c) const;
+  float getRow(size_t c) const;
 
   void addChild(int x,int y,AGWidget *pWidget);
   AGRect2 getClientRect(int x,int y) const;

Modified: antargis/trunk/ext/gui/ag_theme.cc
===================================================================
--- antargis/trunk/ext/gui/ag_theme.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_theme.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -192,14 +192,14 @@
 
 AGFont AGLocalTheme::getFont(const AGString &pName) const
   {
-    AGString t=mTheme+"."+pName;
+    AGString t=getName(pName);
     if(getTheme()->hasFont(t))
       return getTheme()->getFont(t);
     return getTheme()->getFont(pName);
   }
 AGColor AGLocalTheme::getColor(const AGString &pName) const
   {
-    AGString t=mTheme+"."+pName;
+    AGString t=getName(pName);
     if(getTheme()->hasColor(t))
       return getTheme()->getColor(t);
     return getTheme()->getColor(pName);
@@ -207,7 +207,7 @@
 
 int AGLocalTheme::getInt(const AGString &pName) const
   {
-    AGString t=mTheme+"."+pName;
+    AGString t=getName(pName);
     if(getTheme()->hasInt(t))
       return getTheme()->getInt(t);
     return getTheme()->getInt(pName);
@@ -215,7 +215,7 @@
 
 AGSurface AGLocalTheme::getSurface(const AGString &pName) const
 {
-  AGString t=mTheme+"."+pName;
+  AGString t=getName(pName);
   if(getTheme()->hasSurface(t))
     return getTheme()->getSurface(t);
   return getTheme()->getSurface(pName);
@@ -223,7 +223,7 @@
 
 std::string AGLocalTheme::getSurfaceName(const AGString &pName) const
 {
-  AGString t=mTheme+"."+pName;
+  AGString t=getName(pName);
   if(getTheme()->hasSurfaceName(t))
     return getTheme()->getSurfaceName(t);
   return getTheme()->getSurfaceName(pName);
@@ -231,25 +231,32 @@
 
 bool AGLocalTheme::hasFont(const AGString &pName) const
 {
-  return getTheme()->hasFont(mTheme+"."+pName);
+  return getTheme()->hasFont(getName(pName));
 }
 bool AGLocalTheme::hasColor(const AGString &pName) const
 {
-  return getTheme()->hasColor(mTheme+"."+pName);  
+  return getTheme()->hasColor(getName(pName));  
 }
 bool AGLocalTheme::hasInt(const AGString &pName) const
 {
-  return getTheme()->hasInt(mTheme+"."+pName);
+  return getTheme()->hasInt(getName(pName));
 }
 bool AGLocalTheme::hasSurface(const AGString &pName) const
 {
-  return getTheme()->hasSurface(mTheme+"."+pName);
+  return getTheme()->hasSurface(getName(pName));
 }
 bool AGLocalTheme::hasSurfaceName(const AGString &pName) const
 {
-  return getTheme()->hasSurfaceName(mTheme+"."+pName);
+  return getTheme()->hasSurfaceName(getName(pName));
 }
 
+AGString AGLocalTheme::getName(const AGString &pName) const
+{
+  if(mTheme.length()>0)
+    return mTheme+"."+pName;
+  else
+    return pName;
+}
 
 
 

Modified: antargis/trunk/ext/gui/ag_theme.h
===================================================================
--- antargis/trunk/ext/gui/ag_theme.h	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_theme.h	2008-07-02 17:22:33 UTC (rev 1270)
@@ -47,6 +47,9 @@
     bool hasSurfaceName(const AGString &pName) const;
     
   private:
+    
+    AGString getName(const AGString &pName) const;
+    
     AGString mTheme;
   };
 

Modified: antargis/trunk/ext/gui/ag_widget.cc
===================================================================
--- antargis/trunk/ext/gui/ag_widget.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/gui/ag_widget.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -192,15 +192,7 @@
   }
 
 void AGWidget::drawChild(AGPainter &p,AGWidget *pWidget)
-  {/*
-    if(mUseClientRect)
-      {
-        p.pushMatrix();
-        p.transform(mClientProj.getMatrix());
-        pWidget->drawAll(p);
-        p.popMatrix();
-      }
-    else*/
+  {
     pWidget->drawAll(p);
   }
 
@@ -385,23 +377,21 @@
 
     if(e->isSDLEvent())
       {
-        //        cdebug(e->getRelMousePosition()<<"::"<<getRect());
         if(getRect().contains(e->getRelMousePosition()))
           {
             if(was)
               {
-                //                cdebug("click");
                 e->setName("sigClick");
                 AGApplication *app=getApp();
                 assert(app);
                 if(app)
                   {
                     AGWidget *overlay=getApp()->getOverlay();
-                    //if(overlay)
+
                     if(!isParent(overlay))
                       app->setOverlay(0);
                   }
-                if(!isParent(getApp()->getOverlay())) //FIXME: crashes here
+                if(!isParent(getApp()->getOverlay()))
                   getApp()->setOverlay(0);
 
                 if(canFocus())
@@ -510,11 +500,17 @@
 
 void AGWidget::setRect(const AGRect2 &pRect)
   {
+    //queryRedraw();
+
+    if(mCache)
+      setCaching(true);
+    
     regChange();
     mRect=pRect;
     regChange();
     if(mParent)
       mParent->redraw();
+    
   }
 
 float AGWidget::minWidth() const
@@ -563,6 +559,8 @@
 
 void AGWidget::setWidth(float w)
   {
+    if(mCache)
+      setCaching(true);
     regChange();
     mRect.setWidth(w);
     regChange();
@@ -570,6 +568,8 @@
   }
 void AGWidget::setHeight(float h)
   {
+    if(mCache)
+      setCaching(true);
     regChange();
     mRect.setHeight(h);
     regChange();
@@ -728,10 +728,14 @@
 
 bool AGWidget::eventLostFocus()
   {
+    CTRACE;
     if(mFocus)
       mFocus->eventLostFocus();
     mHasFocus=false;
     mFocus=0;
+    
+    if(mChildren.size()>0)
+      (*mChildren.begin())->eventLostFocus();
 
     return false;
   }
@@ -743,14 +747,12 @@
       mParent->gainCompleteFocus(this);
     if(pWidget)
       {
-        //      dbout(5000,mChildren.size());
         std::list<AGWidget*>::iterator i=std::find(mChildren.begin(),mChildren.end(),pWidget);
         if(i!=mChildren.end())
           {
             mChildren.erase(i);
             mChildren.push_front(pWidget);
           }
-        //      dbout(5000,mChildren.size());
       }
 #endif
   }
@@ -760,7 +762,6 @@
 #ifdef FOCUS_BY_SORT
     if(pWidget)
       {
-        //      dbout(5000,mChildren.size());
         std::list<AGWidget*>::iterator i=std::find(mChildren.begin(),mChildren.end(),pWidget);
         if(i!=mChildren.end())
           {
@@ -773,7 +774,6 @@
             pWidget->eventGotFocus();
 
           }
-        //      dbout(5000,mChildren.size());
       }
     else if(mParent)
       {
@@ -1055,6 +1055,8 @@
       {
         mCache=new AGTexture((int)width(),(int)height());
 
+        cdebug(width()<<"::"<<height());
+        
         mCacheTouched=true;
       }
   }

Modified: antargis/trunk/ext/video/ag_painter.cc
===================================================================
--- antargis/trunk/ext/video/ag_painter.cc	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ext/video/ag_painter.cc	2008-07-02 17:22:33 UTC (rev 1270)
@@ -39,30 +39,30 @@
 
 
 AGPaintProjection::AGPaintProjection(const AGRect2 &pClip):clip(pClip)
-  {
-    a.set(0,0,1);
-    a.set(0,1,0);
-    a.set(0,2,0);
-    a.set(1,0,0);
-    a.set(1,1,1);
-    a.set(1,2,0);
-    a.set(2,0,0);
-    a.set(2,1,0);
-    a.set(2,2,0);
-  }
+    {
+      a.set(0,0,1);
+      a.set(0,1,0);
+      a.set(0,2,0);
+      a.set(1,0,0);
+      a.set(1,1,1);
+      a.set(1,2,0);
+      a.set(2,0,0);
+      a.set(2,1,0);
+      a.set(2,2,0);
+    }
 
 AGPaintProjection::AGPaintProjection(const AGClipping &pClip):advancedClipping(pClip)
-  {
-    a.set(0,0,1);
-    a.set(0,1,0);
-    a.set(0,2,0);
-    a.set(1,0,0);
-    a.set(1,1,1);
-    a.set(1,2,0);
-    a.set(2,0,0);
-    a.set(2,1,0);
-    a.set(2,2,0);
-  }
+    {
+      a.set(0,0,1);
+      a.set(0,1,0);
+      a.set(0,2,0);
+      a.set(1,0,0);
+      a.set(1,1,1);
+      a.set(1,2,0);
+      a.set(2,0,0);
+      a.set(2,1,0);
+      a.set(2,2,0);
+    }
 
 
 AGVector2 AGPaintProjection::project(const AGVector2 &p) const
@@ -218,23 +218,27 @@
 /////////////////////////////////////////////////////////////////////////////////
 
 AGPainter::AGPainter():mCurrent(getScreen().getRect()),mTarget(&getScreen())
-  {
-    mTarget->beginPaint();
-  }
+    {
+      CTRACE;
+      mTarget->beginPaint();
+    }
 
 AGPainter::AGPainter(const AGPainter &p):ps(p.ps),mCurrent(p.mCurrent),mTarget(p.mTarget)
-  {
-    mTarget->beginPaint();
-  }
+    {
+      CTRACE;
+      mTarget->beginPaint();
+    }
 
 AGPainter::AGPainter(AGPaintTarget &pTarget):mCurrent(pTarget.getRect()),mTarget(&pTarget)
-  {
-    mTarget->beginPaint();
-  }
+    {
+      CTRACE;
+      mTarget->beginPaint();
+    }
 
 
 AGPainter::~AGPainter()
   {
+    CTRACE;
     if(mTarget.valid())
       {
         mTarget->unclip();
@@ -320,7 +324,9 @@
   }
 void AGPainter::tile(const AGTexture &pSource,const AGRect2 &pDest)
   {
-    tile(pSource,pDest,pSource.getRect());
+    AGRect2 sourceRect=pSource.getRect();
+
+    tile(pSource,pDest,sourceRect);
   }
 void AGPainter::tile(const AGTexture &pSource,const AGRect2 &pDest,const AGRect2 &pSrc)
   {

Modified: antargis/trunk/ruby/editor/campaign/campaign_data.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/campaign_data.rb	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ruby/editor/campaign/campaign_data.rb	2008-07-02 17:22:33 UTC (rev 1270)
@@ -1,6 +1,120 @@
-module CampaignEditor
-  class Data
-    def initialize
-    end
+class Story
+  
+end
+
+StoryScreen=Struct.new(:imageFilename,:text)
+
+class Story
+  attr_reader :screens
+  attr_accessor :x, :y
+  def initialize
+    @screens=[]
   end
-end
\ No newline at end of file
+end
+
+Level=Struct.new(:filename,:x,:y)
+Edge=Struct.new(:from,:to,:name)
+
+class Campaign
+  def self.getAllFilenames
+    dir="data/campaigns"
+    getDirectory(dir).uniq.select{|f|f=~/\.xml/}    
+  end
+  
+  def self.getAll
+    getAllFilenames.map{|file|self.new(dir+"/"+file)}
+  end
+  
+  def initialize(filename)
+    c=loadFile(filename)
+    d=Document.new(filename)
+    hasEdges=(d.root.getChildren("edges").length>0)
+    @nodes={}
+    @edges=[]
+    @startNode=nil
+    @vars={}
+    
+    varNames.each{|n|@vars[n]=d.root.get(n)}
+    
+    d.root.getChildren.each{|child|
+      #pp child.getName
+      node=nil
+      case child.getName
+        when "cutscene"
+          story=Story.new
+          child.getChildren("screen").each{|screenNode|
+            imageNode=screenNode.getChildren("image")[0]
+            textNode=screenNode.getChildren("text")[0]
+            image=nil
+            text=""
+            image=imageNode.get("filename") if imageNode
+            text=textNode.get("text") if textNode
+            story.screens << StoryScreen.new(image,text)
+          }
+          node=story
+        when "level"
+          node=Level.new(child.get("file"))    
+      end
+      if node
+        if child.get("x").to_i.to_s==child.get("x") and child.get("y").to_i.to_s==child.get("y") 
+          node.x=child.get("x").to_i
+          node.y=child.get("y").to_i
+        else
+          node.x=@nodes.length
+          node.y=0
+        end
+      #raise "FIXME: read position"
+      
+	      nodename=child.get("name")
+	      
+	      nodename="node#{@nodes.length}" if nodename==""
+	      @nodes[nodename]=node
+        unless hasEdges
+          @edges<<Edge.new("node#{@nodes.length-2}",nodename,"") if @nodes.length>1
+        end
+      end
+    }
+    puts dump
+  end
+  
+  
+  def dump
+    doc=Document.new
+    root=doc.root
+    root.setName("campaign")
+    varNames.each{|n|root.set(n, at vars[n])}
+    @nodes.each{|name,node|
+      l=nil
+      case node
+        when Story
+          l=root.addChild("cutscene")
+          l.set("name",name)
+          node.screens.each{|screen|
+            screenNode=l.addChild("screen")
+            if screen.text
+              screenNode.addChild("text").set("text",screen.text)
+            end
+            if screen.imageFilename
+              screenNode.addChild("image").set("filename",screen.text)
+            end
+          }
+        when Level
+          l=root.addChild("level")
+          l.set("name",name)
+          l.set("file",node.filename)
+      end
+      l.set("x",node.x.to_s)
+      l.set("y",node.y.to_s)
+    }
+    @edges.each{|edge|
+      l=root.addChild("edge")
+      l.set("from",edge.from)
+      l.set("to",edge.to)
+      l.set("name",edge.name)
+    }
+    doc.toString
+  end
+  def varNames
+    ["image","name","order","description"]
+  end
+end

Added: antargis/trunk/ruby/editor/campaign/dialogs.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/dialogs.rb	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ruby/editor/campaign/dialogs.rb	2008-07-02 17:22:33 UTC (rev 1270)
@@ -0,0 +1,50 @@
+
+module CampaignEditor
+  class Dialog<AGLayout
+    #include AGHandler
+    def initialize(p)
+      super
+    end
+    def loadXML(f)
+      super
+      addHandler(getChild("cancel"),:sigClick,:eventCancel)
+      addHandler(getChild("ok"),:sigClick,:eventOk)
+    end
+    def eventCancel
+      close
+    end
+    def eventOk
+      close
+    end
+  end
+  
+  class SaveDialog<Dialog
+    def initialize(p)
+      super
+      p.addChild(self)
+      loadXML(loadFile("data/gui/layout/editor/campaign/save_dialog.xml"))
+      getChild("ok").setEnabled(false)
+      addHandler(getChild("filename"),:sigModified,:eventFilenameChanged)
+      
+      listbox=getChild("listBox")
+      Campaign.getAllFilenames.each{|f|
+        listbox.insertItem(f,AGStringUtf8.new(f))
+      }
+      
+      addHandler(listbox,:sigSelect,:eventSelected)
+    end
+    def eventOk
+      super
+    end
+    def eventFilenameChanged
+      getChild("ok").setEnabled(getChild("filename").getText.to_s.length>0)
+    end
+    def eventSelected
+      getChild("filename").setText(AGStringUtf8.new(getChild("listBox").getSelectedValue))
+      eventFilenameChanged
+    end
+	end
+	
+	class LoadDialog<Dialog
+	end
+end
\ No newline at end of file

Modified: antargis/trunk/ruby/editor/campaign/drag_grid.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/drag_grid.rb	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ruby/editor/campaign/drag_grid.rb	2008-07-02 17:22:33 UTC (rev 1270)
@@ -1,6 +1,11 @@
 require 'ruby/antargislib.rb'
 require 'pp'
 
+require File.join(File.split(__FILE__)[0],"dialogs.rb")
+require File.join(File.split(__FILE__)[0],"toolbar.rb")
+
+#setDebugLevel(0)
+
 # TODO:
 # * put all draggable-objects within context of DragEnvironemt
 
@@ -28,11 +33,11 @@
       ]
   end
   def getArrowTriangles(from,to,width)
-    puts "gettin tris"
+    #puts "gettin tris"
     ps=createArrowPolies(from,to,width)
     ts=[ps[0][0..2],ps[0][1..3],ps[1]]
     r=ts.map{|t|AGTriangle2.new(t[0],t[1],t[2])}
-    puts "gettin tris!"
+    #puts "gettin tris!"
     r
   end
 end
@@ -171,13 +176,17 @@
     @name=node["name"]
     @target=node["table"]
     @row=node["row"].to_i
-    @size=50
+    #@size=50
+    @size=nil
     
   end
   def step(amount)
-    table=getApp.getMainWidget.getChild(@target)
+    @size||=table.getRow(@row)
     table.modifyRow(@row,(1-amount)*@size)
   end
+  def table
+    getApp.getMainWidget.getChild(@target)
+  end
 end
 
 class AGHoverWidget<AGWidget
@@ -375,6 +384,9 @@
   end
 end
 
+class DragBoxLevel<DragBox
+end
+
 class DragBoxStory<DragBox
   def initialize(p,r,text)
     super
@@ -493,70 +505,8 @@
 end
 
 
-class AGWidgetWithConfig<AGWidget
-  def initialize(p,r,ops)
-    @options=ops
-    super(p,r)
-  end
-  def getColor(name,default)
-    v=@options[name]
-    c=AGColor.new(v) if v=~/#[0-9A-Fa-f]{6}/
-    c||=AGColor.new(default)
-    c
-  end
-end
 
-class ToolBar<AGWidgetWithConfig
-  attr_reader :borderWidth
-  def initialize(p,r,ops)
-    super
-    @ul=getColor("ul","#CCCCCC")
-    @ur=getColor("ur","#CCCCCC")
-    @ll=getColor("ll","#999999")
-    @lr=getColor("lr","#999999")
-    @borderWidth=ops["borderWidth"].to_i
-    @count=0
-  end
-  def draw(p)
-    p.drawGradient(getRect.origin, at ul, at ur, at ll, at lr)
-  end
-  def getNextChildRect
-    cCount=getChildren.length
-    #cCount=@count
-    #@count+=1
-    #p getChildRects,cCount
-    #exit
-    getChildRects[cCount].shrink(3)
-  end
-  
-  def getChildRects
-    rectSize=[width,height].min
-    rects=[]
-    0.upto(width/rectSize-1){|x|
-      0.upto(height/rectSize-1){|y|
-        rects<<AGRect.new(x*rectSize,y*rectSize,rectSize,rectSize)
-      }
-    }
-    rects
-  end
-end
 
-class ToolButton<AGButton
-  def initialize(p,r,ops)
-    puts "MUH1"
-    puts self.object_id
-    text=AGStringUtf8.new("HUP")
-    super(p,r,text)
-    setCaching(false)
-    puts "MUH2"
-    setRect(p.getNextChildRect)
-    setCaption(text)
-    setSurface(AGSurface::load(ops["caption-image"])) if ops["caption-image"]
-    setName(ops["name"])
-  end
-end
-
-
 class DragGrid<AGWidgetWithConfig
   attr_reader :cells, :cellWidth, :selected
   
@@ -684,7 +634,7 @@
 end
 
 
-[DragGrid,DragSource,DragTrash,DragEnvironment,ToolBar,ToolButton,AppearEffect,HideEffect].each{|c|standardLayoutCreator(c)}
+[DragGrid,DragSource,DragTrash,DragEnvironment,ToolBar,ToolButton,ToolEdit,ToolCombo,AppearEffect,HideEffect].each{|c|standardLayoutCreator(c)}
 
 require File.join(File.split(__FILE__)[0],'story_editor.rb')
 
@@ -714,6 +664,9 @@
   }
 end
 
+require File.join(File.split(__FILE__)[0],"campaign_data.rb")
+
+
 class CampaignEditorApp<AGApplication
   def initialize()
     super
@@ -725,11 +678,14 @@
     setMainWidget(layout)
     layout.setApp(self)
     if layout.getChild("bigTable")
-      layout.getChild("bigTable").modifyRow(1,10)
       env=layout.getChild("dragEnvironment")
       @grid=layout.getChild("dragGrid")
       addHandler(env,:sigClick,:eventDeselect)
     end
+    
+    addHandler(layout.getChild("edit"),:sigClick,:eventEdit)
+    
+    initSavingLoading
   end
   def eventDeselect
     @grid.select(nil) if @grid
@@ -741,5 +697,39 @@
   def getEffect(name)
     @layout.getChild(name)
   end
+  def eventEdit
+    widget=nil
+    case @grid.selected
+      when DragBoxStory
+        widget=StoryEditor.new(@layout, at layout.getRect,{})
+      when DragBoxLevel
+        # FIXME
+    end
+    
+    @layout.addChild(widget) if widget
+    true
+  end
+  
+  def initSavingLoading
+    addHandler(@layout.getChild("load"),:sigClick,:eventLoad)    
+    addHandler(@layout.getChild("save"),:sigClick,:eventSave)    
+ #   pp Campaign.getAll
+ #   exit
+  end
+  
+  def eventLoad
+    
+    true
+  end
+  def eventSave
+    d=CampaignEditor::SaveDialog.new(@layout)
+    #d.loadXML(loadFile("data/gui/layout/editor/campaign/save_dialog.xml"))
+    #@layout.addChild(d)
+    #l=AGLayout.new(@layout)
+    #l.loadXML(loadFile())
+    #@layout.addChild(l)
+    true
+  end
+  
 end
 

Modified: antargis/trunk/ruby/editor/campaign/story_editor.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/story_editor.rb	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ruby/editor/campaign/story_editor.rb	2008-07-02 17:22:33 UTC (rev 1270)
@@ -1,7 +1,6 @@
 require File.join(File.split(__FILE__)[0],'image_list.rb')
 require File.join(File.split(__FILE__)[0],'image_list_2d.rb')
 
-StoryScreen=Struct.new(:imageFilename,:text)
 
 class StoryEditor<AGWidget
   def initialize(p,r,options)
@@ -17,6 +16,8 @@
     @next=getChild("next")
     @prev=getChild("prev")
     @edit=getChild("edit")
+    @ok=getChild("ok")
+    @cancel=getChild("cancel")
     
     @prev.setEnabled(false)
     @story=[makeNewScreen]
@@ -24,9 +25,21 @@
     addHandler(@next,:sigClick,:eventNext)
     addHandler(@prev,:sigClick,:eventPrev)
     addHandler(@edit,:sigModified,:eventText)
+    
+    addHandler(@cancel,:sigClick,:eventCancel)
+    addHandler(@ok,:sigClick,:eventOk)
     @cursor=0
   end
   
+  def eventCancel
+    close
+    true
+  end
+  def eventOk
+    close
+    true
+  end
+  
   def eventText(e)
     @story[@cursor].text=@edit.getText
     true

Added: antargis/trunk/ruby/editor/campaign/toolbar.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/toolbar.rb	2008-06-27 15:10:20 UTC (rev 1269)
+++ antargis/trunk/ruby/editor/campaign/toolbar.rb	2008-07-02 17:22:33 UTC (rev 1270)
@@ -0,0 +1,117 @@
+class AGWidgetWithConfig<AGWidget
+  def initialize(p,r,ops)
+    @options=ops
+    super(p,r)
+  end
+  def getColor(name,default)
+    v=@options[name]
+    c=AGColor.new(v) if v=~/#[0-9A-Fa-f]{6}/
+    c||=AGColor.new(default)
+    c
+  end
+end
+
+class ToolBar<AGWidgetWithConfig
+  attr_reader :borderWidth
+  def initialize(p,r,ops)
+    super
+    @ul=getColor("ul","#CCCCCC")
+    @ur=getColor("ur","#CCCCCC")
+    @ll=getColor("ll","#999999")
+    @lr=getColor("lr","#999999")
+    @borderWidth=ops["borderWidth"].to_i
+    @count=0
+    
+    @children=[]
+  end
+  def draw(p)
+    p.drawGradient(getRect.origin, at ul, at ur, at ll, at lr)
+  end
+  
+  def arrangeChildren
+    count=0
+    @children.each{|child|
+      many=1
+      many=child.boxWidth if child.respond_to?(:boxWidth)
+      pp count,many
+      r=getChildRect(count,many)
+      p r
+      child.setRect(r)
+      count+=many
+      child.queryRedraw
+    }
+  end
+  def addChild(c)
+    super
+    @children<<c
+    arrangeChildren
+  end
+  
+  private
+  def getChildRect(pos,many)
+    rects=getChildRects
+    r=rects[pos]
+    pos+=1
+    many-=1
+    while many>0
+      r=AGRect2.new(r.getV0,rects[pos].getV1)
+      pos+=1
+      many-=1
+    end
+    r.shrink(3)
+  end
+
+  def getChildRects
+    rectSize=[width,height].min
+    rects=[]
+    0.upto(width/rectSize-1){|x|
+      0.upto(height/rectSize-1){|y|
+        rects<<AGRect.new(x*rectSize,y*rectSize,rectSize,rectSize)
+      }
+    }
+    rects
+  end
+end
+
+class ToolButton<AGButton
+  def initialize(p,r,ops)
+    text=AGStringUtf8.new("HUP")
+    super(p,r,text)
+    setCaching(false)
+    setCaption(text)
+    setSurface(AGSurface::load(ops["caption-image"])) if ops["caption-image"]
+    setName(ops["name"])
+  end
+end
+
+class ToolEdit<AGEdit
+  attr_reader :boxWidth
+  def initialize(p,r,ops)
+    super(p,r)
+    setMulti(false)
+    setVAlign(EDIT_VCENTER)
+    setText(AGStringUtf8.new(ops["text"]))
+    setMutable(ops["mutable"]!="false")
+    
+    @boxWidth=3
+  end
+  def eventGotFocus
+    self.boxWidth=5
+  end
+  def eventLostFocus
+    self.boxWidth=3
+  end
+  def boxWidth=(w)
+    @boxWidth=w
+    getAncestor(ToolBar).arrangeChildren
+  end
+end
+
+class ToolCombo<AGComboBox
+  def initialize(p,r,ops)
+    super(p,r)
+  end
+  def boxWidth
+    3
+  end
+end



From davidkamphausen at mail.berlios.de  Mon Jul  7 21:04:28 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Mon, 7 Jul 2008 21:04:28 +0200
Subject: [Antargis-svn] r1271 - in antargis/trunk: data
	data/gui/layout/editor/campaign ext/basic ext/gui ext/video
	ruby ruby/editor/campaign
Message-ID: <200807071904.m67J4SfO013031@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-07 21:04:25 +0200 (Mon, 07 Jul 2008)
New Revision: 1271

Modified:
   antargis/trunk/data/gui/layout/editor/campaign/load_dialog.xml
   antargis/trunk/data/gui/layout/editor/campaign/main.xml
   antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml
   antargis/trunk/data/theme.xml
   antargis/trunk/ext/basic/ag_debug.cc
   antargis/trunk/ext/basic/ag_debug.h
   antargis/trunk/ext/gui/ag_background.h
   antargis/trunk/ext/gui/ag_image.cc
   antargis/trunk/ext/gui/ag_layoutcreators.cc
   antargis/trunk/ext/gui/ag_listbox.cc
   antargis/trunk/ext/gui/ag_listbox.h
   antargis/trunk/ext/gui/ag_scrollingwidget.cc
   antargis/trunk/ext/gui/ag_theme.cc
   antargis/trunk/ext/gui/ag_theme.h
   antargis/trunk/ext/gui/ag_widget.cc
   antargis/trunk/ext/gui/ag_widget.h
   antargis/trunk/ext/video/ag_gltexture.cc
   antargis/trunk/ruby/editor/campaign/campaign_data.rb
   antargis/trunk/ruby/editor/campaign/dialogs.rb
   antargis/trunk/ruby/editor/campaign/drag_grid.rb
   antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb
   antargis/trunk/ruby/spec_helper.rb
Log:
Incomplete - task 11: Campaign editor 
http://localhost:3000/issues/show/11
http://localhost:3000/issues/show/10

Modified: antargis/trunk/data/gui/layout/editor/campaign/load_dialog.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/load_dialog.xml	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/data/gui/layout/editor/campaign/load_dialog.xml	2008-07-07 19:04:25 UTC (rev 1271)
@@ -0,0 +1,25 @@
+<?xml version="1.0"?>
+<layout>
+  <frame width="200">
+    <window theme="blue" title="Load">
+      <table cols="2" rows="3">
+        <rowsize row="0" fixed="0"/>
+        <rowsize row="2" fixed="60"/>
+        <colsize col="1" relative="2"/>
+        
+        <cell col="0" row="1" padding="10">
+          <text caption="Existing"/>
+        </cell>
+        <cell col="1" row="1" padding="10">
+          <listBox name="listBox"/>
+        </cell>
+        <cell col="0" row="2" padding="10">
+          <button name="cancel" caption-image="data/gui/images/basic/cross.png"/>
+        </cell>
+        <cell col="1" row="2" padding="10">
+          <button name="ok" caption-image="data/gui/images/basic/checkmark.png"/>
+        </cell>
+      </table>
+    </window>
+  </frame>
+</layout>
\ No newline at end of file

Modified: antargis/trunk/data/gui/layout/editor/campaign/main.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/main.xml	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/data/gui/layout/editor/campaign/main.xml	2008-07-07 19:04:25 UTC (rev 1271)
@@ -13,6 +13,7 @@
           <!--<toolButton text="LoadOk" name="loadok" caption="muh" caption-image="gui/images/basic/haken.png" visible="true"/>-->
           <toolEdit name="campaignName" text="noname" width="3" maxwidth="5"/>
           <toolEdit name="campaignDescription" text="none" width="3" maxwidth="6" height="7"/>
+          <toolButton text="Quit" name="quit" caption-image="gui/door.png"/>
           <!--<toolCombo name="campaignFile"/>-->
         </toolBar>
       </cell>

Modified: antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/data/gui/layout/editor/campaign/save_dialog.xml	2008-07-07 19:04:25 UTC (rev 1271)
@@ -17,7 +17,7 @@
           <text caption="Existing"/>
         </cell>
         <cell col="1" row="1" padding="10">
-          <listBox name="listBox"/>
+          <listBox name="listBox" theme="blue"/>
         </cell>
         <cell col="0" row="2" padding="10">
           <button name="cancel" caption-image="data/gui/images/basic/cross.png"/>
@@ -25,9 +25,7 @@
         <cell col="1" row="2" padding="10">
           <button name="ok" caption-image="data/gui/images/basic/checkmark.png"/>
         </cell>
-        
       </table>
-          
     </window>
   </frame>
 </layout>
\ No newline at end of file

Modified: antargis/trunk/data/theme.xml
===================================================================
--- antargis/trunk/data/theme.xml	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/data/theme.xml	2008-07-07 19:04:25 UTC (rev 1271)
@@ -184,22 +184,10 @@
 	<edit>
 		<background>
       <color name="color" color='#11111144'/>
-<!-- 					<color name='gradientColor1' color='#54555b'/>
-					<color name='gradientColor2' color='#3c3d41'/>
-					<color name='gradientColor3' color='#3c3d41'/>
-					<color name='gradientColor4' color='#12141c'/> -->
-			<!--  <image name="image" file="data/gui/bg_tile2.png"/>-->
 		</background>
-    <!-- <font name="font" file="FreeSans.ttf" size="14" color="#000000"/> -->
     <font name="font" file="FreeSans.ttf" size="14" color="#E7E7FF"/>
 	</edit>
-<!--
-	<screen>
-		<background>
-			<image name="image" file="data/gui/bigbg_tile.png"/>
-		</background>
-	</screen>
-	-->
+
 	<window>
 		<border>
 			<image name="image" file="data/gui/buttontest3.png" file2="win_border.png"/>
@@ -269,7 +257,7 @@
         <color name="color" color='#000088'/>
       </background>
     </window>
-  </bluek>
+  </blue>
 	
 	
 	<yellowButton>
@@ -377,18 +365,9 @@
 			<color name='gradientColor2' color='#ee9900'/>
 			<color name='gradientColor3' color='#dd8800'/>
 			<color name='gradientColor4' color='#aa6600'/>
-<!--			<color name='gradientColor1' color='#f3ac0e'/>
-			<color name='gradientColor2' color='#ffd272'/>
-			<color name='gradientColor3' color='#f3ac0e'/>
-			<color name='gradientColor4' color='#c18c1a'/>-->
 		</selected>
 		<font name="font" file="FreeSans.ttf" size="22" color="#000000"/>
 	</listbox>
-	<!--<button>
-		<text>
-			<font name="font" file="FreeSans.ttf" size="16" color='#FFFFFF'/>
-		</text>
-	</button>-->
 
 	<menuButton>
 		<button>

Modified: antargis/trunk/ext/basic/ag_debug.cc
===================================================================
--- antargis/trunk/ext/basic/ag_debug.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/basic/ag_debug.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -32,35 +32,35 @@
 
 bool quietLog=false;
 void setQuiet()
-{
-  quietLog=true;
-}
+  {
+    quietLog=true;
+  }
 
 static bool gRubyRaising=false;
 void agRaise(const std::string &s)
-{
-  cdebug("assertion failed:"<<s);
-  if(gRubyRaising)
-    rb_raise(rb_eRuntimeError,s.c_str(),"");
-  else
-    throw std::runtime_error(s);
-}
+  {
+    cdebug("assertion failed:"<<s);
+    if(gRubyRaising)
+      rb_raise(rb_eRuntimeError,s.c_str(),"");
+    else
+      throw std::runtime_error(s);
+  }
 
 void setRubyRaising(bool flag)
-{
-  gRubyRaising=flag;
-}
+  {
+    gRubyRaising=flag;
+  }
 
 size_t gDebugLevel=0;
 
 size_t getDebugLevel()
-{
-  return gDebugLevel;
-}
+  {
+    return gDebugLevel;
+  }
 void setDebugLevel(size_t t)
-{
-  gDebugLevel=t;
-}
+  {
+    gDebugLevel=t;
+  }
 
 
 #ifndef MNDEBUG
@@ -69,43 +69,73 @@
 std::ofstream debugOFS("debug.txt");
 
 std::ostream &getDebug()
-{
-  if(quietLog)
-    return debugOFS;
-  else
-    return std::cout;
-}
+  {
+    if(quietLog)
+      return debugOFS;
+    else
+      return std::cout;
+  }
 
 size_t gDebugIndex=0;
 
 size_t getDebugIndex()
-{
-  return gDebugIndex;
-}
+  {
+    return gDebugIndex;
+  }
 
 
 
 D::D(std::string c):
   m(c)
-{
-  indent();
-  gDebugIndex++;
+  {
+    indent();
+    gDebugIndex++;
 
-  debugout_checked(2,"start of:"<<c<<"("<<gDebugIndex<<")"<<std::endl);
-  d++;
-}
+    debugout_checked(2,"start of:"<<c<<"("<<gDebugIndex<<")"<<std::endl);
+    d++;
+  }
 AGEXPORT D::~D()
-{
-  d--;
-  indent();
-  debugout_checked(2,"end   of:"<<m<<std::endl);
-}
+  {
+    d--;
+    indent();
+    debugout_checked(2,"end   of:"<<m<<std::endl);
+  }
 void D::indent()
-{
-  for(int i=0;i<d;i++)
-    debugout_checked(2,"  ");
-}
+  {
+    for(int i=0;i<d;i++)
+      debugout_checked(2,"  ");
+  }
 
 
 #endif
 
+#ifdef __APPLE__
+
+//#include <mach-o/nlist.h>
+
+#include "execinfo.h"
+void printStacktrace()
+  {
+    void* callstack[128];
+    int i, frames = backtrace(callstack, 128);
+    char** strs = backtrace_symbols(callstack, frames);
+    printf("FRAMES:%d\n",frames);
+    for (i = 0; i < frames; ++i) {
+      printf("%s\n", strs[i]);
+    }
+    free(strs);
+    /*
+    struct nlist *nl;
+    int result=nlist("antargis.bundle",nl);
+    std::cout<<"RESULT:"<<result<<std::endl;
+*/
+  }
+
+#else
+
+void printStacktrace()
+  {
+  }
+
+#endif
+

Modified: antargis/trunk/ext/basic/ag_debug.h
===================================================================
--- antargis/trunk/ext/basic/ag_debug.h	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/basic/ag_debug.h	2008-07-07 19:04:25 UTC (rev 1271)
@@ -115,6 +115,7 @@
 #endif
 
 void setRubyRaising(bool flag);
+void printStacktrace();
 
 
 #endif

Modified: antargis/trunk/ext/gui/ag_background.h
===================================================================
--- antargis/trunk/ext/gui/ag_background.h	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_background.h	2008-07-07 19:04:25 UTC (rev 1271)
@@ -27,9 +27,9 @@
 #include "ag_geometry.h"
 #include "ag_texture.h"
 #include "ag_color.h"
-#include "ag_theme.h"
 
 class AGPainter;
+class AGLocalTheme;
 
 /** AGBackground is a helper class for widget-drawing
     It is used to draw gradients and tiled backgrounds of widgets.

Modified: antargis/trunk/ext/gui/ag_image.cc
===================================================================
--- antargis/trunk/ext/gui/ag_image.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_image.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -30,7 +30,7 @@
 
 AGImage::AGImage(AGWidget *pParent,const AGRect2 &r,AGTexture pTexture,bool pTile):
   AGWidget(pParent,r),
-  mTexture(pTexture),mTile(pTile)
+  mTexture(pTexture),mTile(pTile),mScale(false)
   {
     mCenter=true;
   }

Modified: antargis/trunk/ext/gui/ag_layoutcreators.cc
===================================================================
--- antargis/trunk/ext/gui/ag_layoutcreators.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_layoutcreators.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -261,7 +261,10 @@
 
   virtual void create(AGWidget *pParent,const AGRect2 &pRect,const Node &pNode)
     {
-      setResult(new AGListBox(pParent,pRect));
+      AGListBox *l=new AGListBox(pParent,pRect);
+      if(pNode.get("theme").length()>0)
+        l->setTheme(pNode.get("theme"));
+      setResult(l);
     }
 };
 IMPLEMENT_COMPONENT_FACTORY(ListBox);
@@ -519,7 +522,6 @@
 
 
 
-// AGListBox creator
 class AGScrollingWidgetCreator:public AGLayoutCreator
 {
 public:

Modified: antargis/trunk/ext/gui/ag_listbox.cc
===================================================================
--- antargis/trunk/ext/gui/ag_listbox.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_listbox.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -34,11 +34,9 @@
   }
 
 AGListBox::AGListBox(AGWidget *pParent,const AGRect2 &pRect):AGWidget(pParent,pRect),
-sigSelect(this,"sigSelect"),
-sigDoubleClick(this,"sigDoubleClick")
+  sigSelect(this,"sigSelect"),
+  sigDoubleClick(this,"sigDoubleClick")
 {
-  mBackground=AGBackground("listbox.background");
-  mHilight=AGBackground("listbox.selected");
   // insert AGEdits
   int y=0;
   int count=0;
@@ -46,9 +44,6 @@
   if(mItemHeight<5)
     mItemHeight=25;
 
-  AGFont f=getTheme()->getFont("listbox.font");
-
-
   mScroller=new AGScroller(this,AGRect2(width()-mItemHeight,0,mItemHeight,height()),false);
   addChild(mScroller);
 
@@ -57,11 +52,10 @@
   for(;y<pRect.h();y+=mItemHeight,count++)
     {
       AGRect2 r(0,y,pRect.w()-mItemHeight,mItemHeight);
-      //      cdebug(r);
       AGEdit *e=new AGEdit(this,r);
       e->setMutable(false);
       e->setBackground(false);
-      e->setFont(f);
+      //e->setFont(f);
       AGStringStream os;
       os<<"ListBoxItem"<<count;
       e->setName(os.str());
@@ -72,8 +66,46 @@
   mHeight=count;
   mY=0;
   mSelected=-1;
+  
+  setTheme("");
 }
 
+void AGListBox::setTheme(const AGString &pTheme)
+  {
+    AGString themeName=pTheme;
+    if(themeName.length()==0)
+      themeName="listbox";
+    else
+      themeName+="listbox";
+    
+    AGLocalTheme theme=getTheme()->getTheme(themeName);
+    mBackground=AGBackground(theme,"background");
+    mHilight=AGBackground(theme,"selected");
+
+    AGFont f=theme.getFont("font");
+
+    // change fonts for edits
+    for(std::vector<AGEdit*>::iterator i=mEdits.begin();i!=mEdits.end();i++)
+      (*i)->setFont(f);
+
+    rearrange();
+    
+    
+  }
+
+void AGListBox::rearrange()
+  {
+    mItemHeight=getTheme()->getInt("listbox.item.height");
+    if(mItemHeight<5)
+      mItemHeight=25;
+
+    mScroller->setRect(AGRect2(width()-mItemHeight,0,mItemHeight,height()));
+
+    int count=0;
+    for(int y=0;y<height();y+=mItemHeight,count++)
+        mEdits[count]->setRect(AGRect2(0,y,width()-mItemHeight,mItemHeight));
+  }
+
 void AGListBox::insertItem(AGString pID,AGStringUtf8 pValue)
   {
     mItems.push_back(AGListBoxItem(pID,pValue));

Modified: antargis/trunk/ext/gui/ag_listbox.h
===================================================================
--- antargis/trunk/ext/gui/ag_listbox.h	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_listbox.h	2008-07-07 19:04:25 UTC (rev 1271)
@@ -70,9 +70,12 @@
   
   std::map<AGString,AGStringUtf8> getValues() const;
 
+  void setTheme(const AGString &pTheme);
+
  private:
 
-  void arrange();
+   void rearrange();
+   void arrange();
 
   int mY;
   std::vector<AGListBoxItem> mItems;

Modified: antargis/trunk/ext/gui/ag_scrollingwidget.cc
===================================================================
--- antargis/trunk/ext/gui/ag_scrollingwidget.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_scrollingwidget.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -24,28 +24,11 @@
 
 AGScrollingWidget::AGScrollingWidget(AGWidget *pParent, const AGRect2& pRect):
   AGWidget(pParent,pRect),
-  //mClient(pRect.origin()),
-  //mVector(0,0),
   mDragging(false)
     {
       AGRect2 r=getRect().origin();
       setClient(r,AGProjection2D(r,r));
     }
-/*
-bool AGScrollingWidget::letChildProcess(AGWidget *pChild,AGEvent *event)
-  {
-    bool retValue;
-    AGVector2 old=event->getMousePosition();
-    
-    event->setMousePosition(old+mVector);
-    
-    retValue=pChild->processEvent(event);
-    
-    event->setMousePosition(old);
-    
-    return retValue;
-  }
-*/
 
 void AGScrollingWidget::setClientRect(const AGRect2 &pRect)
   {

Modified: antargis/trunk/ext/gui/ag_theme.cc
===================================================================
--- antargis/trunk/ext/gui/ag_theme.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_theme.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -184,8 +184,45 @@
   return AGLocalTheme(pTheme);
 }
 
+AGGradient AGTheme::getGradient(const AGString &pName) const
+{
+  std::map<AGString,AGGradient>::const_iterator i=mGradients.find(pName);
+  if(i==mGradients.end())
+    {
+      i=mGradients.find(trunc(pName));
+      if(i==mGradients.end())
+        return AGGradient();
+    }
+  return i->second;
+}
+ 
+AGBackground AGTheme::getBackground(const AGString &pName) const
+{
+  std::map<AGString,AGBackground>::const_iterator i=mBackgrounds.find(pName);
+  if(i==mBackgrounds.end())
+    {
+      i=mBackgrounds.find(trunc(pName));
+      if(i==mBackgrounds.end())
+        return AGBackground();
+    }
+  return i->second;
+}
 
+AGBorder AGTheme::getBorder(const AGString &pName) const
+{
+  std::map<AGString,AGBorder>::const_iterator i=mBorders.find(pName);
+  if(i==mBorders.end())
+    {
+      i=mBorders.find(trunc(pName));
+      if(i==mBorders.end())
+        return AGBorder();
+    }
+  return i->second;
+}
 
+
+
+
 AGLocalTheme::AGLocalTheme(const AGString &pTheme):mTheme(pTheme)
       {
       }

Modified: antargis/trunk/ext/gui/ag_theme.h
===================================================================
--- antargis/trunk/ext/gui/ag_theme.h	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_theme.h	2008-07-07 19:04:25 UTC (rev 1271)
@@ -27,8 +27,13 @@
 #include "ag_font.h"
 #include "ag_surface.h"
 
+#include "ag_border.h"
+#include "ag_gradient.h"
+#include "ag_background.h"
+
 #include <map>
 
+
 class AGEXPORT AGLocalTheme
   {
   public:
@@ -81,6 +86,15 @@
 
   
   AGLocalTheme getTheme(const AGString &pTheme) const;
+  
+  
+  
+  // advanced functions
+  
+  AGGradient getGradient(const AGString &pName) const;
+  AGBackground getBackground(const AGString &pName) const;
+  AGBorder getBorder(const AGString &pName) const;
+  
 
  private:
 
@@ -91,6 +105,12 @@
   std::map<AGString,AGSurface> mSurfaces;
   std::map<AGString,std::string> mSurfaceNames;
   std::map<AGString,int> mInts;
+  
+  
+  std::map<AGString,AGGradient> mGradients;
+  std::map<AGString,AGBackground> mBackgrounds;
+  std::map<AGString,AGBorder> mBorders;
+  
 };
 
 AGEXPORT AGTheme *getTheme();

Modified: antargis/trunk/ext/gui/ag_widget.cc
===================================================================
--- antargis/trunk/ext/gui/ag_widget.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_widget.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -53,7 +53,9 @@
     return gNewClippingTechnique;
   }
 
+std::set<AGWidget*> AGWidget::allWidgets;
 
+
 AGWidget::AGWidget(AGWidget *pParent,const AGRect2 &r):
   sigMouseEnter(this,"sigMouseEnter"),
   sigMouseLeave(this,"sigMouseLeave"),
@@ -65,24 +67,28 @@
   mFixedWidth(false),mFixedHeight(false),mVisible(true),mCaching(false),
   mHasFocus(false),mFocus(0)
 
-    {
-      mEventsInited=false;
-      CTRACE;
-      if(mParent)
-        mParent->addChildRef(this);
+  {
+    allWidgets.insert(this);
 
-      mChangeRect=AGRect2(0,0,0,0);
-      mCache=0;
-      mCacheTouched=false;
-      mTooltipWidget=0;
-      mModal=false;
+    mEventsInited=false;
+    CTRACE;
+    if(mParent)
+      mParent->addChildRef(this);
 
-      getMain()->getCollector()->insertGlobal(this);
-    }
+    mChangeRect=AGRect2(0,0,0,0);
+    mCache=0;
+    mCacheTouched=false;
+    mTooltipWidget=0;
+    mModal=false;
 
+    getMain()->getCollector()->insertGlobal(this);
+  }
+
 AGWidget::~AGWidget()
   {
+    allWidgets.erase(this);
     CTRACE;
+    cdebug(getName());
 
     if(hasMain())
       getMain()->getCollector()->removeGlobal(this);
@@ -90,12 +96,41 @@
     std::list<AGWidget*>::iterator i=mChildren.begin();
     for(;i!=mChildren.end();i++)
       {
-        (*i)->setParent(0);
+        if(valid(*i))
+          {
+            cdebug("notify child:"<<*i);
+            (*i)->setParent(0);
+            cdebug("notify ok");
+          }
       }
+    for(std::set<AGWidget*>::iterator i=mRefChildren.begin();i!=mRefChildren.end();i++)
+      {
+        if(valid(*i))
+          {
+            cdebug("notify child:"<<*i);
+            (*i)->setParent(0);
+            cdebug("notify ok");
+          }
+      }
+
+    cdebug(mParent);
     if(getParent())
-      getParent()->eventChildrenDeleted(this);
+      {
+        if(valid(getParent()))
+          {
+            cdebug("notify parent:"<<getParent());
+            getParent()->eventChildrenDeleted(this);
+          }
+      }
   }
 
+bool AGWidget::valid(AGWidget *pWidget)
+  {
+    return (allWidgets.find(pWidget)!=allWidgets.end());
+
+  }
+
+
 std::list<AGWidget*> AGWidget::getChildren()
   {
     return mChildren;
@@ -121,7 +156,7 @@
         if(*i==pWidget)
           {
             mChildren.erase(i);
-            break;
+            //break; // do not break, beacuse a list could have this child more than once ???
           }
       }
     i=mToClear.begin();
@@ -130,9 +165,10 @@
         if(*i==pWidget)
           {
             mToClear.erase(i);
-            break;
+            // break; // same as above
           }
       }
+    mRefChildren.erase(pWidget);
   }
 
 
@@ -148,6 +184,7 @@
         std::list<AGWidget*>::iterator i=mToClear.begin();
         for(;i!=mToClear.end();i++)
           {
+            (*i)->setParent(0); // lets play it safe 
             saveDelete(*i);
           }
         mToClear.clear();
@@ -272,11 +309,11 @@
      */
     event->setRelMousePosition(newP);
     bool wasClipped=event->isClipped();
-    
+
     event->setClipped(wasClipped || (!getRect().contains(old)));
 
     retValue=pChild->processEvent(event);
-    
+
     event->setClipped(wasClipped);
     event->setRelMousePosition(old);
 
@@ -448,6 +485,8 @@
 
 void AGWidget::addChild(AGWidget *w)
   {
+    if(w->getParent())
+      w->getParent()->mRefChildren.erase(w);
     mRefChildren.erase(w);
 
     mChildren.push_front(w); // set on top
@@ -480,9 +519,31 @@
 
 void AGWidget::addChildBack(AGWidget *w)
   {
+    if(w->getParent())
+      w->getParent()->mRefChildren.erase(w);
+    mRefChildren.erase(w);
+
+    // check if children already exists
+    Children::iterator i;
+    do
+      {
+        i=std::find(mChildren.begin(),mChildren.end(),w);
+        if(i!=mChildren.end())
+          mChildren.erase(i);
+      }while(i!=mChildren.end());
+    
+    
     mChildren.push_back(w); // set on top
-  }
 
+    if(mHasFocus && w->canFocus())
+      {
+        gainFocus(w);
+      }
+    if(!w->getParent())
+      w->setParent(this);
+    queryRedraw();
+}
+
 void AGWidget::regChange()
   {
     AGRect2 t=getScreenRect().grow(5);
@@ -500,17 +561,15 @@
 
 void AGWidget::setRect(const AGRect2 &pRect)
   {
-    //queryRedraw();
+    if(mCache&&(width()!=pRect.width()||height()!=pRect.height()))
+      setCaching(true);
 
-    if(mCache)
-      setCaching(true);
-    
     regChange();
     mRect=pRect;
     regChange();
     if(mParent)
       mParent->redraw();
-    
+
   }
 
 float AGWidget::minWidth() const
@@ -559,7 +618,7 @@
 
 void AGWidget::setWidth(float w)
   {
-    if(mCache)
+    if(mCache && width()!=w)
       setCaching(true);
     regChange();
     mRect.setWidth(w);
@@ -568,7 +627,7 @@
   }
 void AGWidget::setHeight(float h)
   {
-    if(mCache)
+    if(mCache && height()!=h)
       setCaching(true);
     regChange();
     mRect.setHeight(h);
@@ -631,10 +690,17 @@
 
 void AGWidget::setParent(AGWidget *pParent)
   {
+    CTRACE;
     //mOldMousePos.setX(-20000); // set oldmousepos invalid -- see eventMouseMotion 
 
+
     if(!mParent)
       {
+        AGWidget *old=mParent;
+        mParent=pParent;
+        cdebug(old);
+        if(mParent==0 && old!=0)
+          old->eventChildrenDeleted(this);
         if(hasMain())
           getMain()->getCollector()->removeGlobal(this);
       }
@@ -658,11 +724,13 @@
  */
 AGRect2 AGWidget::getScreenRect() const
 {
-  //return toScreen(getRect());
+  CTRACE;
   AGRect2 r=getRect();
   if(mParent)
     {
-      return mParent->toScreen(getRect());
+      AGRect2 result=mParent->toScreen(getRect());
+      cdebug(getRect()<<"::"<<result);
+      return result;
     }
   return r;
 }
@@ -733,7 +801,7 @@
       mFocus->eventLostFocus();
     mHasFocus=false;
     mFocus=0;
-    
+
     if(mChildren.size()>0)
       (*mChildren.begin())->eventLostFocus();
 
@@ -1042,6 +1110,7 @@
  */
 void AGWidget::setCaching(bool pEnable)
   {
+
     if(getConfig()->get("widgetTextureCache")=="false")
       return;
     getConfig()->set("widgetTextureCache","true");
@@ -1055,8 +1124,6 @@
       {
         mCache=new AGTexture((int)width(),(int)height());
 
-        cdebug(width()<<"::"<<height());
-        
         mCacheTouched=true;
       }
   }
@@ -1156,6 +1223,7 @@
 
 void AGWidget::close()
   {
+    CTRACE;
     if(mParent)
       {
         mParent->removeChild(this);
@@ -1286,7 +1354,7 @@
   AGRect2 m=p;
 
   if(mUseClientRect)
-      m=mClientProj.inverse().project(m);
+    m=mClientProj.inverse().project(m);
   return m-getRect().getV0();
 }
 AGVector2 AGWidget::outerToInner(const AGVector2 &p) const
@@ -1309,5 +1377,5 @@
 
 void AGWidget::eventInitEvents()
   {
-    
+
   }

Modified: antargis/trunk/ext/gui/ag_widget.h
===================================================================
--- antargis/trunk/ext/gui/ag_widget.h	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/gui/ag_widget.h	2008-07-07 19:04:25 UTC (rev 1271)
@@ -97,7 +97,7 @@
   virtual AGRect2 getClientRect() const;
   virtual void setRect(const AGRect2 &pRect);
 
-  void setParent(AGWidget *pParent);
+  virtual void setParent(AGWidget *pParent);
   AGWidget *getParent();
   bool isParent(AGWidget *pParent);
 
@@ -281,6 +281,8 @@
   void gainFocusDown(AGWidget *pWidget);
 
   void checkFocus();
+  
+  static bool valid(AGWidget *pWidget);
 
   std::list<AGWidget*> mToClear;
 
@@ -318,11 +320,15 @@
   
 protected:
   std::list<AGWidget*> mChildren;
+  
+private:
+  static std::set<AGWidget*> allWidgets;
 
 };
 
 AGEXPORT void setNewClippingTechnique(bool f);
 AGEXPORT bool getNewClippingTechnique();
+AGEXPORT void printStacktrace();
 
 
 #endif

Modified: antargis/trunk/ext/video/ag_gltexture.cc
===================================================================
--- antargis/trunk/ext/video/ag_gltexture.cc	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ext/video/ag_gltexture.cc	2008-07-07 19:04:25 UTC (rev 1271)
@@ -100,43 +100,25 @@
 
         assert(buffer);
       }
-    cdebug("3");
     if(buffer)
       memset(buffer,0,bufSize);
-    /*
-    cdebug("5");
-    cdebug(mTarget);
-    cdebug(format);
-    cdebug("rect:"<<(mTarget==GL_TEXTURE_RECTANGLE_ARB));
-    cdebug("2d:"<<(mTarget==GL_TEXTURE_2D));
-    cdebug("3d:"<<(mTarget==GL_TEXTURE_3D));
-    cdebug("GL_RGBA:"<<(format==GL_RGBA));
-    cdebug("w:"<<w<<" h:"<<h);
-    cdebug("texmem:"<<gUsedTexMemory);
-    cdebug((void*)buffer);
-    */
     assertGL;
     glTexImage2D(mTarget, 0, format, w, h, 0, GL_RGBA,
         GL_UNSIGNED_BYTE, buffer);
     assertGL;
-    //cdebug("6");
 
     if(buffer)
       delete [] buffer;
 
-    //cdebug("7");
-    //cdebug("W:"<<w<<" h:"<<h);
     assertGL;
     gUsedTexMemory+=w*h*4;
 
-    cdebug("8");
     dbout(4,"used memory:"<<gUsedTexMemory);
 
     glTexParameteri(mTarget, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
     assertGL;
     glTexParameteri(mTarget, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
     assertGL;
-    cdebug("9");
   }
 AGGLTexture::AGGLTexture(size_t W,size_t H,size_t D,GLint format):w(W),h(H),d(D),m3d(true),mRectTex(false),mTarget(GL_TEXTURE_3D)
   {

Modified: antargis/trunk/ruby/editor/campaign/campaign_data.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/campaign_data.rb	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ruby/editor/campaign/campaign_data.rb	2008-07-07 19:04:25 UTC (rev 1271)
@@ -16,15 +16,28 @@
 Edge=Struct.new(:from,:to,:name)
 
 class Campaign
+  CampaignDir="data/campaigns"
+  
   def self.getAllFilenames
-    dir="data/campaigns"
-    getDirectory(dir).uniq.select{|f|f=~/\.xml/}    
+    getDirectory(CampaignDir).uniq.select{|f|f=~/\.xml/}    
   end
   
   def self.getAll
-    getAllFilenames.map{|file|self.new(dir+"/"+file)}
+    getAllFilenames.map{|file|self.new(CampaignDir+"/"+file)}
   end
   
+  def self.loadCampaign(filename)
+    filename+=".xml" unless filename=~/\.xml/
+    getAllFilenames.each{|f|
+      if f==filename
+        return self.new(CampaignDir+"/"+filename)
+      end
+    }
+    nil
+  end
+  
+  attr_reader :nodes, :edges
+  
   def initialize(filename)
     c=loadFile(filename)
     d=Document.new(filename)
@@ -37,7 +50,6 @@
     varNames.each{|n|@vars[n]=d.root.get(n)}
     
     d.root.getChildren.each{|child|
-      #pp child.getName
       node=nil
       case child.getName
         when "cutscene"
@@ -65,10 +77,10 @@
         end
       #raise "FIXME: read position"
       
-	      nodename=child.get("name")
-	      
-	      nodename="node#{@nodes.length}" if nodename==""
-	      @nodes[nodename]=node
+        nodename=child.get("name")
+        
+        nodename="node#{@nodes.length}" if nodename==""
+        @nodes[nodename]=node
         unless hasEdges
           @edges<<Edge.new("node#{@nodes.length-2}",nodename,"") if @nodes.length>1
         end

Modified: antargis/trunk/ruby/editor/campaign/dialogs.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/dialogs.rb	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ruby/editor/campaign/dialogs.rb	2008-07-07 19:04:25 UTC (rev 1271)
@@ -19,7 +19,7 @@
   end
   
   class SaveDialog<Dialog
-    def initialize(p)
+    def initialize(p,&block)
       super
       p.addChild(self)
       loadXML(loadFile("data/gui/layout/editor/campaign/save_dialog.xml"))
@@ -32,9 +32,11 @@
       }
       
       addHandler(listbox,:sigSelect,:eventSelected)
+      @block=block
     end
     def eventOk
       super
+      @block.call(getFilename)
     end
     def eventFilenameChanged
       getChild("ok").setEnabled(getChild("filename").getText.to_s.length>0)
@@ -43,8 +45,33 @@
       getChild("filename").setText(AGStringUtf8.new(getChild("listBox").getSelectedValue))
       eventFilenameChanged
     end
+    private
+    def getFilename
+      getChild("filename").getText.to_s
+    end
 	end
 	
 	class LoadDialog<Dialog
+    def initialize(p,&block)
+      super
+      p.addChild(self)
+      loadXML(loadFile("data/gui/layout/editor/campaign/load_dialog.xml"))
+      
+      listbox=getChild("listBox")
+      Campaign.getAllFilenames.each{|f|
+        listbox.insertItem(f,AGStringUtf8.new(f))
+      }
+      
+      @block=block
+    end
+    def eventOk
+      super
+      @block.call(getFilename)
+    end
+    private
+    def getFilename
+      getChild("listBox").getSelectedValue.to_s
+    end
+	  
 	end
 end
\ No newline at end of file

Modified: antargis/trunk/ruby/editor/campaign/drag_grid.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/drag_grid.rb	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ruby/editor/campaign/drag_grid.rb	2008-07-07 19:04:25 UTC (rev 1271)
@@ -4,6 +4,11 @@
 require File.join(File.split(__FILE__)[0],"dialogs.rb")
 require File.join(File.split(__FILE__)[0],"toolbar.rb")
 
+require File.join(File.split(__FILE__)[0],'ruby_tools.rb')
+require File.join(File.split(__FILE__)[0],'story_editor.rb')
+requireRelative('ruby_signals.rb',__FILE__)
+require File.join(File.split(__FILE__)[0],"campaign_data.rb")
+
 #setDebugLevel(0)
 
 # TODO:
@@ -106,89 +111,20 @@
       getChildren.map{|child|[child]+child.getAllDescendants}.flatten
     end
     def moveToContext(to)
-      
+      pp "moveToContext"
       o=getScreenRect
       p=getParent
       p.removeChild(self)
       to.addChild(self)
-      #setParent(to)
       setRect(o+(-to.getScreenRect.getV0))
     end
-  end
-end
-
-class Effect<AGWidget
-  def initialize(p,r,node)
-    super(p,r)
-    @registered=false
-    @running=false
-    @duration=node["duration"].to_f
-    #run
-  end
-  def draw(p)
-    if @registered==false
-      registerEffect
+    def getChildByType(type)
+      getAllDescendants.select{|c|c.is_a?(type)}[0]
     end
   end
-  def run
-    @running=true
-    @time=0
-  end
-  def eventFrame(t)
-    if @running
-      @time+=t
-      @running=false if @time>=@duration
-      @time=@duration if @time>@duration 
-      step(@time/@duration)
-    end
-  end
-  def step(per)
-    pp per
-    exit
-  end
-  private
-  def registerEffect
-    if getApp
-      getApp.sigFrame.connect(self,:eventFrame)
-      @registered=true
-    end
-  end
 end
 
-class AppearEffect<Effect
-  def initialize(p,r,node)
-    super
-    @name=node["name"]
-    @target=node["table"]
-    @row=node["row"].to_i
-    @size=50
-    
-  end
-  def step(amount)
-    table=getApp.getMainWidget.getChild(@target)
-    table.modifyRow(@row,amount*@size)
-  end
-end
 
-class HideEffect<Effect
-  def initialize(p,r,node)
-    super
-    @name=node["name"]
-    @target=node["table"]
-    @row=node["row"].to_i
-    #@size=50
-    @size=nil
-    
-  end
-  def step(amount)
-    @size||=table.getRow(@row)
-    table.modifyRow(@row,(1-amount)*@size)
-  end
-  def table
-    getApp.getMainWidget.getChild(@target)
-  end
-end
-
 class AGHoverWidget<AGWidget
   attr_accessor :hoverBorder
   def initialize(*s)
@@ -197,25 +133,7 @@
   end
 end
 
-class GenericLayoutCreator<AGLayoutCreator
-  def initialize(c)
-    super()
-    @c=c
-  end
-  def create(p,r,node)
-    options=node.getAttributes
-    pp @c
-    setResult @c.new(p,r,options)
-  end
-end
 
-def standardLayoutCreator(pClass)
-  name=pClass.to_s
-  name=name[0..0].downcase+name[1..-1]
-  creator=GenericLayoutCreator.new(pClass)
-  getLayoutFactory.addCreator(name,creator)
-end
-
 class DragEnvironment<AGWidget
   def initialize(p,r,options)
     super(p,r)
@@ -263,10 +181,11 @@
   
   attr_accessor :text, :grid
   attr_accessor :selected
+
   
-  def initialize(p,r,text)
+  def initialize(p,r,text,dragging=true)
     super(p,r)
-    @dragging=true
+    @dragging=dragging
     @text=AGStringUtf8.new(text)
     @textPos=AGVector2.new(10,10)
     @lastCell=nil
@@ -275,6 +194,9 @@
     self.hoverBorder=BORDER_WIDTH
     @@font||=AGFont.new("FreeSans.ttf",14)
   end
+  
+  
+  
   def draw(p)
     r=getRect.origin.shrink(2)
     r2=r.shrink(BORDER_WIDTH)
@@ -308,6 +230,7 @@
   def startDragging
     @dragging=true
     moveToContext(getDragEnvironment)
+    setRect(getRect.shrink(5))
   end
   
   def eventMouseButtonDown(e)
@@ -339,9 +262,15 @@
   def eventMouseButtonUp(e)
     return super unless @dragging
     #moveToContext()
-    cells=getDragEnvironment.getDragTargets
-    scells=cells.select{|c|c.getScreenRect.shrink(10).contains(getMiddle)}
-    cell=scells[0]
+
+    if false
+      cells=getDragEnvironment.getDragTargets
+      scells=cells.select{|c|c.getScreenRect.shrink(10).contains(getMiddle)}
+      cell=scells[0]
+    else
+      env=getDragEnvironment.getChildByType(DragGrid)
+      cell=env.cells.select{|c|c.screenRect.shrink(10).contains(getMiddle)}[0]
+    end
     
     if cell
       if cell.free
@@ -371,8 +300,10 @@
   end
   def assignCell(cell)
     @lastCell=cell
-    moveToContext(@lastCell)
-    centerObject
+    
+    moveToContext(getDragGrid)
+    pp cell
+    setRect(cell.rect.shrink(5))
   end
   def centerObject
     setRect(getRect+(getParent.getRect.origin.getMiddle-getRect.getMiddle))
@@ -385,10 +316,12 @@
 end
 
 class DragBoxLevel<DragBox
+  attr_accessor :filename
 end
 
 class DragBoxStory<DragBox
-  def initialize(p,r,text)
+  attr_accessor :story
+  def initialize(p,r,text,dragging=true)
     super
     @color=AGColor.new(0xFF,0xAA,0)
   end
@@ -398,6 +331,7 @@
   include Arrows
   
   attr_accessor :selected, :text
+  attr_writer :endObject
   
   def initialize(p,r,startObject)
     super(p,r)
@@ -431,6 +365,7 @@
     white=AGColor.new(0xFF,0xFF,0x88) if @hovered
     black=AGColor.new(0,0,0)
     p.setLineWidth(1)
+    assert{endP}
     p.drawArrow(startP,endP,5,white,black)
     middle=(endP+startP)*0.5
     
@@ -452,10 +387,14 @@
   
   def eventMouseMotion(e)
     r=super
-    p=@pos
-    p=getPos(@endObject) if @endObject
+    if @endObject
+      p=getPos(@endObject)
+    else 
+      p=@pos
+    end
     mp=e.getMousePosition-getScreenRect.getV0
     if getArrowTriangles(getPos(@startObject),p,10).select{|t|t.contains(mp)}.length>0
+      puts p, at pos,getPos(@startObject),mp
       puts "HOVER"
       @hovered=true
       return true
@@ -474,6 +413,7 @@
       if @hovered
         @endObject=nil
         @moving=true
+        @pos=e.getMousePosition+(getRect.getV0-getScreenRect.getV0)
         r=true
       end
     end    
@@ -504,9 +444,14 @@
   end
 end
 
+Cell=Struct.new(:screenRect,:rect,:node)
+class Cell
+  def free
+    @node.nil?
+  end
+end
 
 
-
 class DragGrid<AGWidgetWithConfig
   attr_reader :cells, :cellWidth, :selected
   
@@ -550,6 +495,14 @@
   def eventMouseButtonDown(e)
     return super
   end
+  
+  def addChild(c)
+    super
+    getChildren.sort{|b,a|a.is_a?(DragLine)<=>b.is_a?(DragLine)}.each{|child|
+      addChildBack(child)
+    }    
+    
+  end
       
 private
   def cellCountX
@@ -559,6 +512,7 @@
     height/@cellWidth
   end
   def genCells()
+    @cells=[]
     w=cellWidth
     (0..cellCountX).map{|x|
       (0..cellCountY).map{|y|
@@ -567,7 +521,8 @@
     }.flatten.each{|c|newDragTarget(c)}
   end
   def newDragTarget(c)
-    addChild(DragTarget.new(nil,c, at options,self))
+    #addChild(DragTarget.new(nil,c, at options,self))
+    @cells << Cell.new(toScreen(c),c,nil)
   end
   def checkEdit
     
@@ -636,37 +591,9 @@
 
 [DragGrid,DragSource,DragTrash,DragEnvironment,ToolBar,ToolButton,ToolEdit,ToolCombo,AppearEffect,HideEffect].each{|c|standardLayoutCreator(c)}
 
-require File.join(File.split(__FILE__)[0],'story_editor.rb')
 
-class RubySignal
-  def initialize(name)
-    @name=name
-    @receivers=[]
-  end
-  def connect(object,method)
-    @receivers<<[object,method]
-  end
-  def call(*s)
-    @receivers.each{|p|
-      object,method=p
-      object.send(method,*s)
-    }
-  end  
-end
-def createSignal(x)
-  signal=RubySignal.new(x)
-  self.define_cmethod(x) {|*s|
-    if s.length==0
-      signal
-    else
-      signal.call(*s)
-    end
-  }
-end
 
-require File.join(File.split(__FILE__)[0],"campaign_data.rb")
 
-
 class CampaignEditorApp<AGApplication
   def initialize()
     super
@@ -684,9 +611,13 @@
     end
     
     addHandler(layout.getChild("edit"),:sigClick,:eventEdit)
+    addHandler(layout.getChild("quit"),:sigClick,:eventQuit)
     
     initSavingLoading
   end
+  def eventQuit
+    tryQuit
+  end
   def eventDeselect
     @grid.select(nil) if @grid
   end
@@ -713,23 +644,66 @@
   def initSavingLoading
     addHandler(@layout.getChild("load"),:sigClick,:eventLoad)    
     addHandler(@layout.getChild("save"),:sigClick,:eventSave)    
- #   pp Campaign.getAll
- #   exit
   end
   
   def eventLoad
+    CampaignEditor::LoadDialog.new(@layout) {|filename|
+      campaign=Campaign::loadCampaign(filename)
+      viewData(campaign)
+    }
     
     true
   end
   def eventSave
-    d=CampaignEditor::SaveDialog.new(@layout)
-    #d.loadXML(loadFile("data/gui/layout/editor/campaign/save_dialog.xml"))
-    #@layout.addChild(d)
-    #l=AGLayout.new(@layout)
-    #l.loadXML(loadFile())
-    #@layout.addChild(l)
+    CampaignEditor::SaveDialog.new(@layout) {|filename|
+      puts filename
+      exit
+    }
     true
   end
   
+  
+  private
+  def viewData(campaign)
+    @grid.clear
+    
+    boxes={}
+    
+    campaign.nodes.each{|name,node|
+      x=node.x
+      y=node.y
+      c=getCell(x,y)
+      box=nil
+      case node
+        when Level
+          box=DragBoxLevel.new(@grid,c.rect.shrink(5),name,false)
+          box.filename=node.filename
+          @grid.addChild(box)
+        when Story
+          box=DragBoxStory.new(@grid,c.rect.shrink(5),name,false)
+          box.story=node.screens
+          @grid.addChild(box)
+      end
+      boxes[name]=box
+    }
+    
+    campaign.edges.each{|edge|
+      pp edge.from,edge.to
+      puts boxes[edge.from].getRect,boxes[edge.to].getRect
+      line=DragLine.new(@grid, at grid.getRect,boxes[edge.from])
+      line.endObject=boxes[edge.to]
+      @grid.addChild(line)
+    }
+    
+  end
+  
+  def getCell(x,y)
+    r=@grid.cells[0].rect
+    x+=0.5
+    y+=0.5
+    x*=r.width
+    y*=r.height
+    @grid.cells.select{|cell|cell.rect.contains(AGVector2.new(x,y))}[0]
+  end
 end
 

Modified: antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb	2008-07-07 19:04:25 UTC (rev 1271)
@@ -10,9 +10,25 @@
   it "should be possible to place levels on the grid" do
     drag(getSourceMiddle("levelSource"),getGridPos(1,1),10)
     grid.getAllDescendants.select{|c|c.is_a?(DragBox)}.length.should == 1
+    level=grid.getChildren[0]
+    level.should be_a_kind_of(DragBoxLevel)
+    level.getParent.should_not be_nil
   end
   
   it "should be possible to move the grid" do
+    level=grid.getChildren[0]
+    level.getParent.should_not be_nil
+    oldPos=level.getScreenRect.getMiddle
+    delta=AGVector2.new(0,200)
+    scrollWidget=widget("dragGrid").getParent
+    ov=scrollWidget.getVector
+    middle=widget("dragGrid").getScreenRect.getMiddle
+    level.getParent.should_not be_nil
+    drag(middle,middle-delta,5) 
+    nv=scrollWidget.getVector
+    newPos=level.getScreenRect.getMiddle
+    level.getParent.should_not be_nil
+    oldPos.should == newPos+delta 
   end
   
   it "should not use widgets for DragTargets anymore" do
@@ -31,17 +47,20 @@
   it "should be possible to name arrows"
   
   private
-  def drag(from,to,frames)
+  def drag(from,to,frames,&block)
     p from,to
     #exit
     @app.setCursor(getTextureCache.get("blue_cursor.png"))
     
     mouseDown(from)
+    block.call(:mouseDown) if block
     1.upto(frames) {|f|
       mouseMotion(from+(to-from)*f/frames)
       @app.step
+      block.call(:mouseMotion) if block
     }
     mouseUp(to)
+    block.call(:mouseUp) if block
     #@app.step while true
   end
   

Modified: antargis/trunk/ruby/spec_helper.rb
===================================================================
--- antargis/trunk/ruby/spec_helper.rb	2008-07-02 17:22:33 UTC (rev 1270)
+++ antargis/trunk/ruby/spec_helper.rb	2008-07-07 19:04:25 UTC (rev 1271)
@@ -58,6 +58,7 @@
     def negative_failure_message
       bt=""
       bt=@@backtrace[@callName].join("\n") if @@backtrace[@callName] 
+      printStacktrace
       "expected #{@proc.inspect} not to call #{@expected} BT:#{bt}"
     end
     def Cross.symCall(name)



From davidkamphausen at mail.berlios.de  Thu Jul 10 21:16:18 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Thu, 10 Jul 2008 21:16:18 +0200
Subject: [Antargis-svn] r1272 - in antargis/trunk: .
	data/gui/layout/editor/campaign ext/basic ext/gui ruby
	ruby/editor/campaign ruby/gui ruby/spec ruby/spec/story
Message-ID: <200807101916.m6AJGIGe018557@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-10 21:16:05 +0200 (Thu, 10 Jul 2008)
New Revision: 1272

Added:
   antargis/trunk/checktabs.rb
   antargis/trunk/ruby/editor/campaign/app.rb
   antargis/trunk/ruby/editor/campaign/effect.rb
   antargis/trunk/ruby/editor/campaign/ruby_layouts.rb
   antargis/trunk/ruby/editor/campaign/ruby_signals.rb
   antargis/trunk/ruby/editor/campaign/ruby_tools.rb
   antargis/trunk/ruby/spec/story/
   antargis/trunk/ruby/spec/story/my_story.rb
   antargis/trunk/ruby/spec/story/story_spec
   antargis/trunk/ruby/spec/story/story_spec.rb
Modified:
   antargis/trunk/TODO
   antargis/trunk/data/gui/layout/editor/campaign/main.xml
   antargis/trunk/ext/basic/ag_messageobject.cc
   antargis/trunk/ext/basic/ag_messageobject.h
   antargis/trunk/ext/gui/ag_application.cc
   antargis/trunk/ext/gui/ag_widget.cc
   antargis/trunk/ext/gui/ag_widget.h
   antargis/trunk/ruby/editor/campaign/dialogs.rb
   antargis/trunk/ruby/editor/campaign/drag_grid.rb
   antargis/trunk/ruby/editor/campaign/editor.rb
   antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb
   antargis/trunk/ruby/gui/testing.rb
   antargis/trunk/ruby/spec/spec_scrollingwidget.rb
   antargis/trunk/ruby/spec_helper.rb
Log:
Incomplete - task 11: Campaign editor 
http://localhost:3000/issues/show/11

Modified: antargis/trunk/TODO
===================================================================
--- antargis/trunk/TODO	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/TODO	2008-07-10 19:16:05 UTC (rev 1272)
@@ -181,8 +181,5 @@
 [L] cleanup gui - remove unused elements
 [L] fix selecting group. When you switch the "tabs", the selected action should be changed, too
 
-[Packaging / Building]
-------------------------------------------------------
-[L] installer for linux. maybe some autopackage or .debs?
 
 

Added: antargis/trunk/checktabs.rb
===================================================================
--- antargis/trunk/checktabs.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/checktabs.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,25 @@
+#!/usr/bin/env ruby
+
+require 'pp'
+
+def hasTabs(f)
+  f=File.open(f)
+  r=(f.read=~/\t/)
+  f.close
+  r
+end
+
+def removeTabs(fn)
+  f=File.open(fn)
+  c=f.read
+  f.close
+  f=File.open(fn,"w")
+  f.puts c.gsub("\t","  ")
+  f.close
+end
+
+
+Dir["ruby/**/*.rb"].each{|f|
+  removeTabs(f) if hasTabs(f)
+ # pp f,hasTabs(f)
+}

Modified: antargis/trunk/data/gui/layout/editor/campaign/main.xml
===================================================================
--- antargis/trunk/data/gui/layout/editor/campaign/main.xml	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/data/gui/layout/editor/campaign/main.xml	2008-07-10 19:16:05 UTC (rev 1272)
@@ -35,9 +35,6 @@
               <cell col="0" row="1">
                 <dragSource name ="storySource" class="DragBoxStory" text="Story"/>
               </cell>
-              <cell col="0" row="2">
-                <dragTrash/>
-              </cell>
         
             </table>
           </cell>
@@ -52,12 +49,16 @@
     
     
           <cell col="1" row="1" name="a">
-            <table cols="2" rows="1" name="b">
-              <colsize col="1" fixed="50"/>
+            <table cols="3" rows="1" name="b">
+              <colsize col="0" fixed="50"/>
+              <colsize col="2" fixed="50"/>
               <cell col="0" row="0">
+                <button name="trash" caption-image="data/gui/images/basic/cross.png"/>
+              </cell>
+              <cell col="1" row="0">
                 <edit name="textEdit"/>
               </cell>
-              <cell col="1" row="0">
+              <cell col="2" row="0">
                 <button name="edit" caption-image="data/gui/options.png"/>
               </cell>
             </table>

Modified: antargis/trunk/ext/basic/ag_messageobject.cc
===================================================================
--- antargis/trunk/ext/basic/ag_messageobject.cc	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ext/basic/ag_messageobject.cc	2008-07-10 19:16:05 UTC (rev 1272)
@@ -22,15 +22,16 @@
 #include "ag_debug.h"
 #include "ag_main.h"
 #include "ag_stringstream.h"
+#include "ag_widget.h"
 
 SDL_Event AGEvent::NullEvent={SDL_NOEVENT};
 
 // AGEvent
 AGEvent::AGEvent(AGListener *pCaller,const AGString &pName,const SDL_Event &e):mCaller(pCaller),mName(pName),mEvent(e),
-  mMousePosition(0),mRelMousePosition(0)
-  {
-    mClipped=false;
-  }
+mMousePosition(0),mRelMousePosition(0)
+      {
+        mClipped=false;
+      }
 AGEvent::~AGEvent()
   {
     if(mMousePosition)
@@ -125,7 +126,7 @@
 {
   if(mMousePosition)
     return *mMousePosition;
-  
+
   assert(eventOk(mEvent));
   AGVector2 p;
   switch(mEvent.type) {
@@ -227,11 +228,11 @@
 AGSignal::AGSignal(AGMessageObject *pCaller):mCaller(pCaller)
   {
   }
-*/
+ */
 AGSignal::AGSignal(AGMessageObject *pCaller,const AGString &pName):
   mName(pName),mCaller(pCaller)
-    {
-    }
+        {
+        }
 
 AGSignal::~AGSignal()
   {
@@ -317,10 +318,10 @@
   }
 
 bool AGSignal::operator()(AGEvent *m)
-  {
-    m->setName(mName);
-    return signal(m);
-  }
+      {
+        m->setName(mName);
+        return signal(m);
+      }
 
 // AGMessageObject
 
@@ -339,8 +340,8 @@
   sigSysWM(this,"sigSysWM"),
   sigVideoResize(this,"sigVideoResize"),
   mCanReceiveMessages(true)
-    {
-    }
+        {
+        }
 
 AGMessageObject::~AGMessageObject()
   {
@@ -414,6 +415,15 @@
         }
       }
 
+    if(rc)
+      {
+        AGWidget *w=dynamic_cast<AGWidget*>(this);
+        if(w)
+          cdebug(toString(&agEvent->get())<<" eaten up by "<<typeid(*this).name()<<" "<<w->getName());
+        else
+          cdebug(toString(&agEvent->get())<<" eaten up by "<<typeid(*this).name());//<<" "<<getName());
+      }
+
     return rc;
   }
 
@@ -515,7 +525,7 @@
     return k;
   }
 
-AGString toString(SDL_Event *pEvent)
+AGString toString(const SDL_Event *pEvent)
   {
     AGStringStream os;
     if(pEvent)

Modified: antargis/trunk/ext/basic/ag_messageobject.h
===================================================================
--- antargis/trunk/ext/basic/ag_messageobject.h	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ext/basic/ag_messageobject.h	2008-07-10 19:16:05 UTC (rev 1272)
@@ -259,7 +259,7 @@
 }
 
 
-AGEXPORT AGString toString(SDL_Event *pEvent);
+AGEXPORT AGString toString(const SDL_Event *pEvent);
 AGEXPORT SDL_Event *toSDLEvent(const AGString &p);
 
 AGEXPORT bool eventOk(const SDL_Event &pEvent);

Modified: antargis/trunk/ext/gui/ag_application.cc
===================================================================
--- antargis/trunk/ext/gui/ag_application.cc	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ext/gui/ag_application.cc	2008-07-10 19:16:05 UTC (rev 1272)
@@ -436,7 +436,7 @@
             eventChangedRes();
             redraw();
           }
-        else if (k==SDLK_F10)
+        else if (k==SDLK_F10||toString(&m->get())=="SDL_KEYDOWN:0:1:12:113:1024:113") // APPLE+Q
           tryQuit();
       }
     return false;

Modified: antargis/trunk/ext/gui/ag_widget.cc
===================================================================
--- antargis/trunk/ext/gui/ag_widget.cc	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ext/gui/ag_widget.cc	2008-07-10 19:16:05 UTC (rev 1272)
@@ -67,28 +67,27 @@
   mFixedWidth(false),mFixedHeight(false),mVisible(true),mCaching(false),
   mHasFocus(false),mFocus(0)
 
-  {
-    allWidgets.insert(this);
+    {
+      allWidgets.insert(this);
 
-    mEventsInited=false;
-    CTRACE;
-    if(mParent)
-      mParent->addChildRef(this);
+      mEventsInited=false;
+      CTRACE;
+      if(mParent)
+        mParent->addChildRef(this);
 
-    mChangeRect=AGRect2(0,0,0,0);
-    mCache=0;
-    mCacheTouched=false;
-    mTooltipWidget=0;
-    mModal=false;
+      mChangeRect=AGRect2(0,0,0,0);
+      mCache=0;
+      mCacheTouched=false;
+      mTooltipWidget=0;
+      mModal=false;
 
-    getMain()->getCollector()->insertGlobal(this);
-  }
+      getMain()->getCollector()->insertGlobal(this);
+    }
 
 AGWidget::~AGWidget()
   {
     allWidgets.erase(this);
     CTRACE;
-    cdebug(getName());
 
     if(hasMain())
       getMain()->getCollector()->removeGlobal(this);
@@ -98,27 +97,21 @@
       {
         if(valid(*i))
           {
-            cdebug("notify child:"<<*i);
             (*i)->setParent(0);
-            cdebug("notify ok");
           }
       }
     for(std::set<AGWidget*>::iterator i=mRefChildren.begin();i!=mRefChildren.end();i++)
       {
         if(valid(*i))
           {
-            cdebug("notify child:"<<*i);
             (*i)->setParent(0);
-            cdebug("notify ok");
           }
       }
 
-    cdebug(mParent);
     if(getParent())
       {
         if(valid(getParent()))
           {
-            cdebug("notify parent:"<<getParent());
             getParent()->eventChildrenDeleted(this);
           }
       }
@@ -401,6 +394,7 @@
             cdebug(getName());
             mButtonDown=true;
             mOldMousePos=e->getMousePosition();
+            return false;
           }
       }
     return false;
@@ -531,8 +525,8 @@
         if(i!=mChildren.end())
           mChildren.erase(i);
       }while(i!=mChildren.end());
-    
-    
+
+
     mChildren.push_back(w); // set on top
 
     if(mHasFocus && w->canFocus())
@@ -542,7 +536,7 @@
     if(!w->getParent())
       w->setParent(this);
     queryRedraw();
-}
+  }
 
 void AGWidget::regChange()
   {
@@ -691,14 +685,11 @@
 void AGWidget::setParent(AGWidget *pParent)
   {
     CTRACE;
-    //mOldMousePos.setX(-20000); // set oldmousepos invalid -- see eventMouseMotion 
 
-
     if(!mParent)
       {
         AGWidget *old=mParent;
         mParent=pParent;
-        cdebug(old);
         if(mParent==0 && old!=0)
           old->eventChildrenDeleted(this);
         if(hasMain())
@@ -724,12 +715,10 @@
  */
 AGRect2 AGWidget::getScreenRect() const
 {
-  CTRACE;
   AGRect2 r=getRect();
   if(mParent)
     {
       AGRect2 result=mParent->toScreen(getRect());
-      cdebug(getRect()<<"::"<<result);
       return result;
     }
   return r;
@@ -1379,3 +1368,14 @@
   {
 
   }
+AGWidget *AGWidget::getFocusedWidget()
+  {
+    AGWidget *found=0;
+    for(Children::reverse_iterator i=mChildren.rbegin();i!=mChildren.rend();i++)
+      {
+        found=(*i)->getFocusedWidget();
+        if(found)
+          return found;
+      }
+    return canFocus()?this:0;
+  }

Modified: antargis/trunk/ext/gui/ag_widget.h
===================================================================
--- antargis/trunk/ext/gui/ag_widget.h	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ext/gui/ag_widget.h	2008-07-10 19:16:05 UTC (rev 1272)
@@ -217,6 +217,7 @@
 
   bool getFocus() const;
   bool hasFocus(const AGWidget *pWidget=0);
+  AGWidget *getFocusedWidget ();
 
   AGLayout *getLayout();
 

Added: antargis/trunk/ruby/editor/campaign/app.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/app.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/app.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,140 @@
+require File.join(File.split(__FILE__)[0],'drag_grid.rb')
+
+
+# This is the main application-class of the campaign-editor.
+# It manages the interaction of the different widgets within
+# and calls the sub-editors (level and story-editor)
+class CampaignEditorApp<AGApplication
+  def initialize()
+    super
+    createSignal :sigFrame
+    layout=AGLayout.new(nil)
+    @layout=layout
+    file=File.join('data','gui','layout','editor','campaign','main.xml')
+    layout.loadXML( loadFile(file) )
+    setMainWidget(layout)
+    layout.setApp(self)
+    if layout.getChild("bigTable")
+      env=layout.getChild("dragEnvironment")
+      @grid=layout.getChild("dragGrid")
+      addHandler(@grid,:sigClick,:eventDeselect)
+    end
+    
+    addHandler(layout.getChild("edit"),:sigClick,:eventEdit)
+    addHandler(layout.getChild("quit"),:sigClick,:eventQuit)
+    addHandler(layout.getChild("trash"),:sigClick,:eventTrashClicked)
+    
+    initSavingLoading
+  end
+  def eventQuit
+    tryQuit
+  end
+  def eventDeselect
+    @grid.select(nil) if @grid
+    false
+  end
+  def eventFrame(t)
+    sigFrame(t)
+    super
+  end
+  def getEffect(name)
+    @layout.getChild(name)
+  end
+  def eventEdit
+    widget=nil
+    case @grid.selected
+      when DragBoxStory
+        widget=StoryEditor.new(@layout, at layout.getRect,{})
+      when DragBoxLevel
+        # FIXME
+    end
+    
+    @layout.addChild(widget) if widget
+    true
+  end
+  
+  def startEffect(name)
+    case name
+      when "showEdit"
+        getEffect(name).run
+        getEffect("hideEdit").stop
+      when "hideEdit"
+        getEffect(name).run
+        getEffect("showEdit").stop
+    end
+  end
+  
+  def eventTrashClicked
+    if @grid.selected
+      @grid.removeChild(@grid.selected)
+    end
+  end
+  
+  def initSavingLoading
+    addHandler(@layout.getChild("load"),:sigClick,:eventLoad)    
+    addHandler(@layout.getChild("save"),:sigClick,:eventSave)    
+  end
+  
+  def eventLoad
+    CampaignEditor::LoadDialog.new(@layout) {|filename|
+      campaign=Campaign::loadCampaign(filename)
+      viewData(campaign)
+    }
+    
+    true
+  end
+  def eventSave
+    CampaignEditor::SaveDialog.new(@layout) {|filename|
+      puts filename
+      exit
+    }
+    true
+  end
+  
+  
+  private
+  def viewData(campaign)
+    @grid.clear
+    
+    boxes={}
+    
+    campaign.nodes.each{|name,node|
+      x=node.x
+      y=node.y
+      c=getCell(x,y)
+      box=nil
+      case node
+        when Level
+          box=DragBoxLevel.new(@grid,c.rect.shrink(5),name,false)
+          box.filename=node.filename
+          @grid.addChild(box)
+        when Story
+          box=DragBoxStory.new(@grid,c.rect.shrink(5),name,false)
+          box.story=node.screens
+          @grid.addChild(box)
+      end
+      boxes[name]=box
+    }
+    
+    campaign.edges.each{|edge|
+      pp edge.from,edge.to
+      puts boxes[edge.from].getRect,boxes[edge.to].getRect
+      line=DragLine.new(@grid, at grid.getRect,boxes[edge.from])
+      line.endObject=boxes[edge.to]
+      @grid.addChild(line)
+    }
+    
+  end
+  
+  def getCell(x,y)
+    r=@grid.cells[0].rect
+    x+=0.5
+    y+=0.5
+    x*=r.width
+    y*=r.height
+    @grid.cells.select{|cell|cell.rect.contains(AGVector2.new(x,y))}[0]
+  end
+end
+
+
+

Modified: antargis/trunk/ruby/editor/campaign/dialogs.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/dialogs.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/dialogs.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -49,9 +49,9 @@
     def getFilename
       getChild("filename").getText.to_s
     end
-	end
-	
-	class LoadDialog<Dialog
+  end
+  
+  class LoadDialog<Dialog
     def initialize(p,&block)
       super
       p.addChild(self)
@@ -72,6 +72,6 @@
     def getFilename
       getChild("listBox").getSelectedValue.to_s
     end
-	  
-	end
+    
+  end
 end
\ No newline at end of file

Modified: antargis/trunk/ruby/editor/campaign/drag_grid.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/drag_grid.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/drag_grid.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -38,11 +38,9 @@
       ]
   end
   def getArrowTriangles(from,to,width)
-    #puts "gettin tris"
     ps=createArrowPolies(from,to,width)
     ts=[ps[0][0..2],ps[0][1..3],ps[1]]
     r=ts.map{|t|AGTriangle2.new(t[0],t[1],t[2])}
-    #puts "gettin tris!"
     r
   end
 end
@@ -162,12 +160,6 @@
   end
 end
 
-class DragTrash<DragTarget
-  def draw(p)
-    p.fillRoundRect(getRect.origin,10,AGColor.new(0x33,0x33,0x33))
-  end
-end
-
 module DragObject
   def canFocus
     false
@@ -195,8 +187,8 @@
     @@font||=AGFont.new("FreeSans.ttf",14)
   end
   
+
   
-  
   def draw(p)
     r=getRect.origin.shrink(2)
     r2=r.shrink(BORDER_WIDTH)
@@ -237,21 +229,20 @@
     r=super
     sRect=getRect
     if sRect.contains(e.getRelMousePosition)
-      
-      getDragGrid.select(self) if getDragGrid
+      dragGrid=getDragGrid
       if sRect.shrink(BORDER_WIDTH).contains(e.getRelMousePosition)
         startDragging
-        return true
+        r=true
       elsif @lastCell
         startLine(e)
-        return true
+        r=true
       end
+      dragGrid.select(self) if dragGrid
     end
     r
   end
   
   def startLine(e)
-    puts "STARTLINE"
     env=getAncestor(DragGrid)
     env.addChild(line=DragLine.new(env,env.getRect,self))
     line.setButtonDown(true,e.getMousePosition) # enable dragging
@@ -286,10 +277,6 @@
       hide
     end
     
-    if cell.is_a?(DragTrash)
-      pp cell
-      del 
-    end
     @dragging=false
     true
   end
@@ -358,7 +345,9 @@
    
     if @endObject and @startObject
       if @moving==false and (@endObject.visible==false or @startObject.visible==false)
-        hide
+        #hide
+        getParent.removeChild(self)
+        return
       end
     end
     white=AGColor.new(0xFF,0xFF,0xFF)
@@ -394,8 +383,6 @@
     end
     mp=e.getMousePosition-getScreenRect.getV0
     if getArrowTriangles(getPos(@startObject),p,10).select{|t|t.contains(mp)}.length>0
-      puts p, at pos,getPos(@startObject),mp
-      puts "HOVER"
       @hovered=true
       return true
     else
@@ -403,9 +390,9 @@
     end
     r
   end
+  
   def eventMouseButtonDown(e)
     r=super
-    
     if @endObject.nil?
       @moving=true
       @pos=e.getMousePosition+(getRect.getV0-getScreenRect.getV0)
@@ -433,7 +420,6 @@
         @endObject=ts[0]
       end
     end
-    
     r
   end
   def getDragEnvironment
@@ -476,10 +462,10 @@
       @selected.selected=true
       checkEdit    
       @edit.setText(@selected.text)
-      @edit.gainFocus
-      getApp.getEffect("showEdit").run
+      getApp.startEffect("showEdit")
+      @edit.gainCompleteFocus
     else
-      getApp.getEffect("hideEdit").run
+      getApp.startEffect("hideEdit")
     end
   end
 
@@ -492,9 +478,9 @@
     @lines.each{|l|p.drawLine(l.getV0,l.getV1, at borderColor)}
   end
   
-  def eventMouseButtonDown(e)
-    return super
-  end
+#  def eventMouseButtonDown(e)
+ #   return super
+  #end
   
   def addChild(c)
     super
@@ -589,121 +575,5 @@
 end
 
 
-[DragGrid,DragSource,DragTrash,DragEnvironment,ToolBar,ToolButton,ToolEdit,ToolCombo,AppearEffect,HideEffect].each{|c|standardLayoutCreator(c)}
+[DragGrid,DragSource,DragEnvironment,ToolBar,ToolButton,ToolEdit,ToolCombo,AppearEffect,HideEffect].each{|c|standardLayoutCreator(c)}
 
-
-
-
-class CampaignEditorApp<AGApplication
-  def initialize()
-    super
-    createSignal :sigFrame
-    layout=AGLayout.new(nil)
-    @layout=layout
-    file=File.join('data','gui','layout','editor','campaign','main.xml')
-    layout.loadXML( loadFile(file) )
-    setMainWidget(layout)
-    layout.setApp(self)
-    if layout.getChild("bigTable")
-      env=layout.getChild("dragEnvironment")
-      @grid=layout.getChild("dragGrid")
-      addHandler(env,:sigClick,:eventDeselect)
-    end
-    
-    addHandler(layout.getChild("edit"),:sigClick,:eventEdit)
-    addHandler(layout.getChild("quit"),:sigClick,:eventQuit)
-    
-    initSavingLoading
-  end
-  def eventQuit
-    tryQuit
-  end
-  def eventDeselect
-    @grid.select(nil) if @grid
-  end
-  def eventFrame(t)
-    sigFrame(t)
-    super
-  end
-  def getEffect(name)
-    @layout.getChild(name)
-  end
-  def eventEdit
-    widget=nil
-    case @grid.selected
-      when DragBoxStory
-        widget=StoryEditor.new(@layout, at layout.getRect,{})
-      when DragBoxLevel
-        # FIXME
-    end
-    
-    @layout.addChild(widget) if widget
-    true
-  end
-  
-  def initSavingLoading
-    addHandler(@layout.getChild("load"),:sigClick,:eventLoad)    
-    addHandler(@layout.getChild("save"),:sigClick,:eventSave)    
-  end
-  
-  def eventLoad
-    CampaignEditor::LoadDialog.new(@layout) {|filename|
-      campaign=Campaign::loadCampaign(filename)
-      viewData(campaign)
-    }
-    
-    true
-  end
-  def eventSave
-    CampaignEditor::SaveDialog.new(@layout) {|filename|
-      puts filename
-      exit
-    }
-    true
-  end
-  
-  
-  private
-  def viewData(campaign)
-    @grid.clear
-    
-    boxes={}
-    
-    campaign.nodes.each{|name,node|
-      x=node.x
-      y=node.y
-      c=getCell(x,y)
-      box=nil
-      case node
-        when Level
-          box=DragBoxLevel.new(@grid,c.rect.shrink(5),name,false)
-          box.filename=node.filename
-          @grid.addChild(box)
-        when Story
-          box=DragBoxStory.new(@grid,c.rect.shrink(5),name,false)
-          box.story=node.screens
-          @grid.addChild(box)
-      end
-      boxes[name]=box
-    }
-    
-    campaign.edges.each{|edge|
-      pp edge.from,edge.to
-      puts boxes[edge.from].getRect,boxes[edge.to].getRect
-      line=DragLine.new(@grid, at grid.getRect,boxes[edge.from])
-      line.endObject=boxes[edge.to]
-      @grid.addChild(line)
-    }
-    
-  end
-  
-  def getCell(x,y)
-    r=@grid.cells[0].rect
-    x+=0.5
-    y+=0.5
-    x*=r.width
-    y*=r.height
-    @grid.cells.select{|cell|cell.rect.contains(AGVector2.new(x,y))}[0]
-  end
-end
-

Modified: antargis/trunk/ruby/editor/campaign/editor.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/editor.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/editor.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -1,4 +1,5 @@
-require File.join(File.split(__FILE__)[0],'drag_grid.rb')
+require File.join(File.split(__FILE__)[0],'app.rb')
 
+
 app=CampaignEditorApp.new
 app.run
\ No newline at end of file

Added: antargis/trunk/ruby/editor/campaign/effect.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/effect.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/effect.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,76 @@
+class Effect<AGWidget
+  def initialize(p,r,node)
+    super(p,r)
+    @registered=false
+    @running=false
+    @duration=node["duration"].to_f
+    #run
+  end
+  def draw(p)
+    if @registered==false
+      registerEffect
+    end
+  end
+  def run
+    @running=true
+    @time=0
+  end
+  def eventFrame(t)
+    if @running
+      @time+=t
+      @running=false if @time>=@duration
+      pp @running
+      @time=@duration if @time>@duration 
+      step(@time/@duration)
+    end
+  end
+  def stop
+    @running=false
+  end
+  def step(per)
+    pp per
+    exit
+  end
+  private
+  def registerEffect
+    if getApp
+      getApp.sigFrame.connect(self,:eventFrame)
+      @registered=true
+    end
+  end
+end
+
+class AppearEffect<Effect
+  def initialize(p,r,node)
+    super
+    @name=node["name"]
+    @target=node["table"]
+    @row=node["row"].to_i
+    @size=50
+    
+  end
+  def step(amount)
+    pp "AMOUNT:",amount
+    table=getApp.getMainWidget.getChild(@target)
+    table.modifyRow(@row,amount*@size)
+  end
+end
+
+class HideEffect<Effect
+  def initialize(p,r,node)
+    super
+    @name=node["name"]
+    @target=node["table"]
+    @row=node["row"].to_i
+    #@size=50
+    @size=nil
+  end
+  def step(amount)
+    pp "AMOUNT HIDE:",amount
+    @size||=table.getRow(@row)
+    table.modifyRow(@row,(1-amount)*@size)
+  end
+  def table
+    getApp.getMainWidget.getChild(@target)
+  end
+end

Added: antargis/trunk/ruby/editor/campaign/ruby_layouts.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/ruby_layouts.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/ruby_layouts.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,20 @@
+class GenericLayoutCreator<AGLayoutCreator
+  def initialize(c)
+    super()
+    @c=c
+  end
+  def create(p,r,node)
+    options=node.getAttributes
+    pp @c
+    setResult @c.new(p,r,options)
+  end
+end
+
+def standardLayoutCreator(pClass)
+  name=pClass.to_s
+  name=name[0..0].downcase+name[1..-1]
+  creator=GenericLayoutCreator.new(pClass)
+  getLayoutFactory.addCreator(name,creator)
+end
+
+requireRelative("effect.rb",__FILE__)
\ No newline at end of file

Added: antargis/trunk/ruby/editor/campaign/ruby_signals.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/ruby_signals.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/ruby_signals.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,25 @@
+class RubySignal
+  def initialize(name)
+    @name=name
+    @receivers=[]
+  end
+  def connect(object,method)
+    @receivers<<[object,method]
+  end
+  def call(*s)
+    @receivers.each{|p|
+      object,method=p
+      object.send(method,*s)
+    }
+  end  
+end
+def createSignal(x)
+  signal=RubySignal.new(x)
+  self.define_cmethod(x) {|*s|
+    if s.length==0
+      signal
+    else
+      signal.call(*s)
+    end
+  }
+end

Added: antargis/trunk/ruby/editor/campaign/ruby_tools.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/ruby_tools.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/ruby_tools.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,24 @@
+def requireRelative(file,current)
+  require File.join(File.split(current)[0],file)
+end
+
+class FalseClass
+  def <=>(o)
+    if o==true
+      -1
+    else
+      0
+    end
+  end
+end
+class TrueClass
+  def <=>(o)
+    if o==false
+      1
+    else
+      0
+    end
+  end
+end
+
+requireRelative("ruby_layouts.rb",__FILE__)
\ No newline at end of file

Modified: antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb
===================================================================
--- antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/editor/campaign/spec_campaign_editor.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -1,6 +1,6 @@
 require File.join(File.split(__FILE__)[0],"..","..","spec_helper.rb")
 require File.join(File.split(__FILE__)[0],"..","..","gui","testing.rb")
-require File.join(File.split(__FILE__)[0],"drag_grid.rb")
+require File.join(File.split(__FILE__)[0],"app.rb")
 
 describe "Campaign editor" do
   include GuiTest
@@ -14,7 +14,7 @@
     level.should be_a_kind_of(DragBoxLevel)
     level.getParent.should_not be_nil
   end
-  
+  #if false
   it "should be possible to move the grid" do
     level=grid.getChildren[0]
     level.getParent.should_not be_nil
@@ -29,7 +29,9 @@
     newPos=level.getScreenRect.getMiddle
     level.getParent.should_not be_nil
     oldPos.should == newPos+delta 
+    drag(middle-delta,middle,5)
   end
+#end
   
   it "should not use widgets for DragTargets anymore" do
     # define DragTarget, if not yet defined
@@ -38,8 +40,33 @@
     grid.getAllDescendants.select{|c|c.is_a?(DragTarget)}.length.should == 0
   end
   
+  it "should be possible to select a node and edit the name" do
+    grid=widget("dragGrid")
+    somepos=AGVector2.new(800,600)
+    mouseMotion(somepos)
+    click(somepos)
+    node=grid.getChildren[0]
+    pos=node.getScreenRect.getMiddle
+    observe(@app.getEffect("hideEdit"),:run) {
+      observe(@app.getEffect("showEdit"),:run) {
+        observe(grid.widget,:select) {
+          mouseDown(pos)
+        }.should be_called
+      }.should be_called
+    }.should_not be_called
+    # mouseUp(pos)
+    observe(@app.getEffect("hideEdit"),:step) {
+      observe(@app.getEffect("showEdit"),:step) {
+        observe(@app,:eventFrame) {
+          1.upto(20) do @app.step end
+        }.should be_called
+      }.should be_called(2,:times)
+    }.should_not be_called
+    widget("textEdit").should have_focus
+    #@app.step while true
+    widget("textEdit").height.should > 10
+  end 
   
-  
   it "should be possible to place stories on the grid"
   it "should be possible to define a start-node"
   it "should be possible to draw arrows from one node to another"
@@ -51,7 +78,7 @@
     p from,to
     #exit
     @app.setCursor(getTextureCache.get("blue_cursor.png"))
-    
+    mouseMotion(from)
     mouseDown(from)
     block.call(:mouseDown) if block
     1.upto(frames) {|f|

Modified: antargis/trunk/ruby/gui/testing.rb
===================================================================
--- antargis/trunk/ruby/gui/testing.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/gui/testing.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -6,9 +6,10 @@
     puts "step end"
   end
   def eventFrame(t)
-    super
+    super(0.05)
     puts "FRAME - try Quit..."
     tryQuit
+    delay(20)
     true
   end
   def tryQuit

Modified: antargis/trunk/ruby/spec/spec_scrollingwidget.rb
===================================================================
--- antargis/trunk/ruby/spec/spec_scrollingwidget.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/spec/spec_scrollingwidget.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -8,6 +8,7 @@
   end
   def eventMouseMotion(e)
     @mousePos=e.getMousePosition
+    false
   end
 end
 
@@ -104,7 +105,43 @@
     end
   end
   describe "position translation in events" do
+    include GuiTest
+    before(:each) do
+      @app=makeTestAppClass(MyTestApp).new
+    end
     it "should translate" do
+      puts "_____"
+      puts @app.sWidget
+      s=@app.sWidget
+      puts 1
+      
+      p0=AGVector2.new(10,20)
+      puts 2
+      p1=AGVector2.new(10,10)
+      puts 3
+      old=s.getVector
+      puts 4
+      mouseMotion(p0)
+      mouseDown(p0)
+      puts 5
+      s.getVector.should == old
+      puts 6
+      #@app.step while true
+      mouseMotion(p1)
+      puts 7
+      s.getVector.should_not == old
+      puts 8
+      mouseMotion(p0)
+      puts 9
+      s.getVector.should == old
+      puts 10
+      mouseUp(p0)
+      puts 11
+      s.getVector.should == old
+      puts 12
+      mouseMotion(p1)
+      puts 13
+      s.getVector.should == old
     end
   end
 end

Added: antargis/trunk/ruby/spec/story/my_story.rb
===================================================================
--- antargis/trunk/ruby/spec/story/my_story.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/spec/story/my_story.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,52 @@
+require 'spec'
+require 'spec/story'
+require 'ostruct'
+
+Account=Struct.new(:balance)
+
+class Account
+  def transfer_to(account,amount)
+    @balance-=amount
+    account.balance+=amount
+    amount
+  end
+end
+
+#include Spec::Story::Extensions::Main
+#run_story :type => RailsStory do |runner|
+
+class AccountSteps < Spec::Story::StepGroup
+  steps do |define|
+    define.given("my savings account balance is $balance") do |balance|
+      @savings_account = Account.new(balance.to_f)
+    end
+
+    define.given("my cash account balance is $balance") do |balance|
+      @cash_account = Account.new(balance.to_f)
+    end
+
+    define.then("my savings account balance should be $expected_amount") do |expected_amount|
+      @savings_account.balance.should == expected_amount.to_f
+    end
+
+    define.then("my cash account balance should be $expected_amount") do |expected_amount|
+      @cash_account.balance.should == expected_amount.to_f
+    end
+    define.when("I transfer $amount") do |amount|
+      @savings_account.transfer_to(@cash_account, amount.to_f)
+    end
+  end
+end
+
+steps = AccountSteps.new do |define|
+  define.when("I transfer $amount") do |amount|
+    @savings_account.transfer_to(@cash_account, amount.to_f)
+  end
+end
+
+run_story do |runner|
+  #runner.steps << LoginSteps.new
+  #runner.steps << NavigationSteps.new
+  runner.steps << AccountSteps.new
+  runner.load File.expand_path(__FILE__).gsub(".rb","")
+end

Added: antargis/trunk/ruby/spec/story/story_spec
===================================================================
--- antargis/trunk/ruby/spec/story/story_spec	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/spec/story/story_spec	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,18 @@
+Story: transfer to cash account
+  As a savings account holder
+  I want to transfer money from my savings account
+  So that I can get cash easily from an ATM
+
+  Scenario: savings account is in credit
+    Given my savings account balance is 100
+    And my cash account balance is 10
+    When I transfer 20
+    Then my savings account balance should be 80
+    And my cash account balance should be 30
+
+  Scenario: savings account is overdrawn
+    Given my savings account balance is -20
+    And my cash account balance is 10
+    When I transfer 20
+    Then my savings account balance should be -20
+    And my cash account balance should be 10
\ No newline at end of file

Added: antargis/trunk/ruby/spec/story/story_spec.rb
===================================================================
--- antargis/trunk/ruby/spec/story/story_spec.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/spec/story/story_spec.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -0,0 +1,52 @@
+require 'spec'
+require 'spec/story'
+require 'ostruct'
+
+Account=Struct.new(:balance)
+
+class Account
+  def transfer_to(account,amount)
+    @balance-=amount
+    account.balance+=amount
+    amount
+  end
+end
+
+#include Spec::Story::Extensions::Main
+#run_story :type => RailsStory do |runner|
+
+class AccountSteps < Spec::Story::StepGroup
+  steps do |define|
+    define.given("my savings account balance is $balance") do |balance|
+      @savings_account = Account.new(balance.to_f)
+    end
+
+    define.given("my cash account balance is $balance") do |balance|
+      @cash_account = Account.new(balance.to_f)
+    end
+
+    define.then("my savings account balance should be $expected_amount") do |expected_amount|
+      @savings_account.balance.should == expected_amount.to_f
+    end
+
+    define.then("my cash account balance should be $expected_amount") do |expected_amount|
+      @cash_account.balance.should == expected_amount.to_f
+    end
+    define.when("I transfer $amount") do |amount|
+      @savings_account.transfer_to(@cash_account, amount.to_f)
+    end
+  end
+end
+
+steps = AccountSteps.new do |define|
+  define.when("I transfer $amount") do |amount|
+    @savings_account.transfer_to(@cash_account, amount.to_f)
+  end
+end
+
+run_story do |runner|
+  #runner.steps << LoginSteps.new
+  #runner.steps << NavigationSteps.new
+  runner.steps << AccountSteps.new
+  runner.load File.expand_path(__FILE__).gsub(".rb","")
+end

Modified: antargis/trunk/ruby/spec_helper.rb
===================================================================
--- antargis/trunk/ruby/spec_helper.rb	2008-07-07 19:04:25 UTC (rev 1271)
+++ antargis/trunk/ruby/spec_helper.rb	2008-07-10 19:16:05 UTC (rev 1272)
@@ -15,10 +15,12 @@
   class Cross
     @@called={}
     @@backtrace={}
-    def initialize(target,function)
+    @@raiseException={}
+    def initialize(target,function,raiseException=false)
       @target=target
       @function=function
       @expected="#{target}.#{function}(.)"
+      @@raiseException[@expected]=raiseException
     end
     def matches?(proc)      
       @proc = proc
@@ -64,27 +66,30 @@
     def Cross.symCall(name)
       @@called[name]+=1
       @@backtrace[name]=caller
+      raise "Should never cross this" if @@raiseException[name]
       nil
     end
   end
   
-  def cross(target,function=nil)
+  def cross(target,function=nil,raiseException=false)
       if function.nil? and target.is_a?(Symbol)
         function=target
         target=kernel
       end
   
-    Cross.new(target,function)
+    Cross.new(target,function,raiseException)
   end
 #end
   
   
 class Observer
-  attr_accessor :ok
+  #attr_accessor :ok
+  attr_accessor :count
   def initialize(object,methodName)
     @methodName=methodName
     @object=object
-    @ok=false
+    #@ok=false
+    @count=0
   end
   def run
     method=@object.method(@methodName)
@@ -92,34 +97,56 @@
     object=@object
     @object.class.send(:define_method, at methodName) {|*s|
       if self==object
-        this.ok=true
+        #this.ok=true
+        this.count+=1
         puts "MUH"
       end
       method.call(*s)
     } 
     yield
     @object.class.send(:define_method, at methodName,method)
-    @ok
+    #@ok
+    called?
   end
   def isNotCalled
-     @ok==false
+    @count==0
+    # @ok==false
   end
   def isCalled
-    @ok==true
+    @count>0
+    #@ok==true
   end
+  def called?(count=0,sym=:times)
+    case sym
+      when :times
+        @count>count
+      else
+        raise "Unknown symbol"
+    end
+  end
 end  
 
 def observe(object,method,&block)
   observer=Observer.new(object,method)
   
   observer.run {block.call(observer)}
+  observer
 end
 
+class String
+  def camelCase
+    gsub(/(_[a-z])/) {|s|s[1..-1].upcase}
+  end
+end
+
 class Object
   def method_missing(name,*s)
     alt=name.to_s.gsub(/\?$/,"")
+    puts alt
     if respond_to?(alt) and alt!=name
       self.send(alt,*s)
+    elsif respond_to?(alt.camelCase) and alt!=name and alt.camelCase!=alt 
+      self.send(alt.camelCase,*s)
     else
       super
     end



From davidkamphausen at mail.berlios.de  Fri Jul 11 17:52:16 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Fri, 11 Jul 2008 17:52:16 +0200
Subject: [Antargis-svn] r1273 - in antargis/trunk: . rookey rookey/configs
	rookey/externals rookey/externals/swig rookey/externals/zlib
Message-ID: <200807111552.m6BFqGt1016980@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-11 17:52:14 +0200 (Fri, 11 Jul 2008)
New Revision: 1273

Added:
   antargis/trunk/rookey/configs/mingw.rb
   antargis/trunk/rookey/externals/tools.rb
   antargis/trunk/rookey/externals/zlib/
   antargis/trunk/rookey/externals/zlib/build.rb
Modified:
   antargis/trunk/Rakefile
   antargis/trunk/rookey/compile.rb
   antargis/trunk/rookey/config_generator.rb
   antargis/trunk/rookey/configs/gl.rb
   antargis/trunk/rookey/configs/png.rb
   antargis/trunk/rookey/configs/ruby.rb
   antargis/trunk/rookey/configs/swig.rb
   antargis/trunk/rookey/configs/z.rb
   antargis/trunk/rookey/externals/ext_config.rb
   antargis/trunk/rookey/externals/swig/build.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18

Modified: antargis/trunk/Rakefile
===================================================================
--- antargis/trunk/Rakefile	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/Rakefile	2008-07-11 15:52:14 UTC (rev 1273)
@@ -2,6 +2,8 @@
 
 $rspec=Rookey.checkedRequire('spec/rake/spectask')
 
+require 'rake/rdoctask.rb'
+
 # basic version
 
 inits=[
@@ -81,3 +83,14 @@
     sh "#{spec_cmd} #{run_file_name} --format html:spec_output.html --colour #{example}"
   end
 end
+
+
+Rake::RDocTask.new do |rd|
+   rd.main = "README"
+   rd.title="Battles of Antargis"
+   #rd.options << "--diagram"
+   rd.rdoc_dir="docs/ruby"
+   a=Dir["**/README"]+Dir["ruby/**/*.rb"]
+   a=a.select{|f|not (f=~/_test/ or f=~/spec/)}
+   rd.rdoc_files.include(a)
+end

Modified: antargis/trunk/rookey/compile.rb
===================================================================
--- antargis/trunk/rookey/compile.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/compile.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -134,11 +134,11 @@
     private
     def getCompiler(type)
        #FiXME
-       compiler= case type
+      compiler= case type
         when :cpp
-          "g++"
+          @config["CPP"]
         when :c
-          "gcc"
+          @config["CC"]
         else
           raise "Unknown compiler type #{type}"
       end
@@ -147,6 +147,10 @@
       compiler
     end
     
+    def findProgram(pattern)
+      
+    end
+    
     @@deps=nil
     def Compiler.parseDepsFiles
       return @@deps if @@deps

Modified: antargis/trunk/rookey/config_generator.rb
===================================================================
--- antargis/trunk/rookey/config_generator.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/config_generator.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -76,7 +76,9 @@
 	      getPath.map{|dir|
 	        
 	        p=File.join(dir,program)
+          list=Dir[p]
 	        p=nil unless File.exists?(p)
+          p||=list[0]
           p
 	      }
       }.flatten.uniq-[nil]
@@ -96,11 +98,16 @@
       compiler.compile(target,testSource)
       libadd="-l#{lib}"
       exeName=compiler.exeName("test")
-      compiler.linkEXE(exeName,[target,libadd])
-      `#{exeName}`
-      if $?
-        config.add("LDFLAGS",libadd)
+      begin
+        compiler.linkEXE(exeName,[target,libadd])
+        `#{exeName}`
+        if $?
+          config.add("LDFLAGS",libadd)
+        end
+      rescue RuntimeError => e
+        return false
       end
+      true
     end
     private
     def getPath
@@ -115,6 +122,11 @@
         p.split(":")
       end
     end
+    
+    def install(package)
+      #raise 1
+      ruby(File.join(File.split(__FILE__)[0],"externals","tools.rb"),package)
+    end    
   end
   
   Dir[File.join(File.split(__FILE__)[0],"configs","*.rb")].each{|file|
@@ -143,6 +155,7 @@
 	      unless run.member?(c)
 		      if c.needs.select{|s|not ok.member?(s)}.length == 0
 		        log "Running configurator #{c}"
+            #pp config
 		        c.new.run(config)
 		        ok+=c.provides
 		        ok.uniq!

Modified: antargis/trunk/rookey/configs/gl.rb
===================================================================
--- antargis/trunk/rookey/configs/gl.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/configs/gl.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -2,11 +2,12 @@
 require File.join(File.split(__FILE__)[0],"ruby.rb")
 
 module Rookey
-  class GLConfig<RubyConfig
+  class GLConfig<Configurator
     provides :opengl
+    needs :compiler
     
     def run(config)
-      case get("host_os")
+      case config["host_os"]
         when /darwin/
           config.add("INCLUDEDIRS","/usr/X11/include")        
           config.add("LDFLAGS","-Wl,-framework,OpenGL")

Added: antargis/trunk/rookey/configs/mingw.rb
===================================================================
--- antargis/trunk/rookey/configs/mingw.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/configs/mingw.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -0,0 +1,25 @@
+require 'mkmf'
+
+module Rookey
+  class MinGWConfig<Configurator
+    provides :compiler
+    
+    def run(config)
+      if ROOKEY_CONFIG[:extconfig]=='mingw32'
+	      #config.add("INCLUDEDIRS",get("archdir")+" "+get("includedir"))
+	      #config.add("CFLAGS",get("CFLAGS"))
+	      #config.add("LDFLAGS",get("LIBS"))
+	      #config.add("LDFLAGS",get("LIBRUBYARG"))
+	      #config.add("LDSHAREDFLAGS",get("LDSHARED").sub(/^[^ ]+ /,""))
+	      config["DLEXT"]="dll"
+	      config["host_os"]="win32"      
+	      config["GPP_BASE"]="i*mingw*g++"
+	      config["GCC_BASE"]="i*mingw*gcc"
+	
+	      {"CPP"=>"GPP_BASE","CC"=>"GCC_BASE"}.each{|name,base|      
+	        config[name]=searchProgram(config[base])
+	      }
+      end
+    end
+  end    
+end
\ No newline at end of file

Modified: antargis/trunk/rookey/configs/png.rb
===================================================================
--- antargis/trunk/rookey/configs/png.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/configs/png.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -2,7 +2,7 @@
 require File.join(File.split(__FILE__)[0],"ruby.rb")
 
 module Rookey
-  class PNGConfig<RubyConfig
+  class PNGConfig<Configurator
     provides :png
     needs :compiler
     needs :z

Modified: antargis/trunk/rookey/configs/ruby.rb
===================================================================
--- antargis/trunk/rookey/configs/ruby.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/configs/ruby.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -1,30 +1,38 @@
 require 'mkmf'
 
 module Rookey
-  class RubyConfig<Configurator
-    provides :compiler
-    
-    def run(config)
-      config.add("INCLUDEDIRS",get("archdir")+" "+get("includedir"))
-      config.add("CFLAGS",get("CFLAGS"))
-      config.add("LDFLAGS",get("LIBS"))
-      config.add("LDFLAGS",get("LIBRUBYARG"))
-      config.add("LDSHAREDFLAGS",get("LDSHARED").sub(/^[^ ]+ /,""))
-      config["DLEXT"]=get("DLEXT")
-      config["host_os"]=get("host_os")      
-    end
-    
-  private
-    # recurse through ruby's CONFIG structure 
-    def get(n)
-      return "" if n.nil?
-      v=CONFIG[n]
-      return "" if v.nil?
-      v.gsub(/\$\(([^)]*\))/) {|a|
-        f=a[2..-2]
-        get(f)
-      }      
-    end
-    
-  end
+  if ROOKEY_CONFIG[:use_mkmf]==true or ROOKEY_CONFIG[:use_mkmf].nil? 
+	  class RubyConfig<Configurator
+	    provides :compiler
+	    
+	    def run(config)
+		      config.add("INCLUDEDIRS",get("archdir")+" "+get("includedir"))
+		      config.add("CFLAGS",get("CFLAGS"))
+		      config.add("LDFLAGS",get("LIBS"))
+		      config.add("LDFLAGS",get("LIBRUBYARG"))
+		      config.add("LDSHAREDFLAGS",get("LDSHARED").sub(/^[^ ]+ /,""))
+		      config["DLEXT"]=get("DLEXT")
+		      config["host_os"]=get("host_os")      
+		      config["GPP_BASE"]="g++"
+		      config["GCC_BASE"]="gcc"
+		
+		      {"CPP"=>"GPP_BASE","CC"=>"GCC_BASE"}.each{|name,base|      
+		        config[name]=searchProgram(config[base])
+		      }
+	    end
+	    
+	  private
+	    # recurse through ruby's CONFIG structure 
+	    def get(n)
+	      return "" if n.nil?
+	      v=CONFIG[n]
+	      return "" if v.nil?
+	      v.gsub(/\$\(([^)]*\))/) {|a|
+	        f=a[2..-2]
+	        get(f)
+	      }      
+	    end
+	    
+	  end
+	end
 end
\ No newline at end of file

Modified: antargis/trunk/rookey/configs/swig.rb
===================================================================
--- antargis/trunk/rookey/configs/swig.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/configs/swig.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -8,7 +8,8 @@
       if swigs.length==0
         puts "ERROR: no SWIG with version in #{VERSIONS.join(", ")} not found!"
         if firstrun
-	        buildSwig
+	        #buildSwig
+          install("swig")
 	        run(config,false)
         end
       else
@@ -25,9 +26,9 @@
       output=`#{run}`
       VERSIONS.select{|v|output=~/#{v}/}.length>0
     end
-    def buildSwig
-      ruby File.join(File.split(__FILE__)[0],"..","externals","swig","build.rb")
-    end
+    #def buildSwig
+    #  ruby File.join(File.split(__FILE__)[0],"..","externals","swig","build.rb")
+    #end
     
   end
 end
\ No newline at end of file

Modified: antargis/trunk/rookey/configs/z.rb
===================================================================
--- antargis/trunk/rookey/configs/z.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/configs/z.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -2,12 +2,14 @@
 require File.join(File.split(__FILE__)[0],"ruby.rb")
 
 module Rookey
-  class ZConfig<RubyConfig
+  class ZConfig<Configurator
     provides :z
     needs :compiler
     
     def run(config)
-      checkLibrary(config,"z","compress")
+      unless checkLibrary(config,"z","compress")
+        install("zlib")
+      end
     end   
   end 
 end
\ No newline at end of file

Modified: antargis/trunk/rookey/externals/ext_config.rb
===================================================================
--- antargis/trunk/rookey/externals/ext_config.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/externals/ext_config.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -1,7 +1,96 @@
-$swigVersion="1.3.34"
-$swigDir=File.expand_path(File.join(File.split(__FILE__)[0],"swig","swig-#{$swigVersion}"))
-#$swigTarGz="#{$swigDir}.tar.gz"
-$swigTarGz="swig-#{$swigVersion}.tar.gz"
-$swigUrl="http://downloads.sourceforge.net/swig/"+$swigTarGz
+def getInstallTarget(name)
+  File.expand_path(File.join(File.split(__FILE__)[0],"built",name))
+end
 
-$swigTarget=File.expand_path(File.join(File.split(__FILE__)[0],"built","swig"))
+module PackageBase
+  def urlToFile(url)
+    url.gsub(/.*\//,"")
+  end
+  def fileToDir(file)
+    f=file
+    case f
+      when /zip$/i, /\.tgz$/i 
+        f[0..-5]
+      when /\.tar.gz$/i
+        f[0..-8]
+      when /\.tar.bz2$/i
+        f[0..-9]
+    end
+  end
+end
+
+$zliburl="http://somezliburl"
+class Package
+  attr_reader :url
+  attr_accessor :configureOptions
+  def initialize(url)
+    @url=url
+  end
+  def file
+    @url.gsub(/.*\//,"")
+  end
+  def dir
+    f=file
+    case f
+	    when /zip$/i, /\.tgz$/i 
+	      f[0..-5]
+      when /\.tar.gz$/i
+        f[0..-8]
+      when /\.tar.bz2$/i
+        f[0..-9]
+    end
+  end
+  def type
+    case file
+      when /zip$/i 
+        :zip
+      when /\.tar.gz$/i, /\.tgz$/i
+        :tarGZ
+      when /\.tar.bz2$/i
+        :tarBZ2
+    end
+  end
+  def install
+    download(url)
+    unzipTar(file)
+    build(dir,configureOptions)
+  end    
+end
+
+class BinPackage
+  include PackageBase
+  def initialize(binurl,devurl)
+    @binurl=binurl
+    @devurl=devurl
+  end
+  def install
+    odir=Dir.pwd
+    begin
+      Dir.mkdir("build")
+    rescue
+    end
+    Dir.chdir("build")
+    [@binurl, at devurl].each{|url|
+      download(url)
+      file=urlToFile(url)
+      unzipTar(file)
+      dir=fileToDir(file)
+      puts dir
+    }
+    Dir.chdir(odir)
+  end
+end
+
+def externalPackages
+	pkgs={
+	  "swig"=>Package.new("http://downloads.sourceforge.net/swig/swig-1.3.36.tar.gz"),
+	  #"zlib"=>Package.new("http://downloads.sourceforge.net/swig/swig-1.3.34.tar.gz"),
+    "zlib"=>BinPackage.new("http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-bin.zip","http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-lib.zip")
+	}
+  # exclude other scripting langs for swig
+  pkgs["swig"].configureOptions=["python","ocaml","php4","chicken","csharp","csharp",
+    "guilescm","java","mzscheme","perl5","pike","tcl","lua","allegrocl","clisp","r"].map{|f|"--without-#{f}"}.join(" ")
+  pkgs
+end
+
+

Modified: antargis/trunk/rookey/externals/swig/build.rb
===================================================================
--- antargis/trunk/rookey/externals/swig/build.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/externals/swig/build.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -1,40 +1,8 @@
 require 'ftools'
 require File.join(File.split(__FILE__)[0],"..","ext_config.rb")
+require File.join(File.split(__FILE__)[0],"..","tools.rb")
 
-alias :oldSystem :system 
-def system(x)
-  puts x
-  oldSystem(x)
-end
-  
 
-def getFilenameFromUrl(url)
-  url.gsub(/.*\//,"")
-end
-
-def download(url)
-  filename=getFilenameFromUrl(url)
-  if File.exists?(filename)
-    puts "File #{filename} already exists - so not downloading!"
-    return
-  end
-  puts "Downloading from #{url}..."
-  call="wget -O '#{filename}.tmp' '#{url}'"
-  system call
-  File.move(filename+".tmp",filename)
-  return
-end
-
-def unzipTar(file)
-  puts "Unzipping #{file}"
-  if file=~/tar.gz$/
-    system("tar xvfz #{file} >/dev/null")
-  else
-    system("unzip #{file}")
-  end
-  puts "Ready."
-end
-
 def buildSwig(dir,swigTarget)
   curDir=Dir.pwd
   Dir.chdir(dir)
@@ -47,4 +15,4 @@
 
 download($swigUrl)
 unzipTar($swigTarGz)
-buildSwig($swigDir,$swigTarget)
+buildSwig($swigDir,getBuildTarget("swig"))

Added: antargis/trunk/rookey/externals/tools.rb
===================================================================
--- antargis/trunk/rookey/externals/tools.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/externals/tools.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -0,0 +1,68 @@
+require File.join(File.split(__FILE__)[0],"ext_config.rb")
+require 'ftools'
+
+alias :oldSystem :system 
+def system(x)
+  puts x
+  oldSystem(x)
+end
+  
+
+def getFilenameFromUrl(url)
+  url.gsub(/.*\//,"")
+end
+
+def download(url)
+  filename=getFilenameFromUrl(url)
+  if File.exists?(filename)
+    puts "File #{filename} already exists - so not downloading!"
+    return
+  end
+  puts "Downloading from #{url}..."
+  call="wget -O '#{filename}.tmp' '#{url}'"
+  system call
+  File.move(filename+".tmp",filename)
+  return
+end
+
+def unzipTar(file)
+  puts "Unzipping #{file}"
+  if file=~/tar.gz$/
+    system("tar xvfz #{file} >/dev/null")
+  elsif file=~/tar.bz2$/
+    system("tar xvfj #{file} >/dev/null")
+  else
+    system("unzip #{file}")
+  end
+  puts "Ready."
+end
+
+def setEnv
+  pp $tempConfig
+end
+
+def msh(a)
+  puts a
+  system a
+end
+
+def build(dir,configureOptions)
+  olddir=Dir.pwd
+
+  Dir.chdir(dir)
+  
+  msh "./configure --prefix=#{File.join(olddir,"build")} #{configureOptions}"
+  msh "make"
+  msh "make install"
+
+  Dir.chdir(olddir)
+end
+
+def buildExternal(name)
+  Dir.chdir(File.split(__FILE__)[0])
+  puts name
+  pkg=externalPackages[name]
+  pkg.install
+end
+
+buildExternal(ARGV[0])
\ No newline at end of file

Added: antargis/trunk/rookey/externals/zlib/build.rb
===================================================================
--- antargis/trunk/rookey/externals/zlib/build.rb	2008-07-10 19:16:05 UTC (rev 1272)
+++ antargis/trunk/rookey/externals/zlib/build.rb	2008-07-11 15:52:14 UTC (rev 1273)
@@ -0,0 +1,17 @@
+require 'ftools'
+require File.join(File.split(__FILE__)[0],"..","ext_config.rb")
+require File.join(File.split(__FILE__)[0],"..","tools.rb")
+
+def buildZ(dir,swigTarget)
+  curDir=Dir.pwd
+  Dir.chdir(dir)
+  setEnv
+  system "./configure --prefix=#{target}"
+  system "make"
+  system "make install"
+end
+
+
+download($zlibUrl)
+unzipTar($zlibTGZ)
+buildZ($zlibDir,getBuildDir("zlib"))
\ No newline at end of file



From davidkamphausen at mail.berlios.de  Sun Jul 13 08:30:53 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sun, 13 Jul 2008 08:30:53 +0200
Subject: [Antargis-svn] r1274 - in antargis/trunk/ext: 3dengine video
Message-ID: <200807130630.m6D6Urmu019969@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-13 08:30:44 +0200 (Sun, 13 Jul 2008)
New Revision: 1274

Modified:
   antargis/trunk/ext/3dengine/ant_renderer.cc
   antargis/trunk/ext/video/ag_glscreen.cc
Log:
* fixes for linux


Modified: antargis/trunk/ext/3dengine/ant_renderer.cc
===================================================================
--- antargis/trunk/ext/3dengine/ant_renderer.cc	2008-07-11 15:52:14 UTC (rev 1273)
+++ antargis/trunk/ext/3dengine/ant_renderer.cc	2008-07-13 06:30:44 UTC (rev 1274)
@@ -89,7 +89,7 @@
 GLint Renderer::getShadowUnit()
   {
     assert(canMultitexture());
-    return 3;
+    return 1;
   }
 GLint Renderer::getNormalUnit()
   {
@@ -207,7 +207,10 @@
 
 void Renderer::beginShadowDrawing()
   {
+    assertGL;
     glActiveTexture(getShadowUnit());
+    cdebug(getShadowUnit());
+    assertGL;
 
     glMatrixMode(GL_MODELVIEW);
     // draw a flat shadow over 

Modified: antargis/trunk/ext/video/ag_glscreen.cc
===================================================================
--- antargis/trunk/ext/video/ag_glscreen.cc	2008-07-11 15:52:14 UTC (rev 1273)
+++ antargis/trunk/ext/video/ag_glscreen.cc	2008-07-13 06:30:44 UTC (rev 1274)
@@ -177,6 +177,7 @@
       glReadBuffer(GL_BACK);
 
     assertGL;
+#ifdef __APPLE__
     glTexParameteri(glTexture->getTarget(), 
         GL_TEXTURE_STORAGE_HINT_APPLE, 
         GL_STORAGE_CACHED_APPLE); 
@@ -184,11 +185,10 @@
     glPixelStorei(GL_UNPACK_CLIENT_STORAGE_APPLE,GL_TRUE); 
     assertGL;
 
-
     glTexParameteri(glTexture->getTarget(),GL_TEXTURE_STORAGE_HINT_APPLE, GL_STORAGE_SHARED_APPLE); 
     assertGL;
     glPixelStorei(GL_UNPACK_CLIENT_STORAGE_APPLE,GL_TRUE); 
-
+#endif
     assertGL;
     glReadBuffer(GL_FRONT_LEFT);
     glFinish();



From davidkamphausen at mail.berlios.de  Sun Jul 13 14:58:28 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sun, 13 Jul 2008 14:58:28 +0200
Subject: [Antargis-svn] r1275 - in antargis/trunk: . rookey rookey/configs
	rookey/externals
Message-ID: <200807131258.m6DCwSts022155@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-13 14:58:27 +0200 (Sun, 13 Jul 2008)
New Revision: 1275

Modified:
   antargis/trunk/.cproject
   antargis/trunk/rookey/config_generator.rb
   antargis/trunk/rookey/configs/gl.rb
   antargis/trunk/rookey/configs/mingw.rb
   antargis/trunk/rookey/configs/sdl.rb
   antargis/trunk/rookey/configs/z.rb
   antargis/trunk/rookey/externals/ext_config.rb
   antargis/trunk/rookey/externals/tools.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18

Modified: antargis/trunk/.cproject
===================================================================
--- antargis/trunk/.cproject	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/.cproject	2008-07-13 12:58:27 UTC (rev 1275)
@@ -63,7 +63,7 @@
 </toolChain>
 </folderInfo>
 <sourceEntries>
-<entry excluding=".deps|.build_darwin9.0|.build_darwin9.0/antargis_swig.cc|build/|.build_/|.settings/|antargis.xcodeproj/|coverage/|packages/" flags="VALUE_WORKSPACE_PATH" kind="sourcePath" name=""/>
+<entry excluding=".build_win32|.deps/**|.build_darwin9.0|.build_darwin9.0/antargis_swig.cc|build/|.build_/|.settings/|antargis.xcodeproj/|coverage/|packages/" flags="VALUE_WORKSPACE_PATH" kind="sourcePath" name=""/>
 </sourceEntries>
 </configuration>
 </storageModule>

Modified: antargis/trunk/rookey/config_generator.rb
===================================================================
--- antargis/trunk/rookey/config_generator.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/config_generator.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -66,6 +66,10 @@
     def run(config)
     end
     
+    def installLibDir
+      File.join(File.split(__FILE__)[0],"externals","build","lib")
+    end
+    
     def searchProgram(program)
       searchPrograms(program)[0]
     end

Modified: antargis/trunk/rookey/configs/gl.rb
===================================================================
--- antargis/trunk/rookey/configs/gl.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/configs/gl.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -11,6 +11,9 @@
         when /darwin/
           config.add("INCLUDEDIRS","/usr/X11/include")        
           config.add("LDFLAGS","-Wl,-framework,OpenGL")
+        when /win32/
+          config.add("INCLUDEDIRS","/usr/X11/include")        
+          config.add("LDFLAGS","-lopengl32 -lglu32")
         else
           config.add("LDFLAGS","-lGL -lGLU")
       end      

Modified: antargis/trunk/rookey/configs/mingw.rb
===================================================================
--- antargis/trunk/rookey/configs/mingw.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/configs/mingw.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -19,6 +19,13 @@
 	      {"CPP"=>"GPP_BASE","CC"=>"GCC_BASE"}.each{|name,base|      
 	        config[name]=searchProgram(config[base])
 	      }
+        base=config["CPP"].gsub(/bin\/[^\/]+/,"")
+        baseMingw=Dir[base+"i*mingw*"]
+        config.add("LDFLAGS","-L"+File.join(baseMingw,"lib"))
+        config.add("LDFLAGS","-L"+installLibDir)
+        config.add("INCLUDEDIRS",File.join(baseMingw,"include"))
+        #pp config
+        #exit
       end
     end
   end    

Modified: antargis/trunk/rookey/configs/sdl.rb
===================================================================
--- antargis/trunk/rookey/configs/sdl.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/configs/sdl.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -7,12 +7,17 @@
       # FIXME
       sdlconfig="sdl-config"
       
-      cflags=`#{sdlconfig} --cflags`.chomp
-      config.add("CFLAGS",cflags.split(" ").select{|f|not f=~/^-I/}.join(" "))
-      config.add("INCLUDEDIRS",cflags.split(" ").select{|f|f=~/^-I/}.map{|f|f[2..-1]}.join(" "))
-      config.add("LDFLAGS",`sdl-config --libs`.chomp)
+      pp config
+      if config["host_os"]!="win32"
+	      cflags=`#{sdlconfig} --cflags`.chomp
+	      config.add("CFLAGS",cflags.split(" ").select{|f|not f=~/^-I/}.join(" "))
+	      config.add("INCLUDEDIRS",cflags.split(" ").select{|f|f=~/^-I/}.map{|f|f[2..-1]}.join(" "))
+	      config.add("LDFLAGS",`sdl-config --libs`.chomp)
+      else
+        ["sdl","sdl_image","sdl_ttf"].each{|lib|install(lib)}
+        
+      end      
       
-      
       checkLibrary(config,"SDL_image","IMG_Load")
       checkLibrary(config,"SDL_ttf","TTF_Quit")
       checkLibrary(config,"SDL_mixer","Mix_LoadMus")

Modified: antargis/trunk/rookey/configs/z.rb
===================================================================
--- antargis/trunk/rookey/configs/z.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/configs/z.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -9,6 +9,9 @@
     def run(config)
       unless checkLibrary(config,"z","compress")
         install("zlib")
+        puts "ARG"
+        config.add("LDFLAGS","-L"+installLibDir)
+        checkLibrary(config,"z","compress")
       end
     end   
   end 

Modified: antargis/trunk/rookey/externals/ext_config.rb
===================================================================
--- antargis/trunk/rookey/externals/ext_config.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/externals/ext_config.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -22,9 +22,10 @@
 $zliburl="http://somezliburl"
 class Package
   attr_reader :url
-  attr_accessor :configureOptions
+  attr_accessor :configureOptions, :local
   def initialize(url)
     @url=url
+    @local=false
   end
   def file
     @url.gsub(/.*\//,"")
@@ -71,12 +72,25 @@
     end
     Dir.chdir("build")
     [@binurl, at devurl].each{|url|
-      download(url)
-      file=urlToFile(url)
-      unzipTar(file)
-      dir=fileToDir(file)
-      puts dir
+      if url
+	      download(url)
+	      file=urlToFile(url)
+	      unzipTar(file)
+	      dir=fileToDir(file)
+	      puts dir
+        
+        strangers=Dir["*"].select{|f|f=~/^[A-Z].*/}.select{|f|File.directory?(f)}
+        strangers.each{|d|
+          ["include","lib","bin"].each{|md|
+            Dir[File.join(d,md,"*")].each{|f|File.mv(f,File.join(md,File.split(f)[1]))}
+          }
+          #Dir.delete!(d)
+        }
+        
+        
+      end
     }
+    Dir["*.dll"].each{|f|File.move(f,File.join("lib",f))}
     Dir.chdir(odir)
   end
 end
@@ -84,12 +98,15 @@
 def externalPackages
 	pkgs={
 	  "swig"=>Package.new("http://downloads.sourceforge.net/swig/swig-1.3.36.tar.gz"),
-	  #"zlib"=>Package.new("http://downloads.sourceforge.net/swig/swig-1.3.34.tar.gz"),
-    "zlib"=>BinPackage.new("http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-bin.zip","http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-lib.zip")
+    "zlib"=>BinPackage.new("http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-bin.zip","http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-lib.zip"),
+    "sdl"=>BinPackage.new("http://libsdl.org/release/SDL-1.2.13-win32.zip","http://libsdl.org/release/SDL-devel-1.2.13-mingw32.tar.gz"),
+    "sdl_image"=>BinPackage.new("http://www.libsdl.org/projects/SDL_image/release/SDL_image-1.2.6-win32.zip","http://www.libsdl.org/projects/SDL_image/release/SDL_image-devel-1.2.6-VC8.zip"),
+    "sdl_ttf"=>BinPackage.new("http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-2.0.9-win32.zip","http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-2.0.9-VC8.zip")
 	}
   # exclude other scripting langs for swig
   pkgs["swig"].configureOptions=["python","ocaml","php4","chicken","csharp","csharp",
     "guilescm","java","mzscheme","perl5","pike","tcl","lua","allegrocl","clisp","r"].map{|f|"--without-#{f}"}.join(" ")
+  pkgs["swig"].local=true
   pkgs
 end
 

Modified: antargis/trunk/rookey/externals/tools.rb
===================================================================
--- antargis/trunk/rookey/externals/tools.rb	2008-07-13 06:30:44 UTC (rev 1274)
+++ antargis/trunk/rookey/externals/tools.rb	2008-07-13 12:58:27 UTC (rev 1275)
@@ -32,7 +32,7 @@
   elsif file=~/tar.bz2$/
     system("tar xvfj #{file} >/dev/null")
   else
-    system("unzip #{file}")
+    system("unzip -o #{file}")
   end
   puts "Ready."
 end



From davidkamphausen at mail.berlios.de  Sun Jul 13 15:04:35 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sun, 13 Jul 2008 15:04:35 +0200
Subject: [Antargis-svn] r1276 - antargis/trunk/rookey/externals
Message-ID: <200807131304.m6DD4ZI8023243@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-13 15:04:34 +0200 (Sun, 13 Jul 2008)
New Revision: 1276

Modified:
   antargis/trunk/rookey/externals/
   antargis/trunk/rookey/externals/ext_config.rb
Log:



Property changes on: antargis/trunk/rookey/externals
___________________________________________________________________
Name: svn:ignore
   + build


Modified: antargis/trunk/rookey/externals/ext_config.rb
===================================================================
--- antargis/trunk/rookey/externals/ext_config.rb	2008-07-13 12:58:27 UTC (rev 1275)
+++ antargis/trunk/rookey/externals/ext_config.rb	2008-07-13 13:04:34 UTC (rev 1276)
@@ -101,7 +101,8 @@
     "zlib"=>BinPackage.new("http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-bin.zip","http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-lib.zip"),
     "sdl"=>BinPackage.new("http://libsdl.org/release/SDL-1.2.13-win32.zip","http://libsdl.org/release/SDL-devel-1.2.13-mingw32.tar.gz"),
     "sdl_image"=>BinPackage.new("http://www.libsdl.org/projects/SDL_image/release/SDL_image-1.2.6-win32.zip","http://www.libsdl.org/projects/SDL_image/release/SDL_image-devel-1.2.6-VC8.zip"),
-    "sdl_ttf"=>BinPackage.new("http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-2.0.9-win32.zip","http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-2.0.9-VC8.zip")
+    "sdl_ttf"=>BinPackage.new("http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-2.0.9-win32.zip","http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-2.0.9-VC8.zip"),
+    "sdl_mixer"=>BinPackage.new("http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-1.2.8-win32.zip","http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.8-VC8.zip")
 	}
   # exclude other scripting langs for swig
   pkgs["swig"].configureOptions=["python","ocaml","php4","chicken","csharp","csharp",



From davidkamphausen at mail.berlios.de  Sun Jul 13 15:23:45 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sun, 13 Jul 2008 15:23:45 +0200
Subject: [Antargis-svn] r1277 - in antargis/trunk/rookey: configs externals
Message-ID: <200807131323.m6DDNj76024934@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-13 15:23:44 +0200 (Sun, 13 Jul 2008)
New Revision: 1277

Modified:
   antargis/trunk/rookey/configs/png.rb
   antargis/trunk/rookey/configs/sdl.rb
   antargis/trunk/rookey/externals/ext_config.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18

Modified: antargis/trunk/rookey/configs/png.rb
===================================================================
--- antargis/trunk/rookey/configs/png.rb	2008-07-13 13:04:34 UTC (rev 1276)
+++ antargis/trunk/rookey/configs/png.rb	2008-07-13 13:23:44 UTC (rev 1277)
@@ -8,7 +8,10 @@
     needs :z
         
     def run(config)
-      checkLibrary(config,"png","png_get_io_ptr")
+      unless checkLibrary(config,"png","png_get_io_ptr")
+        install("png")
+        checkLibrary(config,"png","png_get_io_ptr")
+      end
     end   
   end 
 end
\ No newline at end of file

Modified: antargis/trunk/rookey/configs/sdl.rb
===================================================================
--- antargis/trunk/rookey/configs/sdl.rb	2008-07-13 13:04:34 UTC (rev 1276)
+++ antargis/trunk/rookey/configs/sdl.rb	2008-07-13 13:23:44 UTC (rev 1277)
@@ -14,7 +14,7 @@
 	      config.add("INCLUDEDIRS",cflags.split(" ").select{|f|f=~/^-I/}.map{|f|f[2..-1]}.join(" "))
 	      config.add("LDFLAGS",`sdl-config --libs`.chomp)
       else
-        ["sdl","sdl_image","sdl_ttf"].each{|lib|install(lib)}
+        ["sdl","sdl_image","sdl_ttf","sdl_mixer"].each{|lib|install(lib)}
         
       end      
       

Modified: antargis/trunk/rookey/externals/ext_config.rb
===================================================================
--- antargis/trunk/rookey/externals/ext_config.rb	2008-07-13 13:04:34 UTC (rev 1276)
+++ antargis/trunk/rookey/externals/ext_config.rb	2008-07-13 13:23:44 UTC (rev 1277)
@@ -102,7 +102,8 @@
     "sdl"=>BinPackage.new("http://libsdl.org/release/SDL-1.2.13-win32.zip","http://libsdl.org/release/SDL-devel-1.2.13-mingw32.tar.gz"),
     "sdl_image"=>BinPackage.new("http://www.libsdl.org/projects/SDL_image/release/SDL_image-1.2.6-win32.zip","http://www.libsdl.org/projects/SDL_image/release/SDL_image-devel-1.2.6-VC8.zip"),
     "sdl_ttf"=>BinPackage.new("http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-2.0.9-win32.zip","http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-2.0.9-VC8.zip"),
-    "sdl_mixer"=>BinPackage.new("http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-1.2.8-win32.zip","http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.8-VC8.zip")
+    "sdl_mixer"=>BinPackage.new("http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-1.2.8-win32.zip","http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.8-VC8.zip"),
+    "png"=>BinPackage.new("http://gnuwin32.sourceforge.net/downlinks/libpng-bin-zip.php","http://gnuwin32.sourceforge.net/downlinks/libpng-lib-zip.php")
 	}
   # exclude other scripting langs for swig
   pkgs["swig"].configureOptions=["python","ocaml","php4","chicken","csharp","csharp",



From davidkamphausen at mail.berlios.de  Sun Jul 13 15:31:39 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sun, 13 Jul 2008 15:31:39 +0200
Subject: [Antargis-svn] r1278 - in antargis/trunk/rookey: . configs
Message-ID: <200807131331.m6DDVdJS025787@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-13 15:31:38 +0200 (Sun, 13 Jul 2008)
New Revision: 1278

Modified:
   antargis/trunk/rookey/compile.rb
   antargis/trunk/rookey/config_generator.rb
   antargis/trunk/rookey/configs/mingw.rb
   antargis/trunk/rookey/configs/sdl.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18

Modified: antargis/trunk/rookey/compile.rb
===================================================================
--- antargis/trunk/rookey/compile.rb	2008-07-13 13:23:44 UTC (rev 1277)
+++ antargis/trunk/rookey/compile.rb	2008-07-13 13:31:38 UTC (rev 1278)
@@ -25,6 +25,8 @@
 	    
 	    options=[]
 	
+      pp @config
+      
 	    options << @config["CFLAGS"]
 	    
 	    includeDirs = @config["INCLUDEDIRS"].split(" ")

Modified: antargis/trunk/rookey/config_generator.rb
===================================================================
--- antargis/trunk/rookey/config_generator.rb	2008-07-13 13:23:44 UTC (rev 1277)
+++ antargis/trunk/rookey/config_generator.rb	2008-07-13 13:31:38 UTC (rev 1278)
@@ -69,6 +69,9 @@
     def installLibDir
       File.join(File.split(__FILE__)[0],"externals","build","lib")
     end
+    def installIncludeDir
+      File.join(File.split(__FILE__)[0],"externals","build","include")
+    end
     
     def searchProgram(program)
       searchPrograms(program)[0]
@@ -168,6 +171,7 @@
 	      end
 	    }
     end
+    pp config
     puts
     @@config=config
   end

Modified: antargis/trunk/rookey/configs/mingw.rb
===================================================================
--- antargis/trunk/rookey/configs/mingw.rb	2008-07-13 13:23:44 UTC (rev 1277)
+++ antargis/trunk/rookey/configs/mingw.rb	2008-07-13 13:31:38 UTC (rev 1278)
@@ -24,6 +24,9 @@
         config.add("LDFLAGS","-L"+File.join(baseMingw,"lib"))
         config.add("LDFLAGS","-L"+installLibDir)
         config.add("INCLUDEDIRS",File.join(baseMingw,"include"))
+        config.add("INCLUDEDIRS",installIncludeDir)
+        
+        
         #pp config
         #exit
       end

Modified: antargis/trunk/rookey/configs/sdl.rb
===================================================================
--- antargis/trunk/rookey/configs/sdl.rb	2008-07-13 13:23:44 UTC (rev 1277)
+++ antargis/trunk/rookey/configs/sdl.rb	2008-07-13 13:31:38 UTC (rev 1278)
@@ -15,6 +15,7 @@
 	      config.add("LDFLAGS",`sdl-config --libs`.chomp)
       else
         ["sdl","sdl_image","sdl_ttf","sdl_mixer"].each{|lib|install(lib)}
+        config.add("INCLUDEDIRS",File.join(installIncludeDir,"SDL"))
         
       end      
       



From davidkamphausen at mail.berlios.de  Thu Jul 17 21:39:19 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Thu, 17 Jul 2008 21:39:19 +0200
Subject: [Antargis-svn] r1279 - in antargis/trunk: . data/gui ext/3dengine
	ext/video rookey rookey/configs rookey/externals
	rookey/maintainenance ruby ruby/spec
Message-ID: <200807171939.m6HJdJdf015947@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-17 21:39:17 +0200 (Thu, 17 Jul 2008)
New Revision: 1279

Added:
   antargis/trunk/AUTHORS
   antargis/trunk/data/gui/antargis.icns
   antargis/trunk/rookey/config_class.rb
   antargis/trunk/rookey/maintainenance/
   antargis/trunk/rookey/maintainenance/Rakefile
   antargis/trunk/ruby/spec/spec_files.rb
Modified:
   antargis/trunk/ext/3dengine/ag_glsl.cc
   antargis/trunk/ext/video/ag_gl.h
   antargis/trunk/rookey/config_generator.rb
   antargis/trunk/rookey/configs/gl.rb
   antargis/trunk/rookey/configs/ruby.rb
   antargis/trunk/rookey/externals/
   antargis/trunk/rookey/tasks.rb
   antargis/trunk/ruby/antargislib.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18

Added: antargis/trunk/AUTHORS
===================================================================
--- antargis/trunk/AUTHORS	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/AUTHORS	2008-07-17 19:39:17 UTC (rev 1279)
@@ -0,0 +1,42 @@
+development & art:
+David Kamphausen <david.kamphausen at web.de>
+
+contributors:
+Yura Semashko (Yurand) <yurand at land.ru>
+Alexandru Lazar (std) <std at cwazy.co.uk>
+Toby Haynes (Nexus6)
+Chris Smith (Sparky)
+Andreas Bresser (Pscho)
+
+Story:
+David Kamphausen (Godrin)
+Gonzalo Baltan?s (Nerian)
+Alexandru Lazar
+
+Translators:
+Gonzalo Baltan?s (Nerian)
+
+Music & Sounds:
+Mr.Maudaline
+
+Arts:
+Jason Lutes (portraits from Wesnoth)
+
+
+For more information on contributors or so have a look at the "People" page in the wiki:
+http://antargis.berlios.de/wiki/index.php/People
+
+some images were taken/inspired from the wesnoth-project (www.wesnoth.org)
+some authors are:
+Copyright (C) 2003,2004,2005 David White
+Copyright (C) 2005 Guillaume Melquiond
+Copyright (C) 2005 Philippe Plantier
+Copyright (C) 2005 Yann Dirson
+Copyright (C) 2005 Isaac Clerencia
+
+For more authors of images please have a look at their website.
+
+The gui/src/sge* files were taken from libSGE. Have a look at these files or at http://www.etek.chalmers.se/~e8cal1/sge/ for AUTHOR's information.
+LibSGE is published under LGPL, which corresponds to AntargisGUILib.
+
+The files under gui/src/mtwist are licensed under LGPL and are copyrighted to Geoff Kuenning. Download the sources from http://lasr.cs.ucla.edu/geoff/mtwist.html#downloading.
\ No newline at end of file

Added: antargis/trunk/data/gui/antargis.icns
===================================================================
(Binary files differ)


Property changes on: antargis/trunk/data/gui/antargis.icns
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: antargis/trunk/ext/3dengine/ag_glsl.cc
===================================================================
--- antargis/trunk/ext/3dengine/ag_glsl.cc	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/ext/3dengine/ag_glsl.cc	2008-07-17 19:39:17 UTC (rev 1279)
@@ -1,3 +1,4 @@
+#include "ag_gl.h"
 #include "ag_glsl.h"
 #include "ag_vdebug.h"
 #include "ag_main.h"

Modified: antargis/trunk/ext/video/ag_gl.h
===================================================================
--- antargis/trunk/ext/video/ag_gl.h	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/ext/video/ag_gl.h	2008-07-17 19:39:17 UTC (rev 1279)
@@ -3,10 +3,12 @@
 
 #include <GLee.h>
 
+#ifdef __APPLE__
 // patch for mac os
 #ifdef GL_GLEXT_VERSION
 #undef GL_GLEXT_VERSION
 #endif
+#endif
 
 #include <SDL_opengl.h>
 #include <GL/glu.h>

Added: antargis/trunk/rookey/config_class.rb
===================================================================
--- antargis/trunk/rookey/config_class.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/rookey/config_class.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -0,0 +1,33 @@
+module Rookey
+  
+  # Rookeys Config-hash. 
+  class Config
+    def initialize(hash={})
+      @hash=hash
+    end
+    def [](name)
+      @hash[name]||""
+    end
+    def []=(name,value)
+      @hash[name]=value
+    end
+    def add(name,value)
+      @hash[name]||=""
+      @hash[name]+=" "+value
+    end
+  end
+  @@config=nil
+  
+  def Rookey.getConfig
+    if @@config.nil?
+      if File.exists?(Rookey::CONFIG_FILENAME)
+        load Rookey::CONFIG_FILENAME
+      else 
+        runConfigure
+        hibe(@@config,Rookey::CONFIG_FILENAME)
+      end
+      CLEAN << Rookey::CONFIG_FILENAME
+    end
+    @@config
+  end 
+end
\ No newline at end of file

Modified: antargis/trunk/rookey/config_generator.rb
===================================================================
--- antargis/trunk/rookey/config_generator.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/rookey/config_generator.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -1,4 +1,6 @@
 
+require File.join(File.split(__FILE__)[0],'config_class.rb')
+
 class Class
   def provides(s=nil)
     @provides||=[]
@@ -14,40 +16,10 @@
 
 module Rookey
   
-  # Rookeys Config-hash. 
-  class Config
-    def initialize(hash={})
-      @hash=hash
-    end
-    def [](name)
-      @hash[name]||""
-    end
-    def []=(name,value)
-      @hash[name]=value
-    end
-    def add(name,value)
-      @hash[name]||=""
-      @hash[name]+=" "+value
-    end
-  end
   
   CONFIG_FILENAME="config_cache.rb"
   
-  @@config=nil
   
-  def Rookey.getConfig
-    if @@config.nil?
-      if File.exists?(Rookey::CONFIG_FILENAME)
-        load Rookey::CONFIG_FILENAME
-	    else 
-	      runConfigure
-        hibe(@@config,Rookey::CONFIG_FILENAME)
-	    end
-      CLEAN << Rookey::CONFIG_FILENAME
-    end
-    @@config
-  end 
-  
   # stores a dumpable ruby-object *what* into a file named *filename*
   def Rookey.hibe(what,filename)
     content=Marshal.dump(what).gsub("\"","\\\"")

Modified: antargis/trunk/rookey/configs/gl.rb
===================================================================
--- antargis/trunk/rookey/configs/gl.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/rookey/configs/gl.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -12,7 +12,7 @@
           config.add("INCLUDEDIRS","/usr/X11/include")        
           config.add("LDFLAGS","-Wl,-framework,OpenGL")
         when /win32/
-          config.add("INCLUDEDIRS","/usr/X11/include")        
+          #config.add("INCLUDEDIRS","/usr/X11/include")        
           config.add("LDFLAGS","-lopengl32 -lglu32")
         else
           config.add("LDFLAGS","-lGL -lGLU")

Modified: antargis/trunk/rookey/configs/ruby.rb
===================================================================
--- antargis/trunk/rookey/configs/ruby.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/rookey/configs/ruby.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -19,6 +19,9 @@
 		      {"CPP"=>"GPP_BASE","CC"=>"GCC_BASE"}.each{|name,base|      
 		        config[name]=searchProgram(config[base])
 		      }
+          
+          config.add("CFLAGS","-pg") if ROOKEY_CONFIG[:profile]
+          config.add("LDFLAGS","-pg") if ROOKEY_CONFIG[:profile]
 	    end
 	    
 	  private


Property changes on: antargis/trunk/rookey/externals
___________________________________________________________________
Name: svn:ignore
   - build

   + build
swig-*
temp


Added: antargis/trunk/rookey/maintainenance/Rakefile
===================================================================
--- antargis/trunk/rookey/maintainenance/Rakefile	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/rookey/maintainenance/Rakefile	2008-07-17 19:39:17 UTC (rev 1279)
@@ -0,0 +1,196 @@
+require 'ostruct'
+require 'ftools'
+
+alias :oldSystem :system
+def system(s)
+  puts s
+  oldSystem(s)
+end
+
+  
+
+class RookeyDist
+  def initialize(config)
+    @config=config
+
+    @baseDir=Dir.pwd
+    
+    @distDir=File.join(@baseDir,"packages")
+  end
+
+  def distDarwin
+    sDir=sourceDir
+    sDir=sDir[0..0].upcase+sDir[1..-1]
+    
+    mkdir(sDir)
+    
+    aDir=File.join(sDir,sDir+".app")
+
+    mkdir(aDir)
+    cDir=File.join(aDir,"Contents")
+    mkdir(cDir)
+    mDir=File.join(cDir,"MacOS")
+    mkdir(mDir)
+    rDir=File.join(cDir,"Resources")
+    mkdir(rDir)
+    
+    cp("../../antargis.bundle",mDir)
+    cp("../../antargis",mDir)
+    cp("../../data/gui/antargis.icns",rDir)
+    File.copy("../../data/gui/antargis.icns",File.join(sDir,".VolumeIcon.icns"))
+#    File.copy("/Volumes/Firefox/.VolumeIcon.icns",File.join(sDir,".VolumeIcon.icns"))
+    
+    f=File.open(File.join(cDir,"PkgInfo"),"w")
+    f.puts("APPL????")
+    f.close
+    
+    
+    f=File.open(File.join(cDir,"Info.plist"),"w")
+f.puts '<?xml version="1.0" encoding="UTF-8"?>
+    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
+    <plist version="1.0">
+    <dict>
+      <key>CFBundleDevelopmentRegion</key>
+      <string>English</string>
+      <key>CFBundleExecutable</key>
+      <string>antargis</string>
+      <key>CFBundleIdentifier</key>
+      <string>com.apple.rubycocoa.testRubyApp</string>
+      <key>CFBundleInfoDictionaryVersion</key>
+      <string>6.0</string>
+      <key>CFBundlePackageType</key>
+      <string>APPL</string>
+      <key>CFBundleShortVersionString</key>
+      <string>1.0</string>
+      <key>CFBundleSignature</key>
+      <string>????</string>
+      <key>CFBundleVersion</key>
+      <string>1.0</string>
+      <key>NSMainNibFile</key>
+      <string>MainMenu</string>
+      <key>NSPrincipalClass</key>
+      <string>NSApplication</string>
+      <key>CFBundleIconFile</key>
+      <string>antargis.icns</string>
+    </dict>
+    </plist>'
+f.close
+
+		system "cp -R ../../data "+mDir
+		system "cp -R ../../antargisStarter.rb "+mDir
+		system "cp -R ../../ruby "+mDir
+		system "find #{cDir} -name '*.svn'|xargs rm -rf"
+		
+    #FIXME GPL+authors+README, etc    
+		
+		system "hdiutil create -scrub -volname Antargis -srcfolder #{sDir} #{sDir}.dmg"
+    
+    system "rm -rf "+sDir
+  end
+    
+  def distSource
+    system("cd ../.. && ./configure && rake")
+    sDir=sourceDir
+    mkdir(sDir)
+    copyMainTo(sDir)
+    copySourcesTo(sDir)
+    ["Rakefile","configure"].each{|f|
+      cp("../../"+f,sDir)
+    }
+    
+    #system "tar cfz #{sDir}.tar.gz #{sDir}"
+    #system "tar cfj #{sDir}.tar.bz2 #{sDir}"
+    #system "zip -r #{sDir}.zip #{sDir}"
+    checkSource(sDir)
+  end
+  
+  def prepareDistribution
+  end
+  
+  private
+  
+  def checkSource(dir)
+    system "cd #{dir} && export PATH=/usr/bin && ./configure && rake && rake spec"
+    raise "Did not work" if $?!=0
+  end
+  
+  def cp(from,todir)
+    File.copy(from,File.join(todir,File.split(from)[1]))
+  end
+  
+  def copySourcesTo(dir)
+    copyDirTo("../../ext",File.join(dir,"ext"),["cc","h","Rakefile","c","i"])
+    copyDirTo("../../rookey",File.join(dir,"rookey"),["rb","h","Rakefile","c","i","cc"])
+    require '../config_class.rb'
+    require '../../config_cache.rb'
+    copy("../../.build_"+Rookey.getConfig["host_os"]+"/antargis_swig.cc",dir)
+    copy("../../.build_"+Rookey.getConfig["host_os"]+"/antargis_swig.h",dir)
+  end
+  
+  def copyMainTo(dir)
+    copyDirTo("../../data",File.join(dir,"data"),["png","xml","wav","mp3","ant2","ant4","anim","antlvl","rb","hmap"])
+    copyDirTo("../../ruby",File.join(dir,"ruby"),["rb"])
+    ["COPYING","ChangeLog","INSTALL","AUTHORS","README","TODO"].each{|file|
+      cp("../../"+file,dir)
+    }
+  end
+  
+  def copyDirTo(from,to,filetypes,exclude=['\..*'])
+    puts from
+    mkdir(to) unless File.directory?(to)
+    Dir[File.join(from,"*")].each{|entry|
+      entry=File.split(entry)[1]
+     #puts entry
+      fromPath=File.join(from,entry)
+      toPath=File.join(to,entry)
+      if File.directory?(fromPath)
+        if exclude.select{|regex|entry=~/#{regex}/}.length==0
+          mkdir(toPath)
+          copyDirTo(fromPath,toPath,filetypes)
+        end
+      else
+        if filetypes.member?(entry.gsub(/.*\./,""))
+          copy(fromPath,toPath)
+        end
+      end
+    }
+  end
+  
+  def mkdir(d)
+    return if File.directory?(d)
+    puts "MKDIR #{d}"
+    begin
+      Dir.mkdir(d)
+    rescue
+      if d=~/\//
+        mkdir(File.split(d)[0])
+        begin
+          Dir.mkdir(d)
+        rescue
+          puts "FAIELD MKDIR #{d}"
+        end
+      else
+        puts "FAILED MKDIR #{d}"
+      end
+    end
+  end
+  
+  def sourceDir
+    @config.name+"-"+ at config.version
+  end
+end
+
+DistConfig=Struct.new(:name,:version)
+
+task :dist do
+  config=DistConfig.new("antargis","0.3")
+  d=RookeyDist.new(config)
+  #d.distDarwin
+  d.distSource
+  #dist(:win32)
+  #dist(:source)
+end
+
+task :clean do
+  system "rm -rf Antargis* antargis*"
+end
\ No newline at end of file

Modified: antargis/trunk/rookey/tasks.rb
===================================================================
--- antargis/trunk/rookey/tasks.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/rookey/tasks.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -143,19 +143,22 @@
   def Rookey.ruby_ext(name,files,inits)
     headerFiles=files.select{|f|f=~/h$/}
     libs=files.select{|f|f=~/so$/ or f=~/bundle/}
-    swigInterfaces=libs.map{|f|f.sub(/\.[a-zA-Z]+$/,".i")}
-    swigInterfaces=files.select{|f|f=~/i$/}
-    swigInterface = Rookey::swig_interface(name=>headerFiles+swigInterfaces,:initializers=>inits)
+
     cppFiles=files.select{|f|f=~/c$/}
 
     sourceDirs=files.map{|file|File.split(file)[0]}.sort.uniq
-    
+
     config=Rookey::getConfig
     sourceDirs << "."
     config.add("INCLUDEDIRS",sourceDirs.join(" "))
     
     compiler=Rookey::Compiler.new(config)
-        
+            
+    #FIXME: check if swig is present
+    
+    swigInterfaces=libs.map{|f|f.sub(/\.[a-zA-Z]+$/,".i")}
+    swigInterfaces=files.select{|f|f=~/i$/}
+    swigInterface = Rookey::swig_interface(name=>headerFiles+swigInterfaces,:initializers=>inits)
     swigTarget = Rookey::swig({File.join(compiler.getPlainBuildDir,name+"_swig.cc")=>swigInterface},config)
     
     

Modified: antargis/trunk/ruby/antargislib.rb
===================================================================
--- antargis/trunk/ruby/antargislib.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/ruby/antargislib.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -70,8 +70,13 @@
 
   def eventPrepareFrame(t)
     if $enableLogging and not $demoMode
-      @@eventDebugging||=File.open("events.txt","w")
-      @@eventDebugging.puts "T: #{t}"
+      begin
+        @@eventDebugging||=File.open("events.txt","w")
+        @@eventDebugging.puts "T: #{t}"
+      rescue
+        puts "Cannot write events.txt - disabling loggin"
+        $enableLogging=false
+      end
       #puts "TIME #{t}"
     end
     return false

Added: antargis/trunk/ruby/spec/spec_files.rb
===================================================================
--- antargis/trunk/ruby/spec/spec_files.rb	2008-07-13 13:31:38 UTC (rev 1278)
+++ antargis/trunk/ruby/spec/spec_files.rb	2008-07-17 19:39:17 UTC (rev 1279)
@@ -0,0 +1,5 @@
+describe "Package" do
+  it "should have some files included" do
+    files=["COPYING","ChangeLog","INSTALL","AUTHORS","README","TODO"]
+  end
+end
\ No newline at end of file



From davidkamphausen at mail.berlios.de  Sat Jul 19 17:53:41 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sat, 19 Jul 2008 17:53:41 +0200
Subject: [Antargis-svn] r1280 - in antargis/trunk/rookey: . configs
	maintainenance
Message-ID: <200807191553.m6JFrfGt022892@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-19 17:53:40 +0200 (Sat, 19 Jul 2008)
New Revision: 1280

Modified:
   antargis/trunk/rookey/config_generator.rb
   antargis/trunk/rookey/configs/ruby.rb
   antargis/trunk/rookey/maintainenance/Rakefile
   antargis/trunk/rookey/swig.rb
   antargis/trunk/rookey/tasks.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18
added profiling for mac

Modified: antargis/trunk/rookey/config_generator.rb
===================================================================
--- antargis/trunk/rookey/config_generator.rb	2008-07-17 19:39:17 UTC (rev 1279)
+++ antargis/trunk/rookey/config_generator.rb	2008-07-19 15:53:40 UTC (rev 1280)
@@ -18,8 +18,8 @@
   
   
   CONFIG_FILENAME="config_cache.rb"
+  @@configured=[]
   
-  
   # stores a dumpable ruby-object *what* into a file named *filename*
   def Rookey.hibe(what,filename)
     content=Marshal.dump(what).gsub("\"","\\\"")
@@ -124,6 +124,10 @@
   end
   
   
+  def self.checkConfig(pClass)
+    
+  end
+  
   def Rookey.runConfigure
     configurators=getDescendantsOfClass(Configurator)
     ok=[]
@@ -135,7 +139,12 @@
 		      if c.needs.select{|s|not ok.member?(s)}.length == 0
 		        log "Running configurator #{c}"
             #pp config
-		        c.new.run(config)
+            begin
+		          c.new.run(config)
+              @@configured << c
+            rescue
+              puts "Configuration of #{c} failed !"
+            end
 		        ok+=c.provides
 		        ok.uniq!
 		        run << c

Modified: antargis/trunk/rookey/configs/ruby.rb
===================================================================
--- antargis/trunk/rookey/configs/ruby.rb	2008-07-17 19:39:17 UTC (rev 1279)
+++ antargis/trunk/rookey/configs/ruby.rb	2008-07-19 15:53:40 UTC (rev 1280)
@@ -20,8 +20,20 @@
 		        config[name]=searchProgram(config[base])
 		      }
           
-          config.add("CFLAGS","-pg") if ROOKEY_CONFIG[:profile]
-          config.add("LDFLAGS","-pg") if ROOKEY_CONFIG[:profile]
+          if config["host_os"]=~/darwin.*/ and false
+            pgc="-finstrument-functions"
+            pgl="-finstrument-functions -lSaturn"
+          else
+            pgc="-pg"
+            pgl="-pg"
+          end 
+          config.add("CFLAGS",pgc) if ROOKEY_CONFIG[:profile]
+          config.add("LDFLAGS",pgl) if ROOKEY_CONFIG[:profile]
+          
+          ["CFLAGS","CPPFLAGS","LDFLAGS"].each{|name|
+            config.add(name,ENV[name]) if ENV[name]
+          }
+          
 	    end
 	    
 	  private

Modified: antargis/trunk/rookey/maintainenance/Rakefile
===================================================================
--- antargis/trunk/rookey/maintainenance/Rakefile	2008-07-17 19:39:17 UTC (rev 1279)
+++ antargis/trunk/rookey/maintainenance/Rakefile	2008-07-19 15:53:40 UTC (rev 1280)
@@ -110,7 +110,7 @@
   private
   
   def checkSource(dir)
-    system "cd #{dir} && export PATH=/usr/bin && ./configure && rake && rake spec"
+    system "cd #{dir} && export PATH=/usr/bin export LDFLAGS=-L/opt/local/lib && export CFLAGS='-I/opt/local/include -I/opt/local/include/SDL' && ./configure && rake --trace && rake spec"
     raise "Did not work" if $?!=0
   end
   

Modified: antargis/trunk/rookey/swig.rb
===================================================================
--- antargis/trunk/rookey/swig.rb	2008-07-17 19:39:17 UTC (rev 1279)
+++ antargis/trunk/rookey/swig.rb	2008-07-19 15:53:40 UTC (rev 1280)
@@ -1,3 +1,5 @@
+require 'ftools'
+
 module Rookey
   class Swig
     def initialize(config,target=:ruby,cpp=true)
@@ -8,8 +10,22 @@
     def swig(t,interface)
       options=[]
       program=@config["SWIG"]
-      program||="swig"
-      program="swig" if program==""
+      if program=="" or program.nil?
+        # check if a prepared file is in vicinity
+        puts t.name
+        filename=File.split(t.name)[1]
+        if File.exists?(filename)
+          File.copy(filename,t.name)
+          return
+        end
+        #exit
+        program="swig"
+      end
+      #program||="swig"
+      
+      #program="swig" if program==""
+      #if program
+      
       options << "-#{@target}"
       options << "-c++" if @cpp
       swigOptions = @config["SWIG_OPTIONS"].split(" ")

Modified: antargis/trunk/rookey/tasks.rb
===================================================================
--- antargis/trunk/rookey/tasks.rb	2008-07-17 19:39:17 UTC (rev 1279)
+++ antargis/trunk/rookey/tasks.rb	2008-07-19 15:53:40 UTC (rev 1280)
@@ -140,7 +140,7 @@
   end 
 
   
-  def Rookey.ruby_ext(name,files,inits)
+  def Rookey.ruby_ext(name,files,inits,fallbackInterface=nil)
     headerFiles=files.select{|f|f=~/h$/}
     libs=files.select{|f|f=~/so$/ or f=~/bundle/}
 
@@ -148,6 +148,8 @@
 
     sourceDirs=files.map{|file|File.split(file)[0]}.sort.uniq
 
+    Rookey::checkConfig(SwigConfig)
+    
     config=Rookey::getConfig
     sourceDirs << "."
     config.add("INCLUDEDIRS",sourceDirs.join(" "))



From davidkamphausen at mail.berlios.de  Sun Jul 20 17:00:30 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Sun, 20 Jul 2008 17:00:30 +0200
Subject: [Antargis-svn] r1281 - in antargis/trunk: ext/3dengine ext/basic
	ext/gui ext/video rookey/maintainenance
Message-ID: <200807201500.m6KF0UR3020814@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-20 17:00:23 +0200 (Sun, 20 Jul 2008)
New Revision: 1281

Modified:
   antargis/trunk/ext/3dengine/vertex_array.cc
   antargis/trunk/ext/basic/ag_geometry.cc
   antargis/trunk/ext/gui/ag_widget.cc
   antargis/trunk/ext/video/ag_png.cc
   antargis/trunk/rookey/maintainenance/
Log:
* fixes for valgrind-errors

Modified: antargis/trunk/ext/3dengine/vertex_array.cc
===================================================================
--- antargis/trunk/ext/3dengine/vertex_array.cc	2008-07-19 15:53:40 UTC (rev 1280)
+++ antargis/trunk/ext/3dengine/vertex_array.cc	2008-07-20 15:00:23 UTC (rev 1281)
@@ -34,6 +34,7 @@
 VertexArray::VertexArray(bool pDynamic):mDynamic(pDynamic),bbox(AGVector3(),AGVector3())
 {
   bColor=true;
+  GLeeInit();
   mBuffers=GLEE_ARB_vertex_buffer_object && useVBO();
   mArrays=GLEE_EXT_vertex_array && useVertexArrays();
 

Modified: antargis/trunk/ext/basic/ag_geometry.cc
===================================================================
--- antargis/trunk/ext/basic/ag_geometry.cc	2008-07-19 15:53:40 UTC (rev 1280)
+++ antargis/trunk/ext/basic/ag_geometry.cc	2008-07-20 15:00:23 UTC (rev 1281)
@@ -253,6 +253,7 @@
 AGString AGVector2::toString() const
 {
   std::ostringstream os;
+  os.str("");
   os<<"("<<v[0]<<","<<v[1]<<")";
   return AGString(os.str());
 }

Modified: antargis/trunk/ext/gui/ag_widget.cc
===================================================================
--- antargis/trunk/ext/gui/ag_widget.cc	2008-07-19 15:53:40 UTC (rev 1280)
+++ antargis/trunk/ext/gui/ag_widget.cc	2008-07-20 15:00:23 UTC (rev 1281)
@@ -612,19 +612,21 @@
 
 void AGWidget::setWidth(float w)
   {
-    if(mCache && width()!=w)
-      setCaching(true);
+    bool changed=(width()!=w);
     regChange();
     mRect.setWidth(w);
+    if(mCache && changed)
+      setCaching(true);
     regChange();
     queryRedraw();
   }
 void AGWidget::setHeight(float h)
   {
-    if(mCache && height()!=h)
-      setCaching(true);
+    bool changed=(height()!=h);
     regChange();
     mRect.setHeight(h);
+    if(mCache && changed)
+      setCaching(true);
     regChange();
     queryRedraw();
   }

Modified: antargis/trunk/ext/video/ag_png.cc
===================================================================
--- antargis/trunk/ext/video/ag_png.cc	2008-07-19 15:53:40 UTC (rev 1280)
+++ antargis/trunk/ext/video/ag_png.cc	2008-07-20 15:00:23 UTC (rev 1281)
@@ -212,7 +212,7 @@
 
     std::string ns(mem,nsize+1);
 
-    delete mem;
+    delete[]  mem;
     return ns;
   }
 


Property changes on: antargis/trunk/rookey/maintainenance
___________________________________________________________________
Name: svn:ignore
   + antargis-*




From davidkamphausen at mail.berlios.de  Mon Jul 21 20:23:07 2008
From: davidkamphausen at mail.berlios.de (davidkamphausen at BerliOS)
Date: Mon, 21 Jul 2008 20:23:07 +0200
Subject: [Antargis-svn] r1282 - in antargis/trunk: ext/game ext/gui
	rookey/configs rookey/cpp rookey/externals
Message-ID: <200807211823.m6LIN7uh014946@sheep.berlios.de>

Author: davidkamphausen
Date: 2008-07-21 20:23:05 +0200 (Mon, 21 Jul 2008)
New Revision: 1282

Modified:
   antargis/trunk/ext/game/minimap.cc
   antargis/trunk/ext/game/terrain.cc
   antargis/trunk/ext/gui/ag_application.cc
   antargis/trunk/ext/gui/ag_checkbox.cc
   antargis/trunk/ext/gui/ag_theme.cc
   antargis/trunk/rookey/configs/ruby.rb
   antargis/trunk/rookey/cpp/ag_rubyobj.cc
   antargis/trunk/rookey/cpp/ag_rubyobj.h
   antargis/trunk/rookey/externals/ext_config.rb
   antargis/trunk/rookey/externals/tools.rb
Log:
Incomplete - task 18: MinGW on MacOSX 
http://localhost:3000/issues/show/18

Modified: antargis/trunk/ext/game/minimap.cc
===================================================================
--- antargis/trunk/ext/game/minimap.cc	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/ext/game/minimap.cc	2008-07-21 18:23:05 UTC (rev 1282)
@@ -20,7 +20,7 @@
 
 MiniMap::~MiniMap()
   {
-    delete mTexture;
+    saveDelete(mTexture);
   }
 
 

Modified: antargis/trunk/ext/game/terrain.cc
===================================================================
--- antargis/trunk/ext/game/terrain.cc	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/ext/game/terrain.cc	2008-07-21 18:23:05 UTC (rev 1282)
@@ -303,9 +303,9 @@
 void Terrain::mapChangedComplete()
   {
     for(Pieces::iterator i=pieces.begin();i!=pieces.end();i++)
-      delete *i;
+      saveDelete(*i);
     for(WPieces::iterator i=water.begin();i!=water.end();i++)
-      delete *i;
+      saveDelete(*i);
 
     pieces.clear();
     water.clear();

Modified: antargis/trunk/ext/gui/ag_application.cc
===================================================================
--- antargis/trunk/ext/gui/ag_application.cc	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/ext/gui/ag_application.cc	2008-07-21 18:23:05 UTC (rev 1282)
@@ -60,7 +60,7 @@
     CTRACE;
     if(mainWidget)
       mainWidget->setApp(0);
-    delete mCursor;
+    saveDelete(mCursor);
   }
 
 void AGApplication::setKeyRepeat(bool enable)
@@ -224,7 +224,7 @@
           processed=processEvent(message);
       }
 
-    delete message;
+    saveDelete( message);
     return processed;
   }
 
@@ -377,7 +377,7 @@
 
         pLastDrawn=mainWidget;
 
-        delete p;
+        saveDelete( p);
       }
     else
       cdebug("no mainwidget");
@@ -485,7 +485,7 @@
 /// this function sets the current tooltip, which is display above all widgets
 void AGApplication::setTooltip(AGTooltip *pTooltip)
   {
-    delete mTooltip;
+    saveDelete( mTooltip );
     mTooltip=pTooltip;
 
   }
@@ -496,7 +496,7 @@
   {
     if (pTooltip==mTooltip)
       {
-        delete mTooltip;
+        saveDelete(mTooltip);
         mTooltip=0;
       }
   }
@@ -531,7 +531,7 @@
 void AGApplication::setNormalCursor()
   {
     SDL_ShowCursor(1);
-    delete mCursor;
+    saveDelete( mCursor );
     mCursor=0;
   }
 

Modified: antargis/trunk/ext/gui/ag_checkbox.cc
===================================================================
--- antargis/trunk/ext/gui/ag_checkbox.cc	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/ext/gui/ag_checkbox.cc	2008-07-21 18:23:05 UTC (rev 1282)
@@ -43,8 +43,8 @@
 
 void AGCheckBox::setSurfaces(AGSurface pDisabledSurface,AGSurface pEnabledSurface)
   {
-    delete mSurfaces[0];
-    delete mSurfaces[1];
+    saveDelete(mSurfaces[0]);
+    saveDelete(mSurfaces[1]);
     mSurfaces[0]=new AGSurface(pDisabledSurface);
     mSurfaces[1]=new AGSurface(pEnabledSurface);
 

Modified: antargis/trunk/ext/gui/ag_theme.cc
===================================================================
--- antargis/trunk/ext/gui/ag_theme.cc	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/ext/gui/ag_theme.cc	2008-07-21 18:23:05 UTC (rev 1282)
@@ -112,7 +112,7 @@
 void setTheme(const AGTheme &t)
   {
     if(mTheme)
-      delete mTheme;
+      saveDelete(mTheme);
     mTheme=new AGTheme(t);
   }
 

Modified: antargis/trunk/rookey/configs/ruby.rb
===================================================================
--- antargis/trunk/rookey/configs/ruby.rb	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/rookey/configs/ruby.rb	2008-07-21 18:23:05 UTC (rev 1282)
@@ -1,53 +1,57 @@
 require 'mkmf'
 
 module Rookey
-  if ROOKEY_CONFIG[:use_mkmf]==true or ROOKEY_CONFIG[:use_mkmf].nil? 
 	  class RubyConfig<Configurator
-	    provides :compiler
-	    
-	    def run(config)
-		      config.add("INCLUDEDIRS",get("archdir")+" "+get("includedir"))
-		      config.add("CFLAGS",get("CFLAGS"))
-		      config.add("LDFLAGS",get("LIBS"))
-		      config.add("LDFLAGS",get("LIBRUBYARG"))
-		      config.add("LDSHAREDFLAGS",get("LDSHARED").sub(/^[^ ]+ /,""))
-		      config["DLEXT"]=get("DLEXT")
-		      config["host_os"]=get("host_os")      
-		      config["GPP_BASE"]="g++"
-		      config["GCC_BASE"]="gcc"
-		
-		      {"CPP"=>"GPP_BASE","CC"=>"GCC_BASE"}.each{|name,base|      
-		        config[name]=searchProgram(config[base])
-		      }
-          
-          if config["host_os"]=~/darwin.*/ and false
-            pgc="-finstrument-functions"
-            pgl="-finstrument-functions -lSaturn"
-          else
-            pgc="-pg"
-            pgl="-pg"
-          end 
-          config.add("CFLAGS",pgc) if ROOKEY_CONFIG[:profile]
-          config.add("LDFLAGS",pgl) if ROOKEY_CONFIG[:profile]
-          
-          ["CFLAGS","CPPFLAGS","LDFLAGS"].each{|name|
-            config.add(name,ENV[name]) if ENV[name]
-          }
-          
-	    end
-	    
-	  private
-	    # recurse through ruby's CONFIG structure 
-	    def get(n)
-	      return "" if n.nil?
-	      v=CONFIG[n]
-	      return "" if v.nil?
-	      v.gsub(/\$\(([^)]*\))/) {|a|
-	        f=a[2..-2]
-	        get(f)
-	      }      
-	    end
-	    
+      if ROOKEY_CONFIG[:use_mkmf]==true or ROOKEY_CONFIG[:use_mkmf].nil? 
+		    provides :compiler
+		    
+		    def run(config)
+			      config.add("INCLUDEDIRS",get("archdir")+" "+get("includedir"))
+			      config.add("CFLAGS",get("CFLAGS"))
+			      config.add("LDFLAGS",get("LIBS"))
+			      config.add("LDFLAGS",get("LIBRUBYARG"))
+			      config.add("LDSHAREDFLAGS",get("LDSHARED").sub(/^[^ ]+ /,""))
+			      config["DLEXT"]=get("DLEXT")
+			      config["host_os"]=get("host_os")      
+			      config["GPP_BASE"]="g++"
+			      config["GCC_BASE"]="gcc"
+			
+			      {"CPP"=>"GPP_BASE","CC"=>"GCC_BASE"}.each{|name,base|      
+			        config[name]=searchProgram(config[base])
+			      }
+	          
+	          if config["host_os"]=~/darwin.*/ and false
+	            pgc="-finstrument-functions"
+	            pgl="-finstrument-functions -lSaturn"
+	          else
+	            pgc="-pg"
+	            pgl="-pg"
+	          end 
+	          config.add("CFLAGS",pgc) if ROOKEY_CONFIG[:profile]
+	          config.add("LDFLAGS",pgl) if ROOKEY_CONFIG[:profile]
+	          
+	          ["CFLAGS","CPPFLAGS","LDFLAGS"].each{|name|
+	            config.add(name,ENV[name]) if ENV[name]
+	          }
+	          
+		    end
+		    
+		  private
+		    # recurse through ruby's CONFIG structure 
+		    def get(n)
+		      return "" if n.nil?
+		      v=CONFIG[n]
+		      return "" if v.nil?
+		      v.gsub(/\$\(([^)]*\))/) {|a|
+		        f=a[2..-2]
+		        get(f)
+		      }      
+		    end
+		    
+      elsif ROOKEY_CONFIG[:extconfig]=='mingw32'
+        def run(config)
+          install("ruby")
+        end
 	  end
 	end
 end
\ No newline at end of file

Modified: antargis/trunk/rookey/cpp/ag_rubyobj.cc
===================================================================
--- antargis/trunk/rookey/cpp/ag_rubyobj.cc	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/rookey/cpp/ag_rubyobj.cc	2008-07-21 18:23:05 UTC (rev 1282)
@@ -41,10 +41,20 @@
 AGRubyObject::AGRubyObject()
   {
     //std::cerr<<"AGRubyObject::new:"<<this<<std::endl;
+    assert(mRubyObjects.find(this)==mRubyObjects.end());
     mRubyObjects.insert(this);
+    size_t oSize=mRemovedRubyObjects.size();
+
+    mRemovedRubyObjects.erase(this);
+    if(oSize!=mRemovedRubyObjects.size())
+      std::cerr<<"Collision - removed rubyobject's address is overwritten!"<<std::endl;
+    
+    std::cerr<<"current ruby#:"<<mRubyObjects.size()<<" removed:"<<mRemovedRubyObjects.size()<<std::endl;
   }
 AGRubyObject::~AGRubyObject()
   {
+    assert(mRubyObjects.find(this)!=mRubyObjects.end());
+    assert(mRemovedRubyObjects.find(this)==mRemovedRubyObjects.end());
     //std::cerr<<"AGRubyObject::Removed:"<<this<<std::endl;
     for(std::set<AGBaseObject*>::iterator i=mReferences.begin();i!=mReferences.end();i++)
       (*i)->baseClear();
@@ -71,9 +81,11 @@
     VALUE v=convertCpp2Ruby(o);
     if(v!=Qnil)
       {
+        assert(DATA_PTR(v)==o);
         //std::cout<<"V:"<<v<<std::endl;
         // then mark it
         rb_gc_mark(v);
+        
       }
 
     assert(o);

Modified: antargis/trunk/rookey/cpp/ag_rubyobj.h
===================================================================
--- antargis/trunk/rookey/cpp/ag_rubyobj.h	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/rookey/cpp/ag_rubyobj.h	2008-07-21 18:23:05 UTC (rev 1282)
@@ -47,12 +47,12 @@
 protected:
   AGRubyObject *mp;
 public:
-  AGBaseObject(AGRubyObject *p);
+  AGBaseObject(AGRubyObject *p) throw ();
 
-  ~AGBaseObject();
-  void baseClear();
+  ~AGBaseObject() throw ();
+  void baseClear() throw ();
 
-  bool valid()
+  bool valid() throw ()
     {
       return mp;
     }
@@ -97,15 +97,15 @@
    */
   typedef unsigned long VALUE;
 
-  AGRubyObject();
-  virtual ~AGRubyObject();
+  AGRubyObject() throw();
+  virtual ~AGRubyObject() throw();
 
 protected:
 #ifndef SWIG
   // functions shouldn't be exported and NEVER be used in ruby!
-  virtual void clear();
-  virtual void mark();
-  void markObject(AGRubyObject *o,bool recursive=true);
+  virtual void clear() throw();
+  virtual void mark() throw();
+  void markObject(AGRubyObject *o,bool recursive=true) throw();
 
 #endif
 public:

Modified: antargis/trunk/rookey/externals/ext_config.rb
===================================================================
--- antargis/trunk/rookey/externals/ext_config.rb	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/rookey/externals/ext_config.rb	2008-07-21 18:23:05 UTC (rev 1282)
@@ -1,3 +1,5 @@
+require 'pp'
+
 def getInstallTarget(name)
   File.expand_path(File.join(File.split(__FILE__)[0],"built",name))
 end
@@ -20,7 +22,7 @@
 end
 
 $zliburl="http://somezliburl"
-class Package
+class HostPackage
   attr_reader :url
   attr_accessor :configureOptions, :local
   def initialize(url)
@@ -56,8 +58,50 @@
     unzipTar(file)
     build(dir,configureOptions)
   end    
+  def build(dir,configureOptions)
+    olddir=Dir.pwd
+  
+    Dir.chdir(dir)
+    
+    msh "./configure --prefix=#{File.join(olddir,"build")} #{configureOptions}"
+    premake
+    msh "make"
+    msh "make install"
+  
+    Dir.chdir(olddir)
+  end
+  def premake
+  end
 end
 
+
+class RubyPackage<HostPackage
+  def initialize(url)
+    puts "_______"
+    require File.join(File.split(__FILE__)[0],"..","..","rookey_configuration.rb")
+    if  ROOKEY_CONFIG[:extconfig]=="mingw32"
+      @configureOptions="--host=i386-mingw32"
+    end
+    super
+  end
+  def premake
+    #fname="fake.rb"
+    
+    filesub("fake.rb",'ALT_SEPARATOR = "\";','ALT_SEPARATOR = "\"";')
+    filesub("lib/mkmf.rb",'CONFIG["hdrdir"].quote','CONFIG["hdrdir"].to_s.quote')
+  end
+  
+  def filesub(filename,from,to)
+    f=File.open(filename,"r")
+    c=f.read
+    f.close
+    f=File.open(filename,"w")
+    f.puts c.gsub(from,to)
+    f.close
+  end    
+  
+end
+
 class BinPackage
   include PackageBase
   def initialize(binurl,devurl)
@@ -97,13 +141,14 @@
 
 def externalPackages
 	pkgs={
-	  "swig"=>Package.new("http://downloads.sourceforge.net/swig/swig-1.3.36.tar.gz"),
+	  "swig"=>HostPackage.new("http://downloads.sourceforge.net/swig/swig-1.3.36.tar.gz"),
     "zlib"=>BinPackage.new("http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-bin.zip","http://prdownloads.sourceforge.net/gnuwin32/zlib-1.2.3-lib.zip"),
     "sdl"=>BinPackage.new("http://libsdl.org/release/SDL-1.2.13-win32.zip","http://libsdl.org/release/SDL-devel-1.2.13-mingw32.tar.gz"),
     "sdl_image"=>BinPackage.new("http://www.libsdl.org/projects/SDL_image/release/SDL_image-1.2.6-win32.zip","http://www.libsdl.org/projects/SDL_image/release/SDL_image-devel-1.2.6-VC8.zip"),
     "sdl_ttf"=>BinPackage.new("http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-2.0.9-win32.zip","http://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-2.0.9-VC8.zip"),
     "sdl_mixer"=>BinPackage.new("http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-1.2.8-win32.zip","http://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.8-VC8.zip"),
-    "png"=>BinPackage.new("http://gnuwin32.sourceforge.net/downlinks/libpng-bin-zip.php","http://gnuwin32.sourceforge.net/downlinks/libpng-lib-zip.php")
+    "png"=>BinPackage.new("http://gnuwin32.sourceforge.net/downlinks/libpng-bin-zip.php","http://gnuwin32.sourceforge.net/downlinks/libpng-lib-zip.php"),
+    "ruby"=>RubyPackage.new("ftp://ftp.ruby-lang.org/pub/ruby/1.8/ruby-1.8.7.tar.bz2")
 	}
   # exclude other scripting langs for swig
   pkgs["swig"].configureOptions=["python","ocaml","php4","chicken","csharp","csharp",

Modified: antargis/trunk/rookey/externals/tools.rb
===================================================================
--- antargis/trunk/rookey/externals/tools.rb	2008-07-20 15:00:23 UTC (rev 1281)
+++ antargis/trunk/rookey/externals/tools.rb	2008-07-21 18:23:05 UTC (rev 1282)
@@ -46,18 +46,7 @@
   system a
 end
 
-def build(dir,configureOptions)
-  olddir=Dir.pwd
 
-  Dir.chdir(dir)
-  
-  msh "./configure --prefix=#{File.join(olddir,"build")} #{configureOptions}"
-  msh "make"
-  msh "make install"
-
-  Dir.chdir(olddir)
-end
-
 def buildExternal(name)
   Dir.chdir(File.split(__FILE__)[0])
   puts name



