<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Antargis-svn] r1093 - in antargis/branches/branch_2d:	data/textures/2d gui/src ruby ruby/tests src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/antargis-svn/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:antargis-svn%40lists.berlios.de?Subject=Re%3A%20%5BAntargis-svn%5D%20r1093%20-%20in%20antargis/branches/branch_2d%3A%0A%09data/textures/2d%20gui/src%20ruby%20ruby/tests%20src&In-Reply-To=%3C200705091835.l49IZLn5000654%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000050.html">
   <LINK REL="Next"  HREF="000052.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Antargis-svn] r1093 - in antargis/branches/branch_2d:	data/textures/2d gui/src ruby ruby/tests src</H1>
    <B>davidkamphausen at BerliOS</B> 
    <A HREF="mailto:antargis-svn%40lists.berlios.de?Subject=Re%3A%20%5BAntargis-svn%5D%20r1093%20-%20in%20antargis/branches/branch_2d%3A%0A%09data/textures/2d%20gui/src%20ruby%20ruby/tests%20src&In-Reply-To=%3C200705091835.l49IZLn5000654%40sheep.berlios.de%3E"
       TITLE="[Antargis-svn] r1093 - in antargis/branches/branch_2d:	data/textures/2d gui/src ruby ruby/tests src">davidkamphausen at mail.berlios.de
       </A><BR>
    <I>Wed May  9 20:35:21 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000050.html">[Antargis-svn] r1092 - antargis/branches/new_hl_jobs/ruby/ai
</A></li>
        <LI>Next message: <A HREF="000052.html">[Antargis-svn] r1094 - antargis/branches/branch_2d/data/textures/2d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51">[ date ]</a>
              <a href="thread.html#51">[ thread ]</a>
              <a href="subject.html#51">[ subject ]</a>
              <a href="author.html#51">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: davidkamphausen
Date: 2007-05-09 20:34:55 +0200 (Wed, 09 May 2007)
New Revision: 1093

Modified:
   antargis/branches/branch_2d/data/textures/2d/arrow.png
   antargis/branches/branch_2d/data/textures/2d/bakery.png
   antargis/branches/branch_2d/data/textures/2d/boat.png
   antargis/branches/branch_2d/data/textures/2d/buildingsite.png
   antargis/branches/branch_2d/data/textures/2d/coach.png
   antargis/branches/branch_2d/data/textures/2d/dwelling.png
   antargis/branches/branch_2d/data/textures/2d/farm.png
   antargis/branches/branch_2d/data/textures/2d/field.png
   antargis/branches/branch_2d/data/textures/2d/fire.png
   antargis/branches/branch_2d/data/textures/2d/fish.png
   antargis/branches/branch_2d/data/textures/2d/hero.png
   antargis/branches/branch_2d/data/textures/2d/man.png
   antargis/branches/branch_2d/data/textures/2d/mill.png
   antargis/branches/branch_2d/data/textures/2d/mine.png
   antargis/branches/branch_2d/data/textures/2d/sack.png
   antargis/branches/branch_2d/data/textures/2d/sheep.png
   antargis/branches/branch_2d/data/textures/2d/stone.png
   antargis/branches/branch_2d/data/textures/2d/tower.png
   antargis/branches/branch_2d/data/textures/2d/townhall.png
   antargis/branches/branch_2d/data/textures/2d/tree.png
   antargis/branches/branch_2d/data/textures/2d/twig.png
   antargis/branches/branch_2d/data/textures/2d/well.png
   antargis/branches/branch_2d/data/textures/2d/wolf.png
   antargis/branches/branch_2d/data/textures/2d/workshop.png
   antargis/branches/branch_2d/gui/src/ag_messageobject.cc
   antargis/branches/branch_2d/gui/src/ag_painter.cc
   antargis/branches/branch_2d/gui/src/ag_sdlsurface.cc
   antargis/branches/branch_2d/gui/src/ag_surface.cc
   antargis/branches/branch_2d/gui/src/ag_surface.h
   antargis/branches/branch_2d/gui/src/ag_texture.cc
   antargis/branches/branch_2d/gui/src/ag_widget.cc
   antargis/branches/branch_2d/ruby/ant_energy.rb
   antargis/branches/branch_2d/ruby/antargis.rb
   antargis/branches/branch_2d/ruby/tests/impostor.rb
   antargis/branches/branch_2d/ruby/two_d_app.rb
   antargis/branches/branch_2d/src/anim_mesh_data.cc
   antargis/branches/branch_2d/src/anim_mesh_data.h
   antargis/branches/branch_2d/src/impostor.cc
   antargis/branches/branch_2d/src/interface.i
   antargis/branches/branch_2d/src/mesh_sort.h
   antargis/branches/branch_2d/src/scene_2d.cc
Log:
* some more improvements on 2d


Modified: antargis/branches/branch_2d/data/textures/2d/arrow.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/bakery.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/boat.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/buildingsite.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/coach.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/dwelling.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/farm.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/field.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/fire.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/fish.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/hero.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/man.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/mill.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/mine.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/sack.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/sheep.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/stone.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/tower.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/townhall.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/tree.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/twig.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/well.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/wolf.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/data/textures/2d/workshop.png
===================================================================
(Binary files differ)

Modified: antargis/branches/branch_2d/gui/src/ag_messageobject.cc
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_messageobject.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_messageobject.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -667,7 +667,7 @@
 }
 bool eventOk(const SDL_Event &amp;pEvent)
 {
-  dbout(1,&quot;eventOk: check &quot;&lt;&lt;(int)pEvent.type&lt;&lt;&quot;!=&quot;&lt;&lt;SDL_NOEVENT&lt;&lt;&quot; ???&quot;);
+  //  dbout(1,&quot;eventOk: check &quot;&lt;&lt;(int)pEvent.type&lt;&lt;&quot;!=&quot;&lt;&lt;SDL_NOEVENT&lt;&lt;&quot; ???&quot;);
   return (int)pEvent.type!=SDL_NOEVENT;
 }
 

Modified: antargis/branches/branch_2d/gui/src/ag_painter.cc
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_painter.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_painter.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -419,7 +419,8 @@
 	    
 	  if(sdlScreen)
 	    {
-	      sdlScreen-&gt;drawGradient(r,c0,c1,c2,c3);
+	      sdlScreen-&gt;drawGradient(d,pc0,pc1,pc2,pc3);
+	      //	      sdlScreen-&gt;drawGradient(r,c0,c1,c2,c3);
 	    }
 	  else
 	    {

Modified: antargis/branches/branch_2d/gui/src/ag_sdlsurface.cc
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_sdlsurface.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_sdlsurface.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -29,6 +29,8 @@
 #include &quot;ag_sgeexport.h&quot;
 #include &lt;math.h&gt;
 
+static bool gUseSDLclipping=true;
+
 SDL_Surface *AGCreate32BitSurface(size_t width,size_t height);
 
 AGSDLScreen::AGSDLScreen(SDL_Surface *S):s(S)
@@ -223,13 +225,19 @@
 void AGSDLScreen::clip(const AGRect2 &amp;r)
 {
   //  cdebug(r);
-  SDL_Rect sr=r.sdl();
-  SDL_SetClipRect(s,&amp;sr);
+  if(gUseSDLclipping)
+    {
+      SDL_Rect sr=r.sdl();
+      SDL_SetClipRect(s,&amp;sr);
+    }
 }
 void AGSDLScreen::unclip()
 {
-  SDL_Rect sr=getRect().sdl();
-  SDL_SetClipRect(s,&amp;sr);
+  if(gUseSDLclipping)
+    {
+      SDL_Rect sr=getRect().sdl();
+      SDL_SetClipRect(s,&amp;sr);
+    }
 }
 
 AGSurface AGSDLScreen::screenshot(bool frontBuffer)

Modified: antargis/branches/branch_2d/gui/src/ag_surface.cc
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_surface.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_surface.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -573,9 +573,12 @@
 	    y1=std::max(y1,y);
 	  }
       }
-  int nw=std::max(0,x1-x0+1);
-  int nh=std::max(0,y1-y0+1);
 
+  
+
+  int nw=std::max(1,x1-x0+1);
+  int nh=std::max(1,y1-y0+1);
+
   AGSurface n(nw,nh);
 
   for(x=0;x&lt;nw;x++)

Modified: antargis/branches/branch_2d/gui/src/ag_surface.h
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_surface.h	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_surface.h	2007-05-09 18:34:55 UTC (rev 1093)
@@ -124,10 +124,12 @@
 
   AGVector2 shrink2Fit(int alphaThresh=20);
 
- private:
+  // private:
 
   AGSurface(AGInternalSurface *i);
 
+ private:
+
   Uint32 color(const AGColor &amp;c) const;
 
   AGInternalSurface *s;
@@ -141,4 +143,5 @@
 
 void AGFreeSurface(SDL_Surface *s);
 
+std::ostream &amp;operator&lt;&lt;(std::ostream &amp;o,SDL_PixelFormat *f);
 #endif

Modified: antargis/branches/branch_2d/gui/src/ag_texture.cc
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_texture.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_texture.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -27,6 +27,7 @@
 #include &quot;ag_profiler.h&quot;
 #include &quot;ag_glpainter.h&quot;
 #include &quot;ag_fbo.h&quot;
+#include &quot;ag_main.h&quot;
 #include &lt;stdexcept&gt;
 
 size_t nextpow2(size_t i)
@@ -165,7 +166,7 @@
 
 bool AGTexture::hasTexture() const
 {
-  return mTexture;
+  return mTexture || !glMode();
 }
 void AGTexture::clearTexture()
 {
@@ -184,6 +185,9 @@
   if(mSDLTexture==0)
     {
       mSDLTexture=new AGInternalSurface;
+      assert(s);
+      if(!s)
+	s=AGSurface(w,h).surface();
       mSDLTexture-&gt;surface=SDL_DisplayFormatAlpha(s-&gt;surface);
       s-&gt;sdlTexture=mSDLTexture;
     }
@@ -359,6 +363,10 @@
     }
   else
     {
+      sdlTexture();
+      sge_PutPixel(mSDLTexture-&gt;surface,x,y,c.mapRGB(mSDLTexture-&gt;surface-&gt;format));
+
+
       sge_PutPixel(s-&gt;surface,x,y,c.mapRGB(s-&gt;surface-&gt;format));
     }
 }
@@ -373,7 +381,13 @@
       AGGLPainter::fillRect(pRect,c);
     }
   else
-    throw std::runtime_error(&quot;implement fillRect for sdl-texture&quot;);
+    {
+      for(int x=(int)pRect.x0();x&lt;=pRect.x1();x++)
+	for(int y=(int)pRect.y0();y&lt;=pRect.y1();y++)
+	  putPixel(x,y,c);
+      
+      //      throw std::runtime_error(&quot;implement fillRect for sdl-texture&quot;);
+    }
   
 }
 
@@ -393,13 +407,41 @@
     }
   else
     {
+      SDL_Rect clip;
+
+      //      throw std::runtime_error(&quot;my blitting&quot;);
       SDL_Rect sr,dr;
       sr=pSrc.sdl();
       dr=pDest.sdl();
+
+      const_cast&lt;AGTexture&amp;&gt;(pSource).sdlTexture();
+      cdebug(&quot;sr:&quot;&lt;&lt;sr&lt;&lt;&quot; dr:&quot;&lt;&lt;dr);
+      cdebug(pSource.mSDLTexture);
+      cdebug(pSource.mSDLTexture-&gt;surface);
+      cdebug(sdlTexture()-&gt;surface);
+
+      AGSurface(pSource.s).save(&quot;source.s.png&quot;);
+      AGSurface(pSource.mSDLTexture).save(&quot;source.tex.png&quot;);
+      SDL_GetClipRect(s-&gt;surface,&amp;clip);
+      cdebug(&quot;clip:&quot;&lt;&lt;clip);
+      cdebug(&quot;format:&quot;&lt;&lt;*s-&gt;surface-&gt;format);
+      AGRect2 my(0,0,64,64);
+      SDL_SetClipRect(s-&gt;surface,&amp;my.sdl());
+      SDL_UnlockSurface(s-&gt;surface);
+      if(SDL_BlitSurface(pSource.s-&gt;surface,&amp;sr,s-&gt;surface,&amp;dr))
+	cdebug(&quot;ERROR&quot;);
+      /*
+      for(int x=0;x&lt;64;x++)
+	for(int y=0;y&lt;64;y++)
+	  putPixel(x,y,pSource.getPixel(x,y));
+      */
+      AGSurface(s).save(&quot;dest.s.png&quot;);
+
+
       if(pSource.mSDLTexture)
-	SDL_BlitSurface(pSource.mSDLTexture-&gt;surface,&amp;sr,mSDLTexture-&gt;surface,&amp;dr);
+	SDL_BlitSurface(pSource.mSDLTexture-&gt;surface,&amp;sr,sdlTexture()-&gt;surface,&amp;dr);
       else
-	SDL_BlitSurface(pSource.s-&gt;surface,&amp;sr,mSDLTexture-&gt;surface,&amp;dr);
+	SDL_BlitSurface(pSource.s-&gt;surface,&amp;sr,sdlTexture()-&gt;surface,&amp;dr);
     }
 }
 void AGTexture::blit(const AGTexture &amp;pSource,const AGRect2 &amp;pDest,const AGRect2 &amp;pSrc,const AGColor &amp;pColor)

Modified: antargis/branches/branch_2d/gui/src/ag_widget.cc
===================================================================
--- antargis/branches/branch_2d/gui/src/ag_widget.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/gui/src/ag_widget.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -878,17 +878,37 @@
 
 	  setDrawn();
 
+
+	  {
+	    static int i=0;
+	    i++;
+	    std::ostringstream os;
+	    os&lt;&lt;&quot;widget_&quot;&lt;&lt;i&lt;&lt;&quot;.png&quot;;
+	    AGSurface ms(mCache-&gt;sdlTexture());
+	    ms.save(os.str());
+	    
+	  }
+
+
 	  if(mParent)
 	    {
+	      //CTRACE;
+	      cdebug(&quot;parent-&gt;queryRedraw::&quot;&lt;&lt;typeid(*this).name()&lt;&lt;&quot;:&quot;&lt;&lt;getName());
 	      mParent-&gt;queryRedraw();
 	    }
 
 	  assert(checkRedraw()==false);
+	  assert(mCache-&gt;hasTexture());
 	}
     }
 }
 void AGWidget::setCaching(bool pEnable)
 {
+  // FIXME: really no caching without GL? 
+  //  if(!glMode())
+  //    return;
+
+
   if(getConfig()-&gt;get(&quot;widgetTextureCache&quot;)==&quot;false&quot;)
     return;
   getConfig()-&gt;set(&quot;widgetTextureCache&quot;,&quot;true&quot;);
@@ -919,6 +939,7 @@
 
 void AGWidget::queryRedraw()
 {
+  cdebug(getName()&lt;&lt;&quot;::&quot;&lt;&lt;typeid(*this).name());
   mCacheTouched=true;
   regChange();
 }

Modified: antargis/branches/branch_2d/ruby/ant_energy.rb
===================================================================
--- antargis/branches/branch_2d/ruby/ant_energy.rb	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/ruby/ant_energy.rb	2007-05-09 18:34:55 UTC (rev 1093)
@@ -72,6 +72,7 @@
 	def set(n,v)
 		o=@values[n]
 		if ((o-v).abs&gt;0.1) or (o!=v and (v==0 or v==1))
+			puts &quot;queryRedraw in ant_energy&quot;
 			queryRedraw
 			@values[n]=v
 		end

Modified: antargis/branches/branch_2d/ruby/antargis.rb
===================================================================
--- antargis/branches/branch_2d/ruby/antargis.rb	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/ruby/antargis.rb	2007-05-09 18:34:55 UTC (rev 1093)
@@ -357,7 +357,7 @@
 		ent=nil
 		list.each{|node|
 			mesh=node.node
-			if [Mesh,AnimMesh].member?(mesh.class)
+			if [Mesh,AnimMesh,Mesh2D].member?(mesh.class)
 				ent=getMap.getEntity(mesh)
 				break if ent
 			end

Modified: antargis/branches/branch_2d/ruby/tests/impostor.rb
===================================================================
--- antargis/branches/branch_2d/ruby/tests/impostor.rb	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/ruby/tests/impostor.rb	2007-05-09 18:34:55 UTC (rev 1093)
@@ -19,8 +19,10 @@
 		puts &quot;#{k}(#{k.class}):#{v} #{v.class}&quot;
 		v.each{|x,y|
 			assert{!(k.is_a?(Hash)||x.is_a?(Hash))}
-			@@types&lt;&lt;[k,x[0]]
-			puts &quot;K:#{k}(#{k.class}) Y:#{x}(#{x.class})&quot;
+			x.each{|xi|
+				@@types&lt;&lt;[k,xi]
+				puts &quot;K:#{k}(#{k.class}) Y:#{x}(#{x.class})&quot;
+			}
 		}
 	}
 	puts @@types.inspect
@@ -29,11 +31,32 @@
 		super
 		$scene=getScene
 
+		hotpoints={}
+
+		#@@types=[[:man,&quot;stand&quot;]]
+
 		tex=nil
 		@@types.each{|t,t2|
 			puts &quot;TRY CREATE #{t}(#{t.class}) #{t2}(#{t2.class})&quot;
 			node=AntModels.createModel(t,t2)
 			puts &quot;#{t}:#{t2} failed creation&quot; if node.nil?
+			if node.is_a?(AnimMesh)
+				anims=node.getData.getAnimations
+				puts &quot;# anims:#{anims.length}&quot;
+				anims.collect!{|s|s.to_s+&quot;&quot;}
+				anim=anims[0]
+				if anims.member?(t2.to_s)
+					anim=t2
+# 				else
+# 					anims.each{|a|puts &quot;#{a}(#{a.class})&quot;}
+# 					puts &quot;t2:#{t2} (#{t2.class})&quot;
+# 					raise 1
+				end
+				puts &quot;anim:#{anim}&quot;
+				node.setAnimation(anim.to_s)
+				node.advance(0.1)
+				node.setRotation(30)
+			end
 			$scene.addNode(node)
 			imp=AntImpostorData.new(node,512,512)
 	
@@ -43,23 +66,33 @@
 				name+=&quot;_&quot;+(t2.to_s)	
 			end
 			name+=&quot;.png&quot;
-			imp.getSurface.save(name)
+			surface=imp.getSurface
+			p=surface.shrink2Fit
+	
+			hotpoints[name]=p
+			surface.save(name)
 			getScene.removeNode(node)
 		}
+
+		text=&quot;&quot;
+		hotpoints.each{|k,v|text+=k+&quot;:&quot;+(v.to_s)+&quot;\n&quot;}
+		saveFile(&quot;hotspots.txt&quot;,text)
 			
-		image=AGImage.new(nil,AGRect2.new(0,0,tex.width,tex.height),tex,false)
-		setMainWidget(image)
+# 		image=AGImage.new(nil,AGRect2.new(0,0,tex.width,tex.height),tex,false)
+# 		setMainWidget(image)
 		
-		getScene.removeNode(node)
+		#getScene.removeNode(node)
 	end
 
 	def eventFrame(t)
-		delay(100)
+# 		delay(100)
 	puts t
 		return true
 	end
 end
 
+#getMain.initVideo(512,512,32,false,true)
+
 app=MyApp.new(1024,768)
 
 app.run

Modified: antargis/branches/branch_2d/ruby/two_d_app.rb
===================================================================
--- antargis/branches/branch_2d/ruby/two_d_app.rb	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/ruby/two_d_app.rb	2007-05-09 18:34:55 UTC (rev 1093)
@@ -20,10 +20,17 @@
 	end
 
 	def draw
-		p=AGPainter.new
-		@scene.setPainter(p)
-		@scene.draw
-		@scene.discardPainter
+		@frame||=0
+		@frame+=1
+
+		if (@frame%2)==0
+			p=AGPainter.new
+			@scene.setPainter(p)
+			@scene.draw
+			@scene.discardPainter
+			p=nil
+			GC.start
+		end
 		super
 	end
 	def getScene
@@ -57,7 +64,7 @@
 			nodes=tryClick(e.getMousePosition)
 			nodes.each{|n|
         puts &quot;NODE: #{n}(#{n.class})&quot;
-        #puts &quot;NODE:&quot;+(getMap.getEntity(n).to_s)
+        puts &quot;NODE:&quot;+(getMap.getEntity(n.node).to_s)
 			}
 			eventClick(nodes,e.getButton)
 		end
@@ -95,7 +102,10 @@
 module AntModels
 	def AntModels.createModel(entityType,subType=nil,angle=nil)
 		trace
-		type=entityType
+		type=entityType.to_s
+		if subType.to_s!=&quot;&quot;
+			type+=&quot;_&quot;+subType.to_s
+		end
 		t=AGTexture.new(AGSurface.load(&quot;data/textures/2d/#{type}.png&quot;))
 		data=Mesh2DData.new(t)
 		mesh=Mesh2D.new(getMap.getScene,data,AGVector4.new(0,0,0,1),0)

Modified: antargis/branches/branch_2d/src/anim_mesh_data.cc
===================================================================
--- antargis/branches/branch_2d/src/anim_mesh_data.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/src/anim_mesh_data.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -325,3 +325,13 @@
 
 
 }
+
+std::vector&lt;std::string&gt; AnimMeshData::getAnimations() const
+{
+  std::vector&lt;std::string&gt; l;
+
+  for(std::map&lt;AGString,Animation&gt;::const_iterator i=mAnimations.begin();i!=mAnimations.end();i++)
+    l.push_back(i-&gt;first);
+
+  return l;
+}

Modified: antargis/branches/branch_2d/src/anim_mesh_data.h
===================================================================
--- antargis/branches/branch_2d/src/anim_mesh_data.h	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/src/anim_mesh_data.h	2007-05-09 18:34:55 UTC (rev 1093)
@@ -100,6 +100,8 @@
   const AGMatrix4 &amp;getTransform() const;
 
   friend class AnimMesh;
+
+  std::vector&lt;std::string&gt; getAnimations() const;
 };
 
 #endif

Modified: antargis/branches/branch_2d/src/impostor.cc
===================================================================
--- antargis/branches/branch_2d/src/impostor.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/src/impostor.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -52,12 +52,12 @@
   //  mTexture.endPaint();
 
   AGSurface s=getScreen().screenshot(false);
-  s.save(&quot;impostor.png&quot;);
+  //  s.save(&quot;impostor.png&quot;);
 
   mTexture.endPaint();
 
   AGSurface subs=s.getSubSurface(AGRect2(0,sh-h,w,h));
-  subs.save(&quot;impostor3.png&quot;);
+  //  subs.save(&quot;impostor3.png&quot;);
 
   mSurface=subs;
 

Modified: antargis/branches/branch_2d/src/interface.i
===================================================================
--- antargis/branches/branch_2d/src/interface.i	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/src/interface.i	2007-05-09 18:34:55 UTC (rev 1093)
@@ -1,6 +1,11 @@
 %module(directors=&quot;1&quot;) libantargis
 %feature(&quot;director&quot;);
 %include &quot;typemaps.i&quot;
+%include &quot;std_string.i&quot;
+%include &quot;AGString.i&quot;
+%include &quot;std_vector.i&quot;
+%include &quot;std_pair.i&quot;
+%include &quot;std_map.i&quot;
 
 %include &quot;nantmarker.hh&quot;
 /*
@@ -59,16 +64,10 @@
 
 
 
-
 %{
 #include &quot;scene.h&quot;
 #include &quot;antargisgui.h&quot;
 %}
-%include &quot;std_string.i&quot;
-%include &quot;AGString.i&quot;
-%include &quot;std_vector.i&quot;
-%include &quot;std_pair.i&quot;
-%include &quot;std_map.i&quot;
 
 %template(StringVector) std::vector&lt;std::string&gt;;
 %template(AGStringVector) std::vector&lt;AGString&gt;;

Modified: antargis/branches/branch_2d/src/mesh_sort.h
===================================================================
--- antargis/branches/branch_2d/src/mesh_sort.h	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/src/mesh_sort.h	2007-05-09 18:34:55 UTC (rev 1093)
@@ -1,6 +1,9 @@
 #ifndef MESH_SORT_H
 #define MESH_SORT_H
 
+#include &lt;ag_geometry.h&gt;
+#include &quot;scenenode.h&quot;
+
 /**
    The class is for sorting purpose only. It provides the operator() function, that's needed
    for the STL-sorting algorithms.
@@ -12,13 +15,7 @@
 public:
   SortDistance(AGVector3 c):cam(c){}
 
-  bool operator()(const SceneNode *n1,const SceneNode *n2)
-  {
-    AGVector3 m1=const_cast&lt;SceneNode*&gt;(n1)-&gt;bbox().base+const_cast&lt;SceneNode*&gt;(n1)-&gt;bbox().dir*0.5;
-    AGVector3 m2=const_cast&lt;SceneNode*&gt;(n2)-&gt;bbox().base+const_cast&lt;SceneNode*&gt;(n2)-&gt;bbox().dir*0.5;
-
-    return (m1-cam).length2()&lt;(m2-cam).length2();
-  }
+  bool operator()(const SceneNode *n1,const SceneNode *n2);
 };
 
 /**
@@ -29,11 +26,16 @@
 public:
   SortOrder(){}
 
-  bool operator()(const SceneNode *n1,const SceneNode *n2)
-  {
-    return n1-&gt;getOrder()&lt;n2-&gt;getOrder();
-  }
+  bool operator()(const SceneNode *n1,const SceneNode *n2);
 };
 
+class SortYCoord
+{
+ public:
+  SortYCoord(){}
+  
+  bool operator()(const SceneNode *n1,const SceneNode *n2);
+};
 
+
 #endif

Modified: antargis/branches/branch_2d/src/scene_2d.cc
===================================================================
--- antargis/branches/branch_2d/src/scene_2d.cc	2007-05-07 19:01:26 UTC (rev 1092)
+++ antargis/branches/branch_2d/src/scene_2d.cc	2007-05-09 18:34:55 UTC (rev 1093)
@@ -23,7 +23,7 @@
   std::copy(nodeList.begin(),nodeList.end(),std::back_inserter(ns));
 
 
-  sort(ns.begin(),ns.end(),SortOrder());
+  sort(ns.begin(),ns.end(),SortYCoord());
 
   //FIXME:sort!!
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000050.html">[Antargis-svn] r1092 - antargis/branches/new_hl_jobs/ruby/ai
</A></li>
	<LI>Next message: <A HREF="000052.html">[Antargis-svn] r1094 - antargis/branches/branch_2d/data/textures/2d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51">[ date ]</a>
              <a href="thread.html#51">[ thread ]</a>
              <a href="subject.html#51">[ subject ]</a>
              <a href="author.html#51">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/antargis-svn">More information about the Antargis-svn
mailing list</a><br>
</body></html>
